## 0. 文档说明

### 0.1 文档目的与读者

**文档目的**

本文件是《多租户配置化数据建模与报表平台》（以下简称“本平台”）的**产品需求文档（PRD）**，用于在产品、技术、设计、测试及运维之间建立统一的需求共识，指导 V1.0 的设计与实现。

本平台主要提供以下能力：

- 多租户架构：同一平台服务多个租户，数据逻辑隔离；
- 配置化建模：业务人员可通过 UI 配置数据表结构，而无需直接写 SQL；
- 任务流（ETL）：通过可视化 DAG 抽取 / 转换 / 写入数据；
- 数据集 & 看板：基于数据集配置图表/指标卡/表格，实现自助分析；
- 权限 & 审计：支持租户内角色体系、资源级权限、行/列权限及关键操作审计；
- LLM 辅助：利用本地 LLM 自动生成表/字段编码，降低命名成本、提升一致性。

**适用读者**

- **产品经理**：需求域和边界的定义、迭代规划参考；
- **后端研发**：数据模型、接口设计、权限体系、DSL 约束等；
- **前端研发**：界面结构、交互流程、错误提示规范等；
- **测试工程师**：测试用例设计、边界场景识别；
- **运维 / 平台管理员**：多租户管理、租户停用影响、监控与告警关注点；
- **业务方 / 实施顾问**：理解平台能力与限制，规划落地方案。

> 备注：本文档优先描述“产品视角下的行为与约束”，技术实现细节（如具体 SQL、框架代码结构）由技术设计文档补充。

---

### 0.2 术语约定（英文缩写说明）

为避免歧义，本文档中使用的关键术语和缩写约定如下：

#### 平台与租户相关

- **平台（Platform）**：指本系统整体（包括平台后台与各租户工作区）。
- **GlobalUser / 平台用户**：在整个平台范围内唯一的用户账号。
- **Tenant / 租户**：一个公司、部门或项目空间，是数据与配置隔离的单位。
- **TenantUser / 租户用户**：GlobalUser 与某个 Tenant 的关联关系，是“在该租户下的用户身份”。

#### 权限与资源

- **Role / 角色**：租户内部定义的权限集合，如“数据工程师”、“分析师”。
- **Resource / 资源**：可授权的实体，如表、任务流、看板。
- **ResourceTree / 资源树**：用于展示和管理资源层级结构的逻辑树，按 scope 分类：

  - `scope=TABLE`：表资源树；
  - `scope=FLOW`：任务流资源树；
  - `scope=BOARD`：看板资源树。

- **RolePermission / 角色资源权限**：某角色对某资源（或目录）的权限配置。
- **RowPermission / 行权限**：基于统一 DSL 定义的某角色在某表上的行级访问过滤规则。
- **ColumnPermission / 列权限**：某角色在某表各字段的列级权限（隐藏/只读/可写）。

#### 数据建模 & 流程

- **Table / 表**：租户内部的业务数据表，由建模模块创建和维护。
- **Field / 字段**：表中的列，具有编码、名称、类型等属性。
- **Relation / 关系**：表之间的逻辑关联（如订单表与用户表的一对多关系）。
- **Flow / 任务流**：ETL 工作流，由多个节点组成的有向无环图。
- **Node / 节点**：Flow 中的处理单元，如 Source / Transform / Sink。
- **Run / 运行实例**：某次 Flow 实际执行记录。
- **Schedule / 调度**：对 Flow 进行周期性执行的配置（Cron 等）。
- **Dataset / 数据集**：基于某张表（或视图）的可复用数据视图，带有基础过滤条件。
- **Board / 看板**：由多个 Widget 组成的数据可视化页面。
- **Widget / 组件**：看板上的最小可视化单元，如指标卡、图表、表格。

#### 技术相关（仅作产品层面说明）

- **API**：后端提供的 HTTP 接口。
- **DSL（Domain Specific Language）**：统一过滤条件 JSON 结构，描述查询条件。
- **LLM（Large Language Model）**：大语言模型，本期使用本地 `ollama` 实例。
- **ETL（Extract-Transform-Load）**：数据抽取、转换、写入流程。

文中如无特别说明：

- “用户”在租户前台语境下，通常指 TenantUser；
- “平台管理员”特指 Platform Admin 角色；
- “行权限”、“列权限”、“资源权限”的详细行为见后续章节。

---

### 0.3 版本历史与评审记录

> 实际项目中建议维护为可更新表格，这里给出 V1.0 初始版本示例。

| 版本号 | 日期       | 作者   | 变更内容                                  | 评审人              | 备注               |
| ------ | ---------- | ------ | ----------------------------------------- | ------------------- | ------------------ |
| 0.1    | 2025-12-10 | PM XXX | 初版：整理文档结构 & 产品概述、角色与概念 | Tech Lead / FE / BE | 仅覆盖章节 0–3     |
| 0.9    | TBD        | PM XXX | 补充 DSL、权限模型、各模块详细交互        | 同上                | 用于开发前最终评审 |
| 1.0    | TBD        | PM XXX | 根据评审意见修订后冻结，作为 V1.0 基线    | 全体干系人          | 对应上线版本       |

评审方式建议：

- 每个大章节（如“权限模型”、“任务流模块”）单独组织评审；
- 重大行为变更（如权限含义、软删除策略）需在版本记录中显式标记。

---

## 1. 产品概述（Overview）

### 1.1 背景 & 痛点

**业务背景**

在中大型企业中，业务数据来源复杂（广告投放平台、游戏日志、CRM、财务系统等），常见现状：

- 各业务线分别找数据开发写脚本、建临时表，无统一平台；
- 报表依赖数据开发 / BI 工程师，需求响应慢，业务自助分析能力弱；
- 权限粗放：要么全公司都能看，要么只能通过导出 Excel 人工分发；
- 多项目/多品牌同时运营时，不同项目数据逻辑不能很好隔离。

**现有痛点**

1. **建模成本高**

   - 业务字段多且变化快，每次变更都需要数据工程师介入。
   - 业务方很难从“字段/表结构”视角理解数据，只看得懂报表。

2. **ETL 开发门槛高**

   - 抽数逻辑散落在各种脚本、 Airflow 任务或数据工程师个人电脑中。
   - 缺乏可视化运维：失败重跑、监控、依赖排查都不直观。

3. **报表与权限管理混乱**

   - 报表使用 Excel / 各类 BI 工具散落各处，版本不统一。
   - 行/列级权限很难实现，往往通过“复制多份报表”硬编码权限。

4. **多租户 / 多项目场景下复用困难**

   - 同一套指标逻辑，需要在多个项目间复制；
   - 无法在一个统一平台下服务多个租户（集团、客户），部署成本高。

本平台希望通过**多租户 + 配置化建模 + 可视化任务流 + 看板**的组合模式，解决以上痛点。

---

### 1.2 产品定位 & 价值主张

**产品定位**

> 一款面向企业内部或 SaaS 场景的「多租户配置化数据建模与报表平台」，在统一平台上为多个组织/项目提供数据建模、ETL、权限控制和可视化看板能力。

可作为：

- 企业内部数据中台 / 营销数据平台的“上层工具”；
- SaaS 产品中，为不同客户提供可定制看板的“配置型分析平台”；
- 小团队/部门级的数据仓库 + 轻量 BI 一体化解决方案。

**价值主张（对不同角色）**

- **对业务方 / 分析师**

  - 通过 Dataset + Board 自助搭建看板，无需找开发；
  - 业务术语友好（字段显示名称、预设数据集）。

- **对数据工程师**

  - 用可视化 Flow 管理 ETL，不再散落脚本；
  - 多租户复用同一套 ETL 模板 & 表结构；
  - 精细权限 & 审计帮助控制风险。

- **对平台 / IT 管理者**

  - 单一平台服务多个租户，统一维护与监控；
  - 可通过 Plan 控制不同租户的功能与容量；
  - 租户停用与资源回收策略可控。

---

### 1.3 与竞品 / 现有方案的对比

对比对象主要包括：

1. 传统 BI 工具（如 Tableau / Power BI 等）；
2. 传统数仓 / 数据库（如 MySQL + 手写 SQL / 脚本）；
3. 自研脚本 + Airflow 等通用调度工具。

**1）与传统 BI 工具对比**

| 维度        | 传统 BI 工具                | 本平台                                       |
| ----------- | --------------------------- | -------------------------------------------- |
| 数据建模    | 依赖 IT，通常在数仓中完成   | 平台内提供配置化建模模块，可由数据工程师完成 |
| ETL 能力    | 通常弱（依赖外部 ETL 工具） | 内置可视化任务流，实现完整 ETL               |
| 多租户能力  | 一般为“单租户 + 多项目”     | 原生多租户，租户间逻辑隔离                   |
| 行/列级权限 | 依赖数据源或复杂配置        | 平台内统一行/列级权限 DSL                    |
| LLM 辅助    | 通常为报表层自然语言问答    | 重点用于建模命名/编码，提高模型一致性        |

**2）与传统数仓（数据库 + 脚本）对比**

| 维度       | 传统数仓脚本方案                     | 本平台                                         |
| ---------- | ------------------------------------ | ---------------------------------------------- |
| 建模方式   | DBA/工程师手写 DDL                   | Web UI 配置字段，自动生成物理表                |
| ETL 管理   | 脚本分散、缺乏拓扑视图               | Flow DAG 统一管理，Run 记录可视                |
| 运维难度   | 日志分析复杂，任务失败排查困难       | Run 详情、节点级日志，错误信息面向产品场景设计 |
| 权限模型   | 依赖数据库权限，粒度粗、难以对接前端 | 行/列/资源三级权限体系，前后端统一             |
| 多租户支持 | 需自行设计 schema 或数据库隔离       | 平台内置 tenant_id 体系及租户空间              |

**3）与 Airflow 等调度平台对比**

| 维度          | Airflow 等通用调度平台              | 本平台                                     |
| ------------- | ----------------------------------- | ------------------------------------------ |
| 定位          | 通用工作流调度                      | 面向数据建模 + 报表的场景化平台            |
| 任务定义方式  | Python DAG / 代码                   | Web UI 拖拽节点配置（HTTP/MySQL/内部表等） |
| 权限 & 多租户 | 需另行设计                          | 平台内置多租户 + 行/列/资源权限模型        |
| 使用门槛      | 需要工程师具备 Python & DevOps 能力 | 面向数据工程师 & 分析师，降低脚本依赖      |

---

### 1.4 目标用户 & Persona

**1）平台管理员（Platform Admin）**

- 背景：IT 运维 / 平台团队成员，熟悉基础设施与账号体系；
- 目标：

  - 创建/管理租户；
  - 管控平台级用户（GlobalUser）；
  - 监控租户健康状态（调度任务数量、失败情况等）；

- 典型行为：

  - 新建租户，为租户指定套餐 Plan；
  - 查看某租户成员列表，协助排查登陆问题；
  - 在租户欠费或违规时暂停该租户。

**2）租户 Owner**

- 背景：部门负责人 / 项目负责人，对业务整体负责；
- 目标：

  - 管理本租户成员与角色；
  - 决定谁可以建模、谁可以看报表；

- 典型行为：

  - 邀请新成员加入租户，分配角色（数据工程师/分析师/查看者）；
  - 调整某人权限（例如从“分析师”降为“只读观众”）；
  - 查看权限变更审计记录。

**3）租户数据工程师 / 建模者**

- 背景：熟悉数据库和 ETL，有一定脚本基础；
- 目标：

  - 建立并维护租户的核心数据模型（订单、用户、活动等）；
  - 配置 Flow，从多种数据源抽取数据到平台内表；

- 典型行为：

  - 在 Modeling 中创建订单表、用户表、充值表；
  - 配置从外部 MySQL 抽数的 Flow；
  - 调试 Flow，查看 Run 详情，定位失败节点；
  - 为表配置行/列权限规则。

**4）租户分析师（Analyst）**

- 背景：数据分析师 / 运营人员，会写简单 SQL 或主要使用 BI 工具；
- 目标：

  - 使用 Dataset & Board 进行自助分析；
  - 定期查看看板，辅助业务决策；

- 典型行为：

  - 基于订单表创建“收入分析”数据集；
  - 在看板上配置折线图、柱状图和指标卡；
  - 保存看板并分享给团队成员查看。

**5）租户普通查看者（Viewer）**

- 背景：业务人员、管理者，只需要“看结果”；
- 目标：

  - 及时查看关键指标、日报/周报看板；

- 典型行为：

  - 打开自己有权限的看板；
  - 导出图表数据或截图，用于会议。

---

### 1.5 使用典型场景（End-to-End 示例）

**场景 A：游戏项目的运营数据看板（完整链路：建模 → ETL → 看板）**

1. **建模**

   - 数据工程师在 Modeling 中创建：

     - `user` 用户表；
     - `order` 订单表（含 user_id、amount、pay_time 等）；

   - 使用 LLM 自动生成表/字段编码，规范命名。

2. **ETL（Flow）**

   - 新建 Flow「从日志库导入订单数据」：

     - Source：外部 MySQL（游戏日志库）执行 SELECT；
     - Transform：字段选择与重命名，计算字段（如真实金额、折扣）；
     - Sink：写入内部 `order` 表（TRUNCATE_INSERT，每晚全量覆盖）。

   - 配置调度：每日 3:00 运行一次。

3. **行/列权限**

   - 对 `order` 表配置：

     - 行权限：仅允许查看自己负责的区服数据（基于 server_id 过滤）；
     - 列权限：隐藏用户手机号等敏感字段。

4. **Dataset & Board**

   - 分析师新建数据集「订单收入数据集」，包含订单金额、日期、区服等；
   - 基于该数据集配置「收入总览看板」，包括：

     - 日收入趋势折线图；
     - 区服对比柱状图；
     - 总收入指标卡。

5. **日常使用**

   - 运营人员每天早上打开看板，查看昨日收入与目标差异；
   - 若数据异常，通过查看 Flow Run 确认 ETL 是否成功。

**场景 B：广告投放效果分析（多数据源 + 行权限）**

1. Modeling 中创建：`campaign`（广告计划）、`campaign_stats`（投放效果）表；
2. Flow 从多个广告平台的 HTTP API 抽取数据，统一写入 `campaign_stats`；
3. 行权限规则：

   - 广告投放团队成员只能看到自己负责的广告主数据（基于 `owner_id` 或 `department`）；

4. 分析师创建数据集「投放效果数据集」，配置看板：

   - 查看各广告主的消耗、转化率、ROI；
   - 对不同行业做分组分析。

**场景 C：SaaS 模式下的多租户报表服务**

1. 平台管理员为每个外部客户创建一个 Tenant；
2. 为每个 Tenant 配置 Owner，并让其自行管理成员；
3. 数据工程师在每个 Tenant 下复用类似的数据模型和 Flow；
4. 每个客户只能看到自己租户下的数据和看板，彼此隔离。

---

### 1.6 范围说明（本期 Scope / Out-of-Scope）

**V1.0 范围内（In Scope）**

- 多租户架构 & 平台后台

  - GlobalUser / Tenant / TenantUser 管理；
  - 租户停用后禁止访问、停止调度。

- 租户工作区基础框架

  - 租户选择与切换；
  - Modeling / Flows / Boards / Settings 四大模块导航。

- 建模模块（Modeling）

  - 表资源树（文件夹 + 表）；
  - 表结构管理（字段增删改，类型有限子集，不支持在线变更字段类型）；
  - 表数据的基础 CRUD（分页查询、过滤、编辑、删除）；
  - 关系（Relation）基础管理。

- 任务流模块（Flows）

  - Flow 资源树（文件夹 + Flow）；
  - DAG 画布，节点类型包括：

    - Source：HTTP / MySQL / 文件；
    - Transform：字段选择/重命名、过滤、聚合、Join、计算字段；
    - Sink：写入内部表 / 写入 HTTP API；

  - 调度（CRON / 手动触发）、Run 记录与详情。

- 数据集 & 看板模块（Datasets & Boards）

  - Dataset 的创建 / 编辑 / 删除，绑定单表；
  - Board 资源树（文件夹 + 看板）；
  - Widget 类型：指标卡 / 折线 / 柱状 / 饼图 / 表格；
  - Widget 查询配置（维度、指标、过滤、排序、分页）。

- 权限与 DSL（基础能力）

  - 统一过滤 JSON DSL 的语法定义；
  - 资源级权限（表结构 / 表数据 / Flow / Board）；
  - 行权限 / 列权限配置及在数据查询/展示时的应用。

- LLM 辅助（表/字段编码生成）

**V1.0 暂不支持（Out-of-Scope）**

- 字段类型在线变更（例如从 string → int 的自动迁移）；
- 跨租户的数据联邦查询；
- 数据血缘可视化（字段级 lineage）；
- 通知中心 / 消息中心（任务失败推送到 IM 等）；
- 多语言 UI 国际化（V1 默认为简体中文）。

上述 Out-of-Scope 功能在后续版本中可以规划，但**本期开发与测试不需覆盖**。

---

### 1.7 成功指标（业务指标 + 使用指标）

**业务层面指标（由业务团队评估）**

- 在目标时间内（如 6 个月）上线的租户数量：

  - 目标：≥ N 个内部项目租户 / M 个外部客户租户。

- 人力节省：

  - 数据报表相关需求中，≥ X% 可由业务方自助完成，无需研发介入。

**产品使用指标（平台可直接统计）**

- 日/周/月活跃租户数（有登录行为或运行 Flow / 打开看板）；
- 日/周/月活跃用户数（按 TenantUser）；
- 任务流运行情况：

  - 每日 Flow Run 成功率 ≥ 99%；
  - 单个 Flow 的平均运行耗时（用于优化 ETL 逻辑）。

- 看板使用情况：

  - 平均每个租户的看板数；
  - 看板打开次数（识别核心看板）。

**质量与稳定性指标**

- 关键操作错误率（“看板加载失败”、“Flow 配置错误”等）低于一定阈值；
- 权限相关 bug 严重程度高，需重点关注：

  - 不允许出现“未授权用户看到敏感数据”的情况；
  - 不允许出现“合法用户完全无法访问自己应有资源”的情况。

---

## 2. 系统角色与访问边界

### 2.1 顶层架构视角

系统从产品层面分为两个主要工作空间：

1. **平台后台（Platform Admin Console）**

   - 面向平台管理员；
   - 功能：

     - GlobalUser 管理；
     - Tenant 管理（创建、停用、查看计划）；
     - 平台级审计（可选、后续扩展）。

2. **租户工作区（Tenant Workspace）**

   - 面向租户 Owner、数据工程师、分析师、查看者等；
   - 每个租户拥有逻辑上独立的工作区：

     - 建模模块（Modeling）；
     - 任务流模块（Flows）；
     - 数据集 & 看板模块（Datasets & Boards）；
     - 租户设置模块（Tenant Settings：用户、角色、权限）。

**访问关系：**

- 平台管理员通过 Platform Admin Console 可查看所有 Tenant 基本信息，但**不直接访问租户业务数据**；
- 租户内用户只能访问自己有权限的租户工作区，无法看到其他租户；
- 同一 GlobalUser 可以加入多个 Tenant，在不同租户之间切换视角。

---

### 2.2 用户角色定义

> 下述角色为**系统内置角色**建议，具体权限映射将在后续“权限模型”章节详述。

#### 2.2.1 平台管理员（Platform Admin）

- 所在空间：平台后台；
- 职责：

  - 管理平台级用户（GlobalUser）；
  - 管理租户（创建、修改、停用）；
  - 查看租户基本运行情况（如 Flow 数量、失败率等汇总）。

- **不**直接参与租户内部建模、Flow、看板配置。

#### 2.2.2 租户 Owner

- 所在空间：租户工作区（某个 Tenant 内）；
- 特点：

  - 每个 Tenant 至少 1 个 Owner，可配置多个；

- 职责：

  - 租户用户管理（添加/移除成员、分配角色）；
  - 角色与权限配置（包括行/列权限）；
  - 对权限变更与数据泄露风险负责。

#### 2.2.3 租户数据工程师 / 建模者（Data Engineer）

- 职责：

  - 负责建模模块：创建/修改表与字段；
  - 负责 ETL 任务流的配置、调试与运维；
  - 参与行/列权限设计（与 Owner 协作）。

#### 2.2.4 租户分析师（Analyst）

- 职责：

  - 消费已有数据模型与 Dataset；
  - 创建/编辑看板与 Widget；
  - 不直接修改底层表结构与 Flow 配置。

#### 2.2.5 租户普通查看者（Viewer）

- 职责：

  - 查看自己有权限的看板 / 数据集结果；
  - 不创建/编辑任何模型或看板。

> 说明：实际实现中，这些角色会映射到具体的 Role 配置组合，是系统内置的若干 Role 记录，其权限不可删除但可由平台/产品调整默认策略。

---

### 2.3 角色与模块访问矩阵

下表为**默认内置角色**与各模块的访问能力（租户工作区）：

| 模块 / 能力                    | Owner           | Data Engineer       | Analyst      | Viewer       |
| ------------------------------ | --------------- | ------------------- | ------------ | ------------ |
| 租户设置：用户管理             | 管理（增删改）  | 无                  | 无           | 无           |
| 租户设置：角色管理             | 管理（增删改）  | 只读                | 无           | 无           |
| 租户设置：资源权限配置         | 管理（增删改）  | 建议只读            | 无           | 无           |
| 租户设置：行/列权限配置        | 管理（增删改）  | 建议可编辑/协作     | 无           | 无           |
| Modeling：表资源树             | 全部可见/可管理 | 可见/可管理有权限表 | 只读（可选） | 只读（可选） |
| Modeling：表结构（字段增删改） | 管理            | 管理                | 无           | 无           |
| Modeling：表数据 CRUD          | 管理            | 编辑/查看           | 视权限可查看 | 部分只读     |
| Modeling：关系管理             | 管理            | 管理                | 只读         | 无           |
| Flows：资源树 & 列表           | 管理            | 管理                | 只读         | 只读（可选） |
| Flows：配置 & 保存             | 管理            | 管理                | 无           | 无           |
| Flows：手动运行                | 管理            | 管理                | 只读查看 Run | 只读查看 Run |
| Flows：调度配置                | 管理            | 管理（可选）        | 无           | 无           |
| Datasets：管理                 | 管理            | 管理（可选）        | 管理         | 只读         |
| Boards：管理（创建/编辑/删除） | 管理            | 管理（可选）        | 管理         | 只读         |
| Boards：查看                   | 全部            | 全部                | 全部         | 仅授权看板   |

> 说明：
>
> - 上表描述的是**预置角色的默认权限范围**，真正的权限粒度由资源级权限/行权限/列权限决定；
> - 出于安全考虑：**行/列权限配置**的实际操作建议仅开放给 Owner 和少数 Data Engineer。

---

### 2.4 多租户隔离边界

为保证不同租户间数据安全与逻辑隔离，统一定义如下边界：

1. **数据隔离原则**

   - 所有与业务数据相关的表（包括 meta 表和实际数据表）必须包含 `tenant_id` 字段；
   - 所有后端查询/修改逻辑必须在 WHERE 条件中包含 `tenant_id = 当前租户`；
   - 不允许出现跨租户的 JOIN 查询或写入操作（即使在同一数据库实例中）。

2. **访问路径隔离**

   - 前端访问租户工作区时，URL 中包含 `:tenantId`（或等价标识）；
   - 后端根据用户当前租户上下文 + token 进行双重校验：

     - 用户是否属于该租户（TenantUser 存在且 ACTIVE）；
     - 租户是否处于 ACTIVE 状态。

3. **平台管理员访问限制**

   - 平台 Admin 在平台后台可查看租户的**元信息**（如名称、状态、Plan）；
   - 默认情况下，平台 Admin **不通过前台身份直接查看某租户业务数据**；
   - 如有特殊需求（如运维排查），需通过专门接口与审计记录实现。

4. **跨租户复用能力（仅配置级）**

   - V1.0 不支持“跨租户的数据共享”；
   - 允许在产品设计上保留“模板导出/导入”的概念，以便在后续版本支持：

     - 在一个租户中导出模型/Flow/Board 模板，在另一个租户中导入。

5. **租户停用行为**

   - 当 Tenant 状态变为 SUSPENDED：

     - 所有该租户下的 TenantUser 无法登录工作区；
     - 所有调度类型为 CRON 的 Flow 不再触发；
     - 已在运行中的 Flow 可以允许自然结束（不强杀），由运维策略决定；

   - 重新启用后，恢复以上能力。

---

## 3. 核心概念与全局规范

### 3.1 核心领域概念

> 本小节从“概念与关系”角度定义数据模型，字段级详细定义将在附录 15.1 中汇总。

#### 3.1.1 GlobalUser / 平台用户

- 平台级账号，一个 GlobalUser 可以加入多个租户；
- 主要字段（简要）：

  - `id`：主键（详见 3.2）；
  - `login_name`：登录账号，平台内唯一；
  - `display_name`：显示名称；
  - `email`：邮箱；
  - `status`：ACTIVE / DISABLED；
  - `created_at` / `updated_at`。

- 约束：

  - 禁用后无法登录任何租户；
  - `(login_name)` 全局唯一。

#### 3.1.2 Tenant / 租户

- 平台中的逻辑隔离单元（组织/公司/项目）；
- 主要字段：

  - `id`：主键；
  - `code`：租户编码（业务编码，唯一）；
  - `name`：租户名称；
  - `status`：ACTIVE / SUSPENDED；
  - `plan`：BASIC / PRO / ENTERPRISE；
  - `created_at` / `updated_at`。

- 关键行为：

  - SUSPENDED 时禁止所有租户用户访问前台，停止调度。

#### 3.1.3 TenantUser / 租户用户

- 描述 GlobalUser 在某个 Tenant 中的成员关系；
- 主要字段：

  - `id`；
  - `tenant_id`（FK → Tenant）；
  - `user_id`（FK → GlobalUser）；
  - `status`：ACTIVE / DISABLED（仅影响该租户）；
  - `is_owner`：是否该租户 Owner；
  - `last_login`；
  - `created_at` / `updated_at`。

- 约束：

  - `(tenant_id, user_id)` 唯一；
  - 每个租户至少有 1 个 `is_owner = true` 的 TenantUser。

#### 3.1.4 Role / 角色

- 作用范围：**租户内**；
- 主要字段：

  - `id`；
  - `tenant_id`；
  - `name`：角色名称，同一租户内唯一；
  - `description`：描述；
  - `is_system`：是否系统内置（不可删除，可限制部分字段不可修改）；
  - `created_at` / `updated_at`。

- 行为：

  - 租户 Owner 可创建/编辑/删除自定义角色；
  - 系统内置角色（如 Owner、DataEngineer、Analyst、Viewer）不可删除。

#### 3.1.5 TenantUserRole / 用户-角色关联

- 描述 TenantUser 与 Role 的多对多关系；
- 主要字段：

  - `tenant_user_id`；
  - `role_id`；

- 约束：

  - `(tenant_user_id, role_id)` 唯一；
  - 一名 TenantUser 可以有多个 Role。

> 最终权限计算会合并该用户所有角色上的权限配置，详见后续权限模型章节。

#### 3.1.6 ResourceTree / 资源树

- 用于表示表、任务流、看板三类资源的目录结构；

- 每类资源维护一棵独立的树，以 `scope` 区分：

  - `scope=TABLE`：表资源树；
  - `scope=FLOW`：任务流资源树；
  - `scope=BOARD`：看板资源树。

- 节点类型：

  - FOLDER：目录；
  - TABLE / FLOW / BOARD：具体资源。

- 核心字段（逻辑）：

  - `id`；
  - `tenant_id`；
  - `scope`：TABLE / FLOW / BOARD；
  - `type`：FOLDER / RESOURCE（如 TABLE 等）；
  - `resource_id`：当 type 为资源时，指向目标资源表的主键；
  - `parent_id`：父节点；
  - `display_name`：显示名称；
  - `sort_order`：排序。

> 说明：
>
> - 前端展示时，用户只看到自己有权限的资源节点及其父目录；
> - 对 FOLDER 节点配置的权限，会作为默认权限向下继承；
> - 目录禁止挂载在具体资源之下。

#### 3.1.7 权限相关实体

**1）RolePermission / 角色-资源权限**

- 描述某角色对某资源（或目录）的访问级别；
- 范围包括：

  - TABLE_SCHEMA：表结构；
  - TABLE_DATA：表数据；
  - FLOW：任务流；
  - BOARD：看板。

- 核心字段（逻辑）：

  - `id`；
  - `tenant_id`；
  - `role_id`；
  - `resource_type`：TABLE_SCHEMA / TABLE_DATA / FLOW / BOARD；
  - `resource_id`：可以是资源本身 ID，也可以是 FOLDER 节点 ID；
  - `permission`：NONE / VIEW / EDIT / MANAGE。

**2）ColumnPermission / 列权限**

- 描述某角色在某张表上的**列级访问控制**；
- 核心字段：

  - `id`；
  - `tenant_id`；
  - `role_id`；
  - `table_id`；
  - `column_code`；
  - `access_level`：HIDDEN / READONLY / READWRITE。

**3）RowPermission / 行权限**

- 描述某角色在某张表上的**行级过滤规则**；
- 核心字段：

  - `id`；
  - `tenant_id`；
  - `role_id`；
  - `table_id`；
  - `rule_name`；
  - `filter_json`：统一 JSON DSL；

- 执行时，多个规则通常通过 OR 合并（细节见权限章节）。

#### 3.1.8 Table / Field / Relation

本系统的数据建模以「表 / 字段」为核心，**关系（Relation）不单独作为物理实体存储**，而是从字段上的“关联配置”中自动推导。

---

**Table / 表**

- 含义：租户内部的业务数据表，用于存放订单、用户、投放记录等业务实体。
- 核心元信息字段（逻辑层）：

  - `id`：表主键（内部使用，类型可为 int/UUID）。
  - `tenant_id`：所属租户。
  - `code`：表编码（英文小写蛇形，LLM 辅助生成，租户内唯一）。
  - `display_name`：业务可读表名（如“订单表”、“广告计划表”）。
  - `type`：表类型（维度 / 事实 / 配置 / 其他）。
  - `description`：表说明。
  - `created_by` / `updated_by`：创建 / 最近更新人（TenantUser）。
  - `created_at` / `updated_at`：创建 / 最近更新时间。

- 与物理表的关系：
  - 每个 Table 对应底层的一张物理表，命名规则如：`t_{tenantId}_{tableCode}`（具体由技术方案确定）；
  - 物理表的字段结构与本节定义的 Field 保持同步。

---

**Field / 字段**

- 含义：某个 Table 的一列，用于存放该表的一个属性（如“订单金额”、“下单时间”、“用户 ID”）。
- Field 是我们最重要的元数据单位之一，**同时承载字段本身的属性和跨表关系信息**。

- 核心元信息字段（逻辑层）：

  - 基本属性：

    - `id`：字段主键。
    - `tenant_id`：所属租户。
    - `table_id`：所属表 ID。
    - `code`：字段编码（英文蛇形，小写，表内唯一）。
    - `display_name`：字段展示名称（如“订单金额”、“下单时间”）。
    - `ui_type`：字段的“数据类型（UI 层）”，枚举：
      - 文本 / 整数 / 小数 / 日期 / 日期时间 / 布尔 / 关联（REFERENCE）。
    - `is_primary_key`：是否主键字段（V1 仅支持单主键）。
    - `is_required`：是否必填（NOT NULL）。
    - `default_value`：默认值（仅对非“关联”字段生效）。
    - `is_internal`：是否系统字段（如 id / created_at 等）。
    - `description`：字段说明。
    - `created_at` / `updated_at`：创建 / 最近更新时间。

  - 关联属性（仅当 `ui_type = REFERENCE` 时有意义）：
    - `ref_table_id`：被关联的目标表 ID。
    - `ref_field_id`：用来“存储关联关系”的目标字段 ID（通常是目标表主键）。
    - `ref_display_field_id`：在 UI 中展示关联记录时使用的目标字段 ID（如目标表的“名称”字段）。
    - `ref_input_mode`：关联输入方式（下拉选择 / 搜索选择），用于数据录入交互。

- 底层存储类型：
  - 实际的数据库字段类型（例如 varchar/int/decimal 等）由系统根据 `ui_type` 和 `ref_field_id` 自动选择；
  - 对业务用户完全透明，不在产品层面对外暴露；
  - 约定：当 `ui_type = REFERENCE` 时，当前字段的底层类型与 `ref_field_id` 对应字段的底层类型保持一致。

---

**Relation / 关系（概念层，V1 不单独建表）**

- 含义：

  - 用于表示“两张表之间通过某个字段建立的业务关联”，例如：
    - 订单表里的“用户字段”指向“用户表”的某条记录；
    - 广告计划表里的“游戏 ID 字段”指向“游戏信息表”。

- V1 的设计原则：

  - **不为 Relation 单独建物理表**；
  - 所有关系信息都从字段上的“关联配置”（`ui_type = REFERENCE` + `ref_*` 字段）自动推导。
  - 可以理解为：
    - 每一个 `ui_type = REFERENCE` 的字段，就代表一条：
      > “从当前表（该字段所在表）指向 ref_table 的 MANY_TO_ONE 关系”。

- 关系的推导方式（提供给后续模块使用）：

  - 某表「指向谁」：
    - 查找所有 `table_id = 当前表` 且 `ui_type = REFERENCE` 的字段：
      - 每个字段代表一条“从当前表到 ref_table_id 的关系”。
  - 某表「被谁指向」：
    - 查找所有 `ref_table_id = 当前表` 的字段：
      - 每个字段代表一条“从其他表指向当前表的关系”。

- Relation 的主要用途（后续章节会用到）：

  - 在建模模块中，用于生成「关系视图 / ER 图」，帮助用户理解表之间的结构；
  - 在任务流 / 数据集 / 看板中，用于：
    - 智能推荐 Join 条件（例如：自动建议“订单表.user_id 与 用户表.id 关联”）；
    - 生成更友好的下拉选择 / 搜索选择（通过 `ref_display_field_id` 展示人类可读名称）。

- 未来扩展说明：
  - V1 仅支持“由单个字段表示的一对多 / 多对一关系”；
  - 若后续需要：
    - 多字段联合关系；
    - 不依赖具体字段的“纯逻辑关系”；  
      则可以在后续版本中引入独立的 Relation 实体和配置 UI，并与 Field 上的关联配置做向下兼容。

#### 3.1.9 Flow / Node / Run / Schedule

**Flow / 任务流**

- 描述一个 ETL 工作流；
- 核心字段：

  - `id`；
  - `tenant_id`；
  - `name`；
  - `description`；
  - `status`：ACTIVE / INACTIVE（逻辑状态，可选）；
  - `schedule_type`：MANUAL / CRON；
  - `cron_expr`：当类型为 CRON 时必填；
  - `config_json`：包含 DAG 拓扑和节点配置；
  - `created_by` / `updated_by`；
  - `created_at` / `updated_at`。

**Node / 节点**

- 作为 Flow 配置的一部分，一般以内嵌 JSON 表示：

  - `node_id`：节点唯一标识；
  - `type`：SOURCE / TRANSFORM / SINK；
  - `sub_type`：HTTP_SOURCE / MYSQL_SOURCE / FILE_SOURCE / FILTER / AGGREGATE / JOIN / CALC_FIELD / WRITE_TABLE / WRITE_HTTP 等；
  - `config`：各子类型的具体配置项（见任务流模块章节）。

**Run / 运行实例**

- 每次 Flow 执行对应一条 Run 记录；
- 核心字段：

  - `id`（Run ID）；
  - `flow_id`；
  - `tenant_id`；
  - `trigger_type`：MANUAL / SCHEDULED；
  - `status`：PENDING / RUNNING / SUCCESS / FAILED；
  - `started_at` / `finished_at`；
  - `error_message`（如失败）；
  - `node_stats_json`：节点级耗时、行数、错误信息等。

**Schedule / 调度**

- V1 可以通过 Flow 自带字段管理调度（不一定单独建表）；
- 统一要求：
  - 对于调度任务，必须记录最近一次触发时间和结果；
  - 租户停用时，不再触发调度任务。

#### 3.1.10 Dataset / Board / Widget

**Dataset / 数据集**

- 基于某个 Table（或视图）的可复用数据视图，封装了基础过滤条件；
- 核心字段：

  - `id`；
  - `tenant_id`；
  - `table_id`；
  - `name`；
  - `description`；
  - `base_filter_json`：统一 DSL；
  - `created_by` / `updated_by`；
  - `created_at` / `updated_at`。

**Board / 看板**

- 看板页面，由若干 Widget 组成；
- 核心字段：

  - `id`；
  - `tenant_id`；
  - `name`；
  - `description`；
  - `layout_json`：整体布局（可选）；
  - `created_by` / `updated_by`；
  - `created_at` / `updated_at`。

**Widget / 组件**

- 看板上的可视化组件；
- 核心字段：

  - `id`；
  - `board_id`；
  - `tenant_id`；
  - `type`：METRIC_CARD / CHART / TABLE 等；
  - `title` / `description`；
  - `dataset_id`；
  - `query_config`：指标、维度、过滤、排序、limit 等；
  - `viz_config`：图表样式配置；
  - `layout`：组件在看板中的位置与尺寸（x, y, w, h）；
  - `created_at` / `updated_at`。

---

### 3.2 全局 ID & 编码规范

#### 3.2.1 主键 ID 统一规范

1. **主键类型**

   - 所有核心业务表（GlobalUser、Tenant、TenantUser、Table、Field、Flow、Dataset、Board、Widget 等）的主键 `id` 统一采用：

     - 数据库层面：`BIGINT` 自增（或等价实现）；
     - 对前端/API：作为不透明整数 ID 使用，不对外承诺 ID 的任何含义和连续性。

2. **tenant_id 使用规范**

   - 所有租户内实体表（Table、Field、Flow、Dataset、Board、ResourceTree、Role、Permission 等）必须包含 `tenant_id`；
   - `(tenant_id, id)` 组合视为唯一标识该租户内的某条记录；
   - API 层禁止跨租户传入 ID 并访问其他租户数据。

3. **ID 对外暴露原则**

   - API 返回时，可以直接返回 `id` 的数值；
   - 若存在安全或隐私顾虑，可在后续版本考虑引入 opaque key（如加密/编码）。

#### 3.2.2 业务编码（code）规范

部分实体需要对外有**稳定的业务编码**，如：

- Tenant.code；
- Table.code；
- Field.code；
- 未来可能扩展的 Dataset.code、Board.code 等。

统一命名规范：

- 字符集：`[a-z0-9_]+`；
- 命名风格：小写蛇形（snake_case）；
- 长度：1–50 字符；
- 必须以字母开头（`[a-z]`）；
- 不允许使用系统保留字（如 `select`, `from`, `where` 等，具体保留字列表由技术实现约定）。

**唯一性约束**

- `Tenant.code`：平台全局唯一；
- `Table.code`：同一租户内唯一（`(tenant_id, table_code)` 唯一）；
- `Field.code`：同一表内唯一（`(table_id, field_code)` 唯一）。

**生成与维护方式**

- V1 中，表/字段编码由 LLM 辅助生成 + 本地兜底：

  - 输入：display_name（中文/业务名）；
  - 输出：一个符合上述规则的编码；
  - 后端负责清洗、去重和加后缀。

- 用户层面：

  - 前端通常将 `code` 字段设为只读，不支持手动编辑；
  - 如未来允许手动编辑，必须进行冲突检测和影响分析。

---

### 3.3 时间、时区与日期处理规范

#### 3.3.1 存储与传输原则

1. **时间存储**

   - 数据库中所有 `datetime` 字段统一存储为 **UTC 时间**；
   - 字段命名统一为 `*_at` 结尾，如 `created_at`, `updated_at`, `started_at`, `finished_at`。

2. **API 传输格式**

   - 前后端之间传递日期时间统一使用 ISO8601 字符串：

     - 例如：`"2025-12-10T08:30:00Z"`（UTC），或带偏移的形式；

   - 仅日期（无时间）字段统一使用 `"YYYY-MM-DD"` 字符串格式。

3. **前端显示时区**

- 每个 Tenant 可配置一个“默认时区”（V1 可默认固定为 Asia/Shanghai，如无特别需求）；
- 前端展示时将 UTC 转换为租户默认时区后再格式化显示，例如：

  - `YYYY-MM-DD HH:mm`；

- 用户在前端输入的日期时间（如筛选条件）按租户时区解释，再转换为 UTC 传给后端。

#### 3.3.2 DSL 中的日期时间

1. DSL 中的 `value` 字段，日期/时间字段使用：

- 日期：`"YYYY-MM-DD"`；
- 日期时间：`"YYYY-MM-DD HH:mm:ss"`，默认解释为租户时区，再由后端统一转换为 UTC。

2. 特殊变量：

- `CURRENT_DATE`：当前日期（租户时区）；
- `CURRENT_DATETIME`：当前时间（租户时区）；

后端将这些变量在执行前“展开”为具体 UTC 时间。

#### 3.3.3 审计与排序

- 所有有业务生命周期的实体必须包含 `created_at`、`updated_at` 字段；
- 列表默认按 `updated_at` 降序排序，除非业务有特殊要求。

---

### 3.4 软删除、状态字段统一约定

#### 3.4.1 状态字段（status）的通用规则

1. **适用实体**

- GlobalUser：`status = ACTIVE / DISABLED`；
- Tenant：`status = ACTIVE / SUSPENDED`；
- TenantUser：`status = ACTIVE / DISABLED`；
- Flow：可选 `status = ACTIVE / INACTIVE`（用于控制是否允许调度/运行）；
- 其他需要生命周期管理的实体，可根据需要增加 `status`。

2. **状态含义**

- ACTIVE：正常可用；
- DISABLED：账号/关系存在，但禁止登录或使用；
- SUSPENDED（租户）：租户暂时停用，不允许任何租户用户访问，也不触发调度。

3. **使用原则**

- 在能通过 `status` 表示“可用/不可用”的场景，优先使用 `status` 而非 `is_deleted`；
- 对用户、租户、成员关系等实体，不做物理删除，以便保留审计轨迹。

#### 3.4.2 软删除（is_deleted）策略

V1.0 中为简化实现：

- **绝大部分业务实体（如 Table、Field、Flow、Dataset、Board）采用“物理删除 + 依赖检查”的方式**：

  - 删除前进行依赖检查（是否被 Flow/Dataset/Board/Relation/权限引用）；
  - 若存在依赖则禁止删除并给出清晰提示；
  - 若无依赖则执行物理删除；

- 对于审计类记录（如操作日志、运行记录等），不使用软删除，而是按时间归档/清理。

后续如有需要：

- 可以在特定实体上引入 `is_deleted` 字段，实现“逻辑删除”，同时不在前端展示被软删除的记录；
- 一旦某实体启用 `is_deleted`，文档需要在对应章节明确说明删除行为是“软删除”，以防歧义。

---

### 3.5 错误码 & 错误提示统一规范

#### 3.5.1 API 响应结构约定

所有 API（包括前台/后台）统一采用如下响应结构：

```json
{
  "success": false,
  "code": "ERR_PERMISSION_DENIED",
  "message": "您没有权限执行此操作",
  "data": null,
  "trace_id": "optional-debug-id"
}
```

字段说明：

- `success`：布尔值，表示本次请求是否成功；
- `code`：错误码字符串，便于前后端 & 运维定位问题；
- `message`：面向用户的简要错误提示（可展示在 UI 中）；
- `data`：成功时返回数据，失败时通常为 null 或附带少量上下文信息；
- `trace_id`：可选，用于日志追踪。

#### 3.5.2 错误码命名规范

- 格式：`ERR_` + 模块 + 简要说明，例如：

  - `ERR_PERMISSION_DENIED`：无权限；
  - `ERR_TENANT_SUSPENDED`：租户已停用；
  - `ERR_TABLE_IN_USE`：表被其他资源引用，无法删除；
  - `ERR_INVALID_DSL`：DSL 不合法；
  - `ERR_FLOW_RUNNING_ALREADY`：Flow 正在运行，禁止再次触发。

- 模块前缀（建议）：

  - `USER_`：账号/用户相关；
  - `TENANT_`：租户相关；
  - `MODEL_`：建模相关（表/字段/关系）；
  - `FLOW_`：任务流相关；
  - `BOARD_`：看板/Widget 相关；
  - `PERM_`：权限相关；
  - `LLM_`：LLM 辅助相关。

#### 3.5.3 前端错误展示要求

- 对于**权限相关错误**（如 403 / `ERR_PERMISSION_DENIED`）：

  - UI 提示：

    - 文案示例：“您没有权限执行此操作，如需访问请联系租户管理员”；

  - 可选提供“查看权限说明”链接。

- 对于**输入校验错误**（如 `ERR_INVALID_DSL`, `ERR_INVALID_FIELD_TYPE`）：

  - 尽可能标明具体字段与错误原因：

    - 示例：“字段『订单金额』的默认值格式不正确，应为数字”；

- 对于**后端异常/未知错误**（如 500 系统错误）：

  - 对用户仅提示：

    - “系统开小差了，请稍后重试，如果多次失败请联系管理员”；

  - 具体异常信息仅记录在后台日志中，不直接暴露给用户。

- 对于**业务约束导致的错误**（如删除表存在依赖）：

  - 提示内容需包含关键依赖信息：

    - “该表被以下资源引用，无法删除：任务流『每日订单同步』、看板『收入看板』中的 Widget『订单趋势图』”。

## 4. 统一查询 DSL & 权限模型（横切关注）

本章定义整个系统中**统一使用**的过滤 DSL 以及资源级 / 行级 / 列级权限模型。
后续所有模块（建模、任务流、数据集&看板、设置）涉及到“筛选 / 查询 / 权限”时，都应引用本章约定，避免各自实现。

---

### 4.1 统一过滤 JSON DSL（FilterDSL）

#### 4.1.1 设计目标

统一的 FilterDSL 用于：

- 表数据页的高级筛选；
- RowPermission（行级权限）规则；
- Dataset 的基础过滤（base_filter）；
- Widget 的过滤条件（图表、指标卡、表格）；
- Flow 中的“过滤节点”。

目标：

1. **统一语义**：所有地方的“过滤条件”都转成同一套 JSON 结构；
2. **安全可控**：可受控映射为 SQL，避免用户拼接 SQL 注入风险；
3. **可视化编辑**：适合作为可视化条件配置器（Condition Builder）的底层结构；
4. **可拓展**：后续可以增加运算符，而不影响既有数据。

#### 4.1.2 结构定义（Group / Condition）

FilterDSL 由两类节点构成：

- 条件组（Group）：`{ op, conditions }`
- 简单条件（Condition）：`{ field, operator, value }`

顶层可以是一个 Group，也可以是一个单独的 Condition。

```jsonc
// 示例：金额 > 100 且 (状态 = SUCCESS 或 PARTIAL)
{
  "op": "and",
  "conditions": [
    { "field": "amount", "operator": ">", "value": 100 },
    {
      "op": "or",
      "conditions": [
        { "field": "status", "operator": "=", "value": "SUCCESS" },
        { "field": "status", "operator": "=", "value": "PARTIAL" }
      ]
    }
  ]
}
```

**条件组（Group）字段：**

| 字段       | 类型          | 说明                             |
| ---------- | ------------- | -------------------------------- |
| op         | string        | `"and"` / `"or"`                 |
| conditions | Array<Object> | 子条件列表（Group 或 Condition） |

**简单条件（Condition）字段：**

| 字段     | 类型   | 说明                                    |
| -------- | ------ | --------------------------------------- |
| field    | string | 字段编码（Field.code）                  |
| operator | string | 操作符                                  |
| value    | any    | 操作值（部分操作符可为空 / 省略，见下） |

#### 4.1.3 操作符列表 & 类型约束

**通用比较：**

- `=`, `!=`, `>`, `>=`, `<`, `<=`

**集合：**

- `in`, `not_in`

  - `value` 为数组类型

**范围：**

- `between`

  - `value` 为长度为 2 的数组 `[min, max]`

**文本：**

- `contains`, `not_contains`
- `starts_with`, `ends_with`

**空值判断：**

- `is_null`, `is_not_null`

  - 此时 `value` 一般省略或为 `null`（由实现统一）

**类型约束（产品统一要求）：**

- 数值型字段（int/float/decimal 等）允许：
  `= != > >= < <= in not_in between is_null is_not_null`
- 字符串字段允许：
  `= != in not_in contains not_contains starts_with ends_with is_null is_not_null`
- 日期 / 时间字段允许：
  `= != > >= < <= between in not_in is_null is_not_null`
  值统一为字符串：

  - date：`"YYYY-MM-DD"`
  - datetime：`"YYYY-MM-DD HH:mm:ss"`

- 布尔字段允许：
  `= != is_null is_not_null`

前端的条件编辑器需要根据字段类型自动过滤出合法的 operator，避免生成无法执行的 DSL。

#### 4.1.4 特殊变量（动态值注入）

FilterDSL 支持内置“变量值”，用于表达如“当前用户”、“今天”类条件，由后端解析：

内置变量：

- `CURRENT_USER_ID`：当前 TenantUser.id；
- `CURRENT_TENANT_ID`：当前租户 id（多数情况下隐含在上下文）；
- `CURRENT_DATE`：当前日期；
- `CURRENT_DATETIME`：当前时间。

统一格式：

```json
{
  "field": "owner_id",
  "operator": "=",
  "value": { "__var__": "CURRENT_USER_ID" }
}
```

产品约束：

- 所有变量统一使用 `{"__var__": "<NAME>"}` 的形式；
- 前端只能从变量枚举列表中选择，不允许自由填写变量名。

#### 4.1.5 DSL → SQL 映射约束

确保安全与一致性：

1. **仅支持 AND / OR 逻辑**

   - 不支持 NOT；
   - 不在 DSL 中支持 SQL 函数或子查询。

2. **禁止 SQL 直写**

   - FilterDSL 不提供任何“直接输入 SQL 条件”的字段。

3. **字段受限**

   - `field` 必须是当前查询上下文的 Field.code；
   - 不允许使用表别名/点号等跨表写法（跨表由系统自动拼接，不由用户控制）。

4. **运算符白名单**

   - 仅允许 4.1.3 列出的 operator。

5. **映射失败统一处理**

   - 字段不存在 / 类型不匹配 / 结构非法 → 视为配置错误；
   - 接口返回 4xx，前端提示错误原因，不做“默认放宽”或 silent ignore。

#### 4.1.6 版本与兼容性

- 当前版本可视为 V1，未来可增加 `operator` 或结构字段；
- 产品约束：不得改变既有字段的语义（例如 `op`、`conditions` 等）；
- 如需在未来支持多版本 DSL，可在顶层增加 `version` 字段，当前版本可省略。

---

### 4.2 行级权限模型（RowPermission）

#### 4.2.1 目标和范围

RowPermission 用于控制：

> 同一张表中，不同角色能够访问**哪些行**的数据。

典型场景：

- 销售只看自己负责的客户；
- 某部门成员只看本部门数据；
- 管理员可以看全量数据。

行级权限基于 FilterDSL 实现，并且与业务过滤、Dataset 过滤叠加。

#### 4.2.2 角色内规则合并（OR）

对某个（role, table）：

- 允许配置 0~N 条行权限规则（RowPermission 记录）；
- 每条规则是一个 FilterDSL；
- 对该角色而言，所有规则以 **OR** 方式合并：

> `row_filter(role, table) = rule1 OR rule2 OR ...`

如果某个角色在该表上**没有任何 RowPermission 规则**：

- 视为该角色在该表上**不施加额外行级限制**（即“看到该表的全部行”，前提是资源级 TABLE_DATA 允许）。

#### 4.2.3 多角色合并（再 OR）

一个 TenantUser 通常拥有多个角色。

对某张表 t，这些角色对应的 RowPermission 都会参与合并：

> `final_row_filter(user, t) = OR_over_roles(row_filter(role_i, t))`

直观理解：

- 用户拥有的角色越多，可访问的行“有可能更多”，不会被其它角色“收窄”；
- 行级权限是“放开的合集”而不是“最小交集”。

#### 4.2.4 与业务过滤叠加顺序

对于任意一张表的查询（表数据页、Flow 节点查询、Dataset/Widget 查询）统一约定：

1. 应用 Dataset.base_filter（若存在）；
2. 应用 Widget / Flow 节点设置的业务过滤条件；
3. 应用 RowPermission 行级权限过滤。

这三部分之间按 **AND** 组合：

> `总 WHERE 条件 = base_filter AND business_filter AND row_permission_filter`

产品约束：

- 任何业务配置过滤，都不能绕过行级权限；
- 行级权限不会减弱业务过滤（不会扩大结果集，只会收紧）。

#### 4.2.5 MANAGE 权限与行级权限

对于某表：

- 若用户在该表的 `TABLE_DATA` 上，有任一角色获得 `MANAGE` 权限；
- 本期默认策略：**该用户在该表上不受行级权限限制**（即行级权限绕过）。

这个策略是全局统一的，主要用于：

- 管理员调试；
- 权限配置错误时拥有兜底人。

后续如需要“管理员也受行级限制”，可以增加租户级配置开关，但不在本期范围内。

---

### 4.3 列级权限模型（ColumnPermission）

#### 4.3.1 目标和范围

ColumnPermission 控制：

> 在同一张表中，不同角色对不同字段的**可见 / 可写**权限。

典型需求：

- 对普通用户隐藏敏感字段（如身份证号、成本价）；
- 允许部分角色查看但禁止修改某些字段（如审核状态）。

#### 4.3.2 权限级别定义

针对（role, table, column）：

- `HIDDEN`：字段不可见

  - 查询结果中不返回该字段；
  - 表数据页不显示该列；
  - Widget 字段选择器不列出该字段（若可能）。

- `READONLY`：字段可见，但不可编辑

  - 查询结果中返回该字段；
  - 表数据页显示该列，但编辑/新增时字段为只读；
  - API 不接受该字段的修改。

- `READWRITE`：字段可见且可编辑

  - 完整读写权限。

#### 4.3.3 多角色合并规则

对于用户 U 在表 T 的字段 F：

1. 收集 U 所有角色在该字段上的列权限；
2. 若所有角色权限都是 `HIDDEN` → 最终为 `HIDDEN`；
3. 否则：

   - 若有任一角色为 `READWRITE` → 最终为 `READWRITE`；
   - 否则若有任一角色为 `READONLY` → 最终为 `READONLY`。

**注意：**

- 最终列权限仍受资源级 TABLE_DATA 权限控制：

  - 若用户对表 T 的 TABLE_DATA < EDIT，则即使最终列权限是 READWRITE，也不允许修改数据。

#### 4.3.4 前端与接口行为

- 对 HIDDEN 字段：

  - 查询接口不返回该字段；
  - 表数据页、Widget 字段选择器中不展示；
  - 若历史配置中某 Widget 已引用该字段，而当前用户对该字段为 HIDDEN：

    - 查询该 Widget 时，后端可直接返回字段权限错误，前端提示“当前无权使用字段 X”。

- 对 READONLY 字段：

  - 查询接口正常返回；
  - 新建/编辑表单中以禁用状态展示；
  - 前端不允许修改；若前端传入了值，后端应忽略或报错（由实现统一决定）。

- 对 READWRITE 字段：

  - 正常读写。

---

### 4.4 资源级权限模型（RolePermission）

#### 4.4.1 资源类型（resource_type）

本期资源级权限覆盖以下类型：

- `TABLE_SCHEMA`：表结构（建模能力：新增字段、修改字段等）；
- `TABLE_DATA`：表数据（增删改查记录）；
- `FLOW`：任务流；
- `BOARD`：看板。

  > Dataset 可以作为 Board 的子资源处理，是否单独抽象为资源类型可由实现决定。

#### 4.4.2 权限等级（permission）

统一权限等级：

- `NONE`：无权限；
- `VIEW`：仅查看；
- `EDIT`：修改内容，但不包含删除 / 配置权限；
- `MANAGE`：管理权限，包括删除资源、移动资源、配置权限等。

不同模块对 EDIT / MANAGE 的具体按钮控制会在对应章节详细说明。

#### 4.4.3 资源树与 Folder 默认权限

系统通过 ResourceTree 组织资源（表、Flow、Board），包含 Folder 节点和资源节点：

- Folder 节点上可以配置“默认权限”；
- 对于该 Folder 下**未单独配置权限**的子资源节点（表 / Flow / Board），使用最近祖先 Folder 的默认权限；
- 一旦在资源节点上显式配置了权限，则以该资源节点配置为准，覆盖 Folder 默认值。

合并顺序（单角色内部）：

1. 从资源节点向上回溯到根 Folder，收集所有权限设置；
2. 取其中**最大权限等级**作为该角色对该资源最终的资源级权限。

#### 4.4.4 多角色合并（Effective Resource Permission）

对于某个用户 U 和某个资源 R（resource_type + resource_id）：

1. 对 U 的每个角色 role_i：

   - 计算该角色在资源 R 上的“单角色权限”（按照 4.4.3）；

2. 所有角色的权限再次取最大值：

> `permission(U, R) = max(permission(role1, R), permission(role2, R), ...)`
> 等级顺序：`NONE < VIEW < EDIT < MANAGE`。

---

### 4.5 权限校验原则

#### 4.5.1 后端强校验为准

- **所有**需要权限控制的接口都必须在后端进行强制校验：

  - 资源级：RolePermission；
  - 行级：RowPermission；
  - 列级：ColumnPermission。

- 前端权限仅用于改善体验（隐藏按钮、禁用操作），不能作为安全边界。

#### 4.5.2 错误码与提示

- 未登录或 Token 失效 → 返回 `401 Unauthorized`；
- 已登录但权限不足 → 返回 `403 Forbidden`。

前端统一提示示例（可 i18n）：

> “您没有权限执行该操作，如有需要请联系租户管理员。”

#### 4.5.3 审计与追踪

- 涉及权限变更的操作（角色创建/删除、角色权限变更、行/列权限变更、用户角色调整等）必须产生日志记录；
- 日志格式与查询方式在第 12 章统一说明；
- 本期至少保证**后端有可追溯的变更记录**，前端查看页面可以逐步增强。

---

## 5. 平台后台（Platform Admin Console）

本章描述平台级后台，服务对象为 **Platform Admin**，主要能力包括：

- 平台用户（GlobalUser）管理；
- 租户（Tenant）管理；
- 租户成员管理（TenantUser）；
- （后续）平台级审计日志与监控。

本期默认约定：

- GlobalUser 上有字段 `is_platform_admin: bool`；
- 仅 `is_platform_admin = true` 的用户可以访问 `/admin/*` 路径的页面与接口。

---

### 5.1 导航结构 & 访问控制

#### 5.1.1 导航结构

平台后台主导航（示例）：

- 用户管理（Global Users） `/admin/users`
- 租户管理（Tenants） `/admin/tenants`
- （可选）平台审计日志（后续版本）

每个导航项下再有相应列表 / 详情页。

#### 5.1.2 访问控制规则

- 登录后，前端通过 `/api/me` 等接口获取当前用户信息，其中包含 `is_platform_admin`；
- 若 `is_platform_admin = true`：

  - 显示“平台后台”入口；
  - 允许访问 `/admin/*` 路由；

- 否则：

  - 不显示平台后台菜单；
  - 用户直接访问 `/admin/*` 时，后端返回 403。

后端统一中间件规则：

- 所有 `/admin/*` 接口必须校验：

  - 未登录 → 401；
  - 已登录但 `is_platform_admin != true` → 403。

---

### 5.2 GlobalUser 管理

#### 5.2.1 GlobalUser 列表页

- 路径：`/admin/users`
- 粒度：每行一个 GlobalUser。

显示字段：

| 列名           | 说明                               |
| -------------- | ---------------------------------- |
| 登录名         | login_name                         |
| 显示名         | display_name                       |
| 邮箱           | email                              |
| 是否平台管理员 | is_platform_admin（是/否）         |
| 状态           | ACTIVE / DISABLED                  |
| 创建时间       | created_at                         |
| 更新时间       | updated_at                         |
| 操作           | 编辑 / 启用/禁用 /（可选重置密码） |

筛选与搜索：

- 搜索条件：

  - 输入框：按登录名 / 显示名 / 邮箱模糊查询；

- 筛选条件：

  - 状态：全部 / ACTIVE / DISABLED；
  - 是否平台管理员：全部 / 是 / 否。

禁用行为：

- 禁用 GlobalUser → 用户无法再登录系统，也无法访问任何租户；
- 不自动删除已有的 TenantUser 关系。

#### 5.2.2 创建 / 编辑 GlobalUser

创建 GlobalUser 表单字段：

- 登录名（必填、平台全局唯一）；
- 显示名（必填）；
- 邮箱（必填，格式校验）；
- 是否平台管理员（布尔开关）；
- 初始密码（是否自动生成由实际安全策略决定）。

编辑 GlobalUser：

- 登录名不可修改；
- 显示名、邮箱、是否平台管理员、状态可修改。

在产品层面，是否允许通过 UI 创建/编辑 `is_platform_admin` 可配置：

- 若担心误操作，可只允许运维通过脚本修改；
- 或在 UI 中加二次确认（“将该用户设为平台管理员将赋予其最高权限，确认操作吗？”）。

---

### 5.3 租户管理（Tenant）

#### 5.3.1 租户列表页

- 路径：`/admin/tenants`
- 粒度：每行一个 Tenant。

显示字段：

| 列名     | 说明                             |
| -------- | -------------------------------- |
| 租户编码 | code（唯一）                     |
| 租户名称 | name                             |
| 状态     | ACTIVE / SUSPENDED               |
| 套餐     | BASIC / PRO / ENTERPRISE         |
| 创建时间 | created_at                       |
| 更新时间 | updated_at                       |
| 操作     | 编辑 / 启用/停用 / 查看成员/详情 |

功能：

- 按编码 / 名称模糊搜索；
- 按状态 / 套餐筛选。

#### 5.3.2 新建 / 编辑租户

新建 Tenant 表单字段：

- 租户编码（code，必填、唯一）；
- 租户名称（name，必填）；
- 套餐（plan：BASIC/PRO/ENTERPRISE，必填）；
- 状态（默认 ACTIVE）。

编辑 Tenant：

- 租户编码不可修改；
- 可修改租户名称、套餐、状态。

状态含义：

- `ACTIVE`：

  - 租户用户可正常访问租户工作区；
  - 该租户下的任务流调度正常运行。

- `SUSPENDED`：

  - 所有 TenantUser 无法访问该租户（接口返回 403）；
  - 所有 Flow 调度停止触发新的 Run。

停用租户时弹窗提示：

> “停用后，该租户下所有用户将无法登录工作区，所有定时任务将暂停执行。确认要停用吗？”

启用租户时提示：

> “启用后，该租户下用户可再次访问工作区，定时任务可重新生效。”

---

### 5.4 租户成员管理（TenantUser）（平台视角）

平台管理员可从租户详情页进入成员管理视图：

- 路径：`/admin/tenants/:tenantId/users`

#### 5.4.1 成员列表

显示字段：

| 列名       | 说明                             |
| ---------- | -------------------------------- |
| 登录名     | GlobalUser.login_name            |
| 显示名     | GlobalUser.display_name          |
| 邮箱       | GlobalUser.email                 |
| 状态       | ACTIVE / DISABLED（租户内状态）  |
| 是否 Owner | is_owner                         |
| 角色列表   | 该租户下绑定的角色名（逗号分隔） |
| 创建时间   | created_at                       |
| 更新时间   | updated_at                       |

操作：

- 添加成员（从 GlobalUser 搜索添加）；
- 修改成员状态（ACTIVE / DISABLED）；
- 设置/取消 Owner；
- 移除成员（删除 TenantUser 记录）。

约束：

- `(tenant_id, user_id)` 唯一；
- 至少有一个 Owner：

  - 若某操作会导致租户不再有 Owner，应阻止并提示。

#### 5.4.2 添加成员流程

- 点击“添加成员”；
- 在弹窗中：

  - 搜索 GlobalUser（按登录名 / 邮箱 / 显示名）；
  - 勾选一个或多个用户；
  - 可选择是否设为 Owner；
  - 可选择初始角色（可选）。

- 点击“确认”后批量创建 TenantUser。

> 本期不在平台后台提供“注册新用户”的流程，仅能从已有 GlobalUser 中添加成员。

---

### 5.5 平台级审计日志（后续版本）

本期可以只在后端记录，不提供 UI 页面。方向如下：

- 记录的操作包括：

  - GlobalUser 创建 / 编辑 / 启用 / 禁用；
  - Tenant 创建 / 编辑 / 启用 / 停用；
  - 租户成员添加 / 移除 / Owner 变更；

- 日志字段：

  - 操作人（GlobalUser）；
  - 操作时间；
  - 操作类型；
  - 操作对象（Tenant / GlobalUser / TenantUser 等）；
  - 变更摘要；
  - 操作结果（成功/失败及原因）。

后续可在 `/admin/audit` 提供查询界面。

---

## 6. 租户通用体验（Tenant Workspace Shell）

本章定义租户工作区的“外壳”体验，包括租户切换、导航结构、空状态和任务通知等。本期**不做全局搜索**，**不做系统级通知**，**不提供语言切换**。

---

### 6.1 租户选择与切换

#### 6.1.1 首次进入逻辑

用户登录后：

- 若仅属于一个租户：

  - 直接进入该租户工作区（例如 Modeling 模块的默认页）；

- 若属于多个租户：

  - 可在首次登录时弹出租户选择页，或在顶部提供明显的租户下拉供选择；
  - 选择后进入对应租户工作区。

系统需记住**最近一次进入的租户**，下次登录时可直接跳转到该租户。

#### 6.1.2 顶部租户切换控件

- 顶部导航左侧区域显示当前租户名称；
- 点击后下拉展示：

  - 当前用户可访问的所有租户（状态为 ACTIVE）；
  - 支持按租户名称搜索。

- 切换后：

  - URL 中的 `tenantId` 更新；
  - 跳转到该租户的工作区首页（例如 Modeling 列表页或统一欢迎页）。

#### 6.1.3 访问被停用租户时

- 当用户尝试进入 `SUSPENDED` 状态的租户：

  - 后端返回 403；
  - 前端展示“租户已停用”提示页，例如：

    > “该租户已被停用，如需恢复访问，请联系平台管理员或本租户的 Owner。”

  - 不展示具体业务菜单。

---

### 6.2 导航布局（模块框架）

#### 6.2.1 顶部导航

顶部导航包含：

- 左侧：

  - 当前租户名称（下拉切换入口）；

- 中间（可选）：

  - 产品 Logo / 名称；

- 右侧：

  - 通知图标（任务流相关通知）；
  - 用户菜单：

    - 显示当前 GlobalUser.display_name；
    - 包含“退出登录”等操作（个人信息页可后续设计）。

#### 6.2.2 侧边导航

租户工作区侧边菜单包含：

- 建模（Modeling）
- 任务流（Flows）
- 数据集 & 看板（Boards）
- 设置（Settings）

要求：

- 当前模块高亮；
- 支持折叠展开；
- 模块入口的展示与否可以根据用户是否拥有该模块下**任一资源的 VIEW 权限**来决定：

  - 若完全无权限，前端可以隐藏入口，或保留入口但点击后显示“暂无可访问资源 / 无权限”页。

---

### 6.3 首次使用 / 无数据状态（Empty States）

各模块在完全无数据时，需要给出清晰引导。

#### 6.3.1 建模模块（无表时）

- 显示说明文本，例如：

  > “还没有任何数据表，您可以创建第一张表来开始建模。”

- 若当前用户具备任一目录下 `TABLE_SCHEMA` 的创建权限：

  - 显示“新建表”主按钮；

- 可选：提供“查看建模指南”或“示例文档”的链接。

#### 6.3.2 任务流模块（无 Flow 时）

- 显示说明文本，例如：

  > “暂时还没有任务流。您可以创建一个任务流，从外部数据源抽取数据并写入表中。”

- 若用户有 Flow 创建权限：

  - 显示“新建任务流”按钮；

- 可在空状态中用 1–2 行文字说明典型使用方式（如：“从外部 MySQL 抽数据 → 清洗 → 写入订单表”）。

#### 6.3.3 看板模块（无 Board 时）

- 显示说明文本，例如：

  > “还没有任何看板。您可以创建一个看板，将关键指标和图表集中展示。”

- 若用户具有 Board 创建权限：

  - 显示“新建看板”按钮；

- 提示：

  > “建议先为常用业务表创建数据集（Dataset），再基于数据集添加图表和指标卡。”

#### 6.3.4 Settings 模块（无成员 / 无角色时）

- 用户管理页只有当前用户一人时：

  - 文案示例：

    > “当前租户只有您一位成员。您可以添加其他同事加入，共享数据模型和报表。”

  - 按钮：“添加成员”（前提是用户有 Settings 管理权限）。

- 角色管理页无自定义角色时：

  - 文案示例：

    > “尚未创建任何自定义角色。建议根据团队职责创建角色并配置权限，避免所有人使用同一角色。”

---

### 6.4 全局搜索（本期不做）

- 本期不提供跨模块的全局搜索功能；
- 各模块通过自己的列表页搜索/筛选满足需求（例如：

  - 表列表的名称搜索；
  - Flow 列表名称/状态筛选；
  - Board 列表名称搜索等）。

如未来需要全局搜索，会在后续版本单独设计。

---

### 6.5 全局通知（仅任务流相关）

本期通知仅用于提醒**任务流运行结果**，不做系统级通知。

#### 6.5.1 通知类型范围

- 手动触发的 Flow Run 完成（成功/失败）；
- 调度触发的 Flow Run 失败。

成功调度运行一般不必通知，避免打扰。

#### 6.5.2 通知入口与交互

- 顶部右侧使用“铃铛”图标作为通知入口；

  - 当存在未读通知时显示红点或数量。

- 点击图标展开最近 N 条通知：

  - 每条通知至少包含：

    - 任务流名称；
    - 运行状态（成功/失败）；
    - 完成时间；
    - 触发方式（手动/调度）。

  - 点击通知后跳转到对应的 Flow Run 详情页（只读）。

通知状态：

- 新产生的通知标记为“未读”；
- 用户点击查看详情后自动标记为“已读”；
- 可提供“全部标记为已读”按钮（可选）。

---

### 6.6 国际化 & 语言切换（本期不做）

- 本期界面语言统一使用中文（简体）；
- 不提供语言切换入口；
- 实现时建议仍将文案抽离为配置文件，便于未来增加英文等多语言版本；
- 时间/日期/数字格式本期可以采用统一格式（如 `YYYY-MM-DD HH:mm:ss`）。

---

## 7. 租户设置模块（Tenant Settings & 权限管理）

Settings 模块是租户内部的管理中心，目标：

- 管理租户成员与角色；
- 配置资源级权限（表/任务流/看板）；
- 配置数据级权限（行/列权限）；
- 为后续权限变更审计打基础。

本期假设：只有具有特定 Settings 管理权限的角色（通常包含租户 Owner）可以访问本模块。

---

### 7.1 租户用户管理（Settings → Users）

#### 7.1.1 用户列表页

- 路径：`/app/:tenantId/settings/users`
- 粒度：每行一个 TenantUser。

显示字段：

| 列名         | 说明                                   |
| ------------ | -------------------------------------- |
| 登录名       | GlobalUser.login_name                  |
| 显示名       | GlobalUser.display_name                |
| 邮箱         | GlobalUser.email                       |
| 状态         | ACTIVE / DISABLED（仅指本租户状态）    |
| 是否 Owner   | is_owner                               |
| 角色列表     | 当前租户内绑定的角色名列表（逗号分隔） |
| 最近登录时间 | last_login                             |
| 创建时间     | created_at                             |

操作：

- 添加成员（从已有 GlobalUser 中选择）；
- 编辑成员角色；
- 启用 / 禁用成员（仅影响本租户）；
- 设置 / 取消 Owner。

权限：

- 仅具有 Settings 管理权限的角色可访问此页并执行操作。

#### 7.1.2 添加成员（本期仅支持“从已有用户中添加”）

本期不支持“邀请新用户注册”，即：

- 不发送邀请邮件；
- 不提供自助注册流程。

添加成员流程：

1. 点击“添加成员”；
2. 弹出对话框：

   - 搜索已有 GlobalUser（按登录名 / 邮箱 / 显示名）；
   - 选择一个或多个用户；
   - 可勾选“设为 Owner”；
   - 可为其分配初始角色（多选）。

3. 点击保存后：

   - 为每个选中用户创建 TenantUser 记录，状态默认为 ACTIVE。

约束：

- `(tenant_id, user_id)` 唯一；
- 若操作会导致该租户不再有任何 Owner，应禁止并提示。

#### 7.1.3 编辑成员角色与状态

- 编辑角色：

  - 在列表中点击“编辑角色”，弹出角色多选；
  - 选中后保存，覆盖该成员在本租户的角色列表。

- 启用/禁用成员：

  - 切换 TenantUser.status；
  - 禁用后，该成员无法访问该租户工作区，但不影响其在其他租户的访问。

---

### 7.2 角色管理（Settings → Roles）

#### 7.2.1 角色列表页

- 路径：`/app/:tenantId/settings/roles`

显示字段：

| 列名           | 说明                                            |
| -------------- | ----------------------------------------------- |
| 角色名称       | name                                            |
| 描述           | description                                     |
| 是否系统初始化 | is_system（系统初始化角色的标识，仅作来源说明） |
| 成员数         | 当前绑定该角色的用户数量                        |
| 创建时间       | created_at                                      |
| 更新时间       | updated_at                                      |

操作：

- 新建角色；
- 编辑角色名称/描述；
- 删除角色（如有成员绑定，可选择提示或阻止，视设计而定）。

#### 7.2.2 系统初始化角色（模板角色）

系统可预置若干角色作为模板（如“Owner 模板”“分析师模板”等），在数据上体现为：

- `is_system = true`。

本期约定：

- **系统初始化角色不施加特殊约束**：

  - 可以像普通角色一样修改名称、描述；
  - 可以自由调整资源权限、行权限、列权限；
  - 可以删除（若有需要）。

- `is_system` 仅表示“角色来源”，方便统计和后续版本可能做引导，不作为强约束逻辑。

---

### 7.3 资源树权限配置（RolePermission）

此处配置的是：**角色**在**表 / 任务流 / 看板**上的 VIEW / EDIT / MANAGE 权限。

#### 7.3.1 页面结构

- 顶部：角色选择（下拉框）；
- 主体：

  - Tab 切换不同资源类型：

    - 表权限（Tables）
    - 任务流权限（Flows）
    - 看板权限（Boards）

  - 每个 Tab 内部采用 ResourceTree + 权限编辑区。

#### 7.3.2 表权限配置

在“表权限” Tab 内：

- 左侧展示 scope=TABLE 的 ResourceTree（Folder + 表）；
- 选中某一表节点时，右侧显示：

| 权限项     | 可选值                      |
| ---------- | --------------------------- |
| 表结构权限 | NONE / VIEW / EDIT / MANAGE |
| 表数据权限 | NONE / VIEW / EDIT / MANAGE |

在 Folder 节点上：

- 可配置“默认表结构权限 / 默认表数据权限”；
- 未在表节点显式配置权限的表，使用最近祖先 Folder 的默认值。

用户操作：

- 可以在 Folder 上快速设置默认权限；
- 需要对个别表做差异化配置时，可以在表节点上单独设置。

#### 7.3.3 任务流权限配置

在“任务流权限” Tab 内：

- 展示 scope=FLOW 的 ResourceTree（Folder + Flow）；
- 对每个 Flow 节点配置：

| 权限项    | 可选值                      |
| --------- | --------------------------- |
| Flow 权限 | NONE / VIEW / EDIT / MANAGE |

Folder 节点支持“默认 Flow 权限”。

#### 7.3.4 看板权限配置

在“看板权限” Tab 内：

- 展示 scope=BOARD 的 ResourceTree（Folder + Board）；
- 对每个 Board 节点配置：

| 权限项     | 可选值                      |
| ---------- | --------------------------- |
| Board 权限 | NONE / VIEW / EDIT / MANAGE |

Folder 节点支持“默认 Board 权限”。

#### 7.3.5 保存与错误反馈

- 所有更改（无论是 Folder 还是具体资源）通过一个“保存”按钮统一提交；
- 后端若校验失败（参数错误、数据不一致等），需要返回明确错误消息；
- 前端需在界面上明显提示保存失败的原因，避免“点了没反应”的体验。

---

### 7.4 行/列权限配置（数据级权限）

数据级权限以“表”为维度进行配置，入口可以有：

- Modeling → 某表详情 → “数据权限” Tab；
- 或 Settings → 表列表 → 对应表的“数据权限配置”按钮（跳转同一页面）。

#### 7.4.1 列权限配置（ColumnPermission）

页面结构：

- 顶部：角色选择下拉框；
- 中部：字段列表表格。

字段表格列：

| 列名     | 说明                                |
| -------- | ----------------------------------- |
| 字段名称 | Field.display_name                  |
| 字段编码 | Field.code                          |
| 类型     | Field.type                          |
| 列权限   | 下拉：HIDDEN / READONLY / READWRITE |

行为：

- 修改列权限后，点击“保存”，覆盖该角色在该表上的列权限配置；
- 未显式配置的字段，使用系统默认策略（建议默认 READWRITE，只受资源级 TABLE_DATA 约束）。

可选约束（按需要实现）：

- 对于某些系统字段（如主键 id），可限制最低为 READONLY 不允许 HIDDEN；
  若不需要严格限制，亦可全部交给租户自定义。

#### 7.4.2 行权限配置（RowPermission）

页面结构：

- 顶部：角色选择下拉框；
- 中部：规则列表，每条记录代表一条 RowPermission；
- 每一条包含：

  - 规则名称（可空）；
  - 条件编辑器（可视化 FilterDSL）；
  - 删除按钮。

行为：

- 新建规则：

  - 用户通过选择字段、操作符、输入值的方式配置条件；
  - 保存时将条件序列化为 FilterDSL JSON 保存到 RowPermission。

- 编辑规则：

  - 打开已有规则的条件编辑器进行修改；

- 删除规则：

  - 删除对应 RowPermission 记录。

生效逻辑严格遵从第 4 章：

- 角色内多条规则 → OR；
- 多角色 → 再 OR；
- 与业务过滤 / Dataset 过滤 → AND。

#### 7.4.3 生效时机与风险提示

- 行/列权限修改提交成功后即刻生效：

  - 后续请求立即使用新配置；
  - 已打开页面在刷新或重新查询时才体现新权限。

- 对潜在影响较大的变更（如大量字段设置为 HIDDEN），可以在保存前提示：

  > “该操作可能导致部分用户无法看到字段 X / Y / Z，确认保存吗？”

---

### 7.5 权限变更审计（基础）

本期至少保证权限变更相关操作在后端有可追溯记录。

#### 7.5.1 审计范围

需要记录的操作包括但不限于：

- 角色管理：

  - 创建角色；
  - 编辑角色名称 / 描述；
  - 删除角色。

- 成员角色关系：

  - 为用户添加 / 移除角色；
  - 设置 / 取消 Owner。

- 资源权限：

  - 修改角色在表 / Flow / Board 上的资源级权限。

- 行权限：

  - 新增 / 修改 / 删除 RowPermission 规则。

- 列权限：

  - 修改 ColumnPermission（例如字段权限从 READWRITE → HIDDEN）。

#### 7.5.2 审计记录内容

每条记录至少包括：

- 操作人（TenantUser + 对应 GlobalUser 标识）；
- 操作时间；
- 操作类型（枚举）；
- 操作对象（角色 ID / 用户 ID / 表 ID / Flow ID / Board ID 等）；
- 变更摘要（如“字段 amount 列权限：READWRITE → HIDDEN”）；
- 操作结果（成功 / 失败及失败原因）。

前端是否提供完整的“权限变更记录”页面，可在第 12 章统一规划，本期可选择只做后端记录。

## 8. 建模模块（Modeling）

> 本章是整个系统最核心的功能之一，描述如何在租户内管理业务表、字段结构、表数据以及通过“关联字段”表达的表间关系。
> 涉及的权限规则需与第 4 章（DSL & 权限模型）、第 7 章（Tenant Settings）保持一致。

---

### 8.1 模块目标 & 典型使用流程

#### 8.1.1 模块目标

建模模块为租户提供：

1. **结构化数据建模能力**

   - 定义业务表（Table）、字段（Field）、关联字段（Reference Field），从而表达业务实体及其关系。

2. **统一的数据管理入口**

   - 在一个界面内完成：

     - 表结构设计（字段定义）；
     - 表数据的浏览、筛选、增删改查。

3. **权限安全的数据操作**

   - 严格遵守：

     - 资源级权限：`TABLE_SCHEMA` / `TABLE_DATA`；
     - 行级权限：RowPermission；
     - 列级权限：ColumnPermission。

4. **可供下游复用的元数据中心**

   - 为任务流（Flows）、数据集 & 看板（Datasets & Boards）提供统一的元数据来源：

     - 哪些表；
     - 每张表有哪些字段；
     - 哪些字段是“关联字段”，从而推断默认 Join 条件。

---

#### 8.1.2 主要角色

- **租户数据工程师 / 建模者**

  - 主要职责：

    - 新建/调整业务表；
    - 设计字段结构；
    - 定义关联字段（表间关系）；
    - 保障数据模型的可维护性和可扩展性。

- **业务分析师**

  - 主要职责：

    - 查看表结构、字段含义；
    - 在权限允许情况下录入 / 修改部分数据；
    - 为数据集和看板配置做准备（理解哪些表用于哪些业务分析）。

- **普通业务用户**

  - 主要职责：

    - 在有限权限范围内查看 / 维护与自己相关的业务数据；
    - 不承担建模职责。

---

#### 8.1.3 典型使用流程（示例）

**流程 A：从 0 到一张可用来分析的业务表**

1. 进入建模模块 → 在某个 Folder 下创建“订单表”；
2. 在“结构”页中新增字段：订单号、下单时间、用户 ID、金额、状态等；
3. 在“数据”页手工录入几条订单记录，或由任务流写入；
4. 分析师在“数据集模块”中基于该表创建 Dataset，再配置看板展示订单分析指标。

---

**流程 B：建立主表-明细表关系（通过关联字段）**

1. 已有两张表：

   - “订单表”
   - “订单明细表”

2. 在“订单明细表”的“结构”页中：

   - 新增一个数据类型为「关联」的字段，例如“关联订单”；
   - 关联配置中选择：

     - 关联表：订单表；
     - 关联字段：订单表主键（如 id）；
     - 展示字段：订单号。

3. 此后，在任务流 / 数据集配置 Join 时：

   - 当同时选择“订单明细表”和“订单表”，系统可以推荐默认 Join 条件：

     - `订单明细.关联订单 = 订单.id`。

---

### 8.2 模块入口 & 权限前置规则

#### 8.2.1 入口路径

- 前端路由示例：`/app/:tenantId/modeling`
- 进入建模模块时，必须满足：

  1. 用户已登录并通过身份认证；
  2. 当前租户为 `ACTIVE` 状态；
  3. 当前用户在本租户下存在 TenantUser 记录。

---

#### 8.2.2 模块访问权限前置

- 若用户在本租户内，对**所有表**的：

  - `TABLE_SCHEMA = NONE` **且**
  - `TABLE_DATA = NONE`：

  则：

  - 允许进入建模模块，但：

    - 不展示资源树和表列表；
    - 在主区域展示一个“您当前没有任何表的访问权限”的提示页；
    - 可引导用户联系管理员调整权限。

- 若用户对至少一张表有：

  - `TABLE_SCHEMA ≥ VIEW` 或 `TABLE_DATA ≥ VIEW`：

  则：

  - 允许进入建模模块；
  - 资源树和表列表仅展示该用户“有权限的表”。

---

#### 8.2.3 异常情况处理

- **租户被 SUSPENDED：**

  - 所有建模模块接口返回 403；
  - 前端跳转到统一的“租户已停用”页面（参见第 6 章约定）。

- **TenantUser.status = DISABLED：**

  - 后端统一在认证层拦截请求，返回 403；
  - 不需要在建模模块内单独处理。

---

### 8.3 表资源树（Table ResourceTree）

#### 8.3.1 资源树结构

- 左侧区域展示 `scope = TABLE` 的资源树：

  - 节点类型包括：

    - **Folder**：逻辑目录，仅用于组织表；
    - **Table**：具体业务表。

- 根节点可以为“全部表”（或“根目录”），下面挂载多层 Folder / Table。

---

#### 8.3.2 资源树权限可见性

- 对于某张表 T：

  - 若用户对 T 的：

    - `TABLE_SCHEMA = NONE` **且**
    - `TABLE_DATA = NONE`：

    → **不在资源树中展示**该表；

  - 否则（任一 ≥ VIEW）：

    → 在资源树中展示该表节点。

- 对于某个 Folder：

  - 若该 Folder 下（递归）没有任何用户可见的表：

    - 可选择隐藏该 Folder，避免空目录；

  - 若 Folder 下存在任意可见表：

    - 展示该 Folder 节点，即便用户没有权限对 Folder 本身进行管理操作（仅作为容器）。

---

#### 8.3.3 节点展示信息

- **Folder 节点：**

  - 图标（文件夹） + 名称。

- **表节点：**

  - 图标（可根据表类型区分维度/事实/配置）；
  - 表显示名称 `Table.display_name`；
  - 可选：小标签展示“维度 / 事实 / 配置”。

---

#### 8.3.4 资源树操作与权限

对用户可见的节点，根据 `TABLE_SCHEMA` / `TABLE_DATA` 权限，决定操作是否可见及可用。

##### 1）Folder 操作

**统一前置条件：**
用户在该 Folder 上必须拥有：

- `resource_type = TABLE_SCHEMA` 且
- `permission = MANAGE`。

在上述前提下，允许以下操作：

- **新建子文件夹**

  - 仅在当前 Folder 上 `TABLE_SCHEMA = MANAGE` 时显示入口；
  - 新建子 Folder：

    - 默认继承父 Folder 的权限配置（可在权限模块后续调整）；

  - 名称校验：

    - 非空；
    - 同一父目录下不允许重名。

- **重命名 Folder**

  - 仅在当前 Folder 上 `TABLE_SCHEMA = MANAGE` 时显示入口；
  - 修改 `display_name`，不影响其子节点及已有权限配置。

- **删除 Folder**

  - 前提：当前 Folder 上 `TABLE_SCHEMA = MANAGE`；
  - 删除前校验：

    - 若该 Folder 下存在任意子 Folder 或表 → 禁止删除；
    - 提示：“请先移动或删除该目录下所有子目录和表后，再删除该目录。”

  - 校验通过后，删除该 Folder 节点本身。

- **拖拽移动 Folder**

  - 必须同时满足：

    - 被拖拽的 Folder 上 `TABLE_SCHEMA = MANAGE`；
    - 目标父 Folder 上 `TABLE_SCHEMA = MANAGE`；

  - 禁止：

    - 将 Folder 拖入自身或其子孙节点，避免形成环。

---

##### 2）Table 节点操作

- **打开结构（Schema）**

  - 前提：该表上 `TABLE_SCHEMA ≥ VIEW`；
  - 行为：进入表详情页的“结构”Tab。

- **打开数据**

  - 前提：该表上 `TABLE_DATA ≥ VIEW`；
  - 行为：进入表详情页的“数据”Tab。

- **打开数据权限配置**

  - 前提：该表上 `TABLE_DATA = MANAGE`；
  - 行为：进入表详情页“数据权限”Tab（行/列权限配置；见第 4 章）。

- **拖拽移动表到其它 Folder**

  - 必须同时满足：

    1. 在该表上 `TABLE_SCHEMA = MANAGE`；
    2. 在目标 Folder 上 `TABLE_SCHEMA = MANAGE`；

  - 拖拽只改变表所属 Folder（资源树位置），不影响表结构和数据。

- **删除表**

  - 前提：该表上 `TABLE_SCHEMA = MANAGE`；
  - 删除逻辑完全按 8.5.3“删除表”执行（包含依赖检查和错误提示）。

---

#### 8.3.5 懒加载与性能要求

- 当某租户表数量较多时：

  - 资源树应支持懒加载：

    - 展开某个 Folder 时再请求加载其子节点；
    - 避免一次性加载所有表引起卡顿；

  - 可限制默认展开层级，首次仅展开根 + 第一层 Folder。

---

### 8.4 表列表 & 基本信息

#### 8.4.1 列表区域

- 位于右侧主区域，随资源树选中节点而变化：

  - 若选中根或某 Folder：

    - 展示该目录下所有可见表；
    - 是否包含子 Folder 内的表可配置（仅当前层级 / 递归），建议提供切换选项。

- 粒度：一行一张表。

---

#### 8.4.2 默认列字段

| 列名     | 说明                                          |
| -------- | --------------------------------------------- |
| 表名     | `Table.display_name`                          |
| 表编码   | `Table.code`（只读展示）                      |
| 表类型   | 维度 / 事实 / 配置 / 其他                     |
| 创建人   | `created_by` 对应的 `TenantUser.display_name` |
| 创建时间 | `created_at`                                  |
| 更新时间 | `updated_at`                                  |
| 操作     | 结构 / 数据 / 数据权限 / 删除（按权限显示）   |

---

#### 8.4.3 筛选与搜索

- 顶部提供搜索输入框：

  - 支持按表名 / 表编码模糊搜索；

- 筛选条件（可选）：

  - 表类型（维度 / 事实 / 配置 / 其他）；
  - 创建时间范围。

- 搜索 & 筛选结果**只包含用户有权限的表**：

  - 即任一 `TABLE_SCHEMA / TABLE_DATA ≥ VIEW`。

---

#### 8.4.4 排序

- 默认按 `created_at` 倒序；

- 支持按以下字段排序：

  - 表名；
  - 更新时间；
  - 表类型；
  - 创建人（可选）。

- 排序行为：

  - 支持升序 / 降序切换；
  - 当前排序状态需在 UI 中明显标识。

---

#### 8.4.5 空状态 & 异常

- 当当前目录下无任何可见表时：

  - 显示空状态：

    - 文案示例：“当前目录下暂无您有权限查看的表。”
    - 若用户有建表权限，可同时展示“新建表”按钮。

- 当筛选结果为空时：

  - 显示“未找到符合条件的表”；
  - 提供“清除筛选”按钮，重置搜索和筛选条件。

---

### 8.5 表生命周期（创建 / 编辑 / 删除）

#### 8.5.1 新建表

**入口：**

- 资源树根或某个 Folder 节点上的“新建表”按钮；
- 表列表区域的“新建表”按钮（根据权限显示）。

**权限前置：**

- 用户在“目标 Folder”上必须具备创建表的权限，即：

  - `resource_type = TABLE_SCHEMA` 且
  - `permission ≥ EDIT`（或专门的“创建表”权限配置）。

---

**新建表表单字段：**

| 字段       | 必填 | 说明                                                                   |
| ---------- | ---- | ---------------------------------------------------------------------- |
| 表名       | 是   | 1–50 字符，业务可读名称，如“订单表”、“广告计划表”                      |
| 表编码     | 否   | 只读，由系统自动生成；英文小写蛇形（snake_case），在同一租户内必须唯一 |
| 表类型     | 是   | 维度 / 事实 / 配置 / 其他                                              |
| 描述       | 否   | 0–200 字符                                                             |
| 所属文件夹 | 否   | 选择资源树中的某 Folder，默认当前选中的 Folder 或根；创建后可以调整    |

---

**表编码生成规则（固定约定）**

1. **只读，不允许用户编辑**

   - 在新建/编辑表表单中，“表编码”始终为只读；
   - 用户不能直接修改 `code`，只能通过修改“表名”间接影响生成。

2. **字符组成与格式**

   - 仅允许字符：`a–z`、`0–9`、`_`；
   - 全部小写；
   - 使用蛇形命名（snake_case），例如：

     - `order`
     - `user_profile`
     - `order_item_detail`；

   - 首字符必须是字母：

     - 若规范化后首字符不是字母，则自动加前缀 `t_`；

   - 最大长度：50 字符，超出的部分直接截断。

3. **唯一性范围**

   - 在同一租户内，`code` 必须唯一；
   - 唯一性针对“业务表元数据”，物理表名称可额外加 `tenant_id` 等前缀保证全局唯一。

4. **生成流程（前端视角）**

   - 当用户输入/修改“表名”并 blur 时：

     1. 前端调用“生成表编码”后端接口，参数包括：

        - `display_name`（表名）
        - `tenant_id`

     2. 后端内部：

        - 调用本地 LLM 生成英文候选（如 `order`, `user_profile`）；
        - 进行规范化处理（转小写、替换非法字符、首字母修正、截断）；
        - 若结果为空或只剩 `_`：

          - 可根据拼音等再生成一次候选；

        - 在当前租户范围内检查唯一性：

          - 若已存在同名 `code`，在末尾追加 `_1`，`_2`…直到找到未占用值；

     3. 后端返回最终 `code`，前端显示于“表编码”只读字段。

5. **失败与降级行为**

   - LLM 调用失败但本地规则仍能生成合法编码：

     - 使用本地规则生成结果，用户无感知；

   - LLM + 本地规则都失败（极端情况）：

     - 接口返回失败；
     - 前端提示：“表编码生成失败，请稍后重试”；
     - 禁止提交表单。

6. **后续不可变更**

   - 表创建成功后：

     - `code` 在整个生命周期内禁止修改；
     - 即使用户修改“表名”，`code` 也不变；

   - 这是为了保证下游配置（任务流 / 数据集 / 看板）的稳定性。

---

**创建时自动系统字段：**

创建物理表时，系统自动添加以下系统字段（具体类型由技术方案落实）：

- `id`：主键（int/bigint 自增或 UUID）；
- `created_at`：创建时间（datetime）；
- `updated_at`：最后更新时间（datetime）；
- `created_by`：创建人 TenantUser id；
- `updated_by`：最后修改人 TenantUser id。

这些字段：

- `is_internal = true`；
- 字段编码和类型不可通过前端修改或删除。

---

**事务性要求：**

创建表需要同时：

1. 写入 Table 元数据；
2. 在物理数据库中创建实际表结构（至少含系统字段）。

要求：

- 任一步骤失败需整体回滚；
- 不允许出现：

  - 只有元数据、没有物理表；
  - 有物理表、没有元数据；

- 前端需提示失败原因（如数据库错误）。

---

#### 8.5.2 编辑表信息

**入口：**

- 在表列表点击“结构” → 表详情 → 基本信息区域；
- 或在表详情右上角提供“编辑表信息”按钮。

**可编辑字段：**

| 字段       | 说明                      | 修改后影响                       |
| ---------- | ------------------------- | -------------------------------- |
| 表名       | 修改展示名称              | 不影响表编码，不影响下游引用     |
| 表类型     | 维度 / 事实 / 配置 / 其他 | 仅用于分类展示，不影响数据读写   |
| 描述       | 业务描述                  | 仅元数据，便于理解               |
| 所属文件夹 | 可以变更                  | 影响资源树位置，不影响数据与结构 |

**不可编辑字段：**

- 表编码（code）；
- 创建人；
- 创建时间。

---

**并发编辑：**

- 建议使用 `updated_at` 做简单并发检查：

  - 前端在加载表信息时记录当前 `updated_at`；
  - 提交更新时携带该时间戳；
  - 若后端发现 `updated_at` 已变化：

    - 返回“资源已被更新”的错误；
    - 前端提示“表信息已被其他人修改，请刷新后再编辑”。

---

#### 8.5.3 删除表

**入口：**

- 表列表中的“删除”操作；
- 资源树中表节点的右键菜单“删除表”（如有）。

**前置条件：**

- 用户对该表拥有 `TABLE_SCHEMA = MANAGE` 权限；
- 租户状态为 `ACTIVE`。

---

**删除流程：**

1. 用户点击“删除表”：

   - 弹出确认弹窗，展示：

     - 表名、表编码；
     - 风险提示（不可恢复、被引用则无法删除等）。

2. 用户确认后，前端调用删除接口。

---

**后端依赖检查：**

在真正删除前，后端必须检查该表是否被引用：

1. 是否被任何 Flow 节点引用为：

   - 数据源；
   - 写入目标；

2. 是否被任何 Dataset 绑定为数据来源；
3. 是否被任何 Widget / Board 使用（如图表的数据源表）；
4. 是否被其他表的“关联字段”引用：

   - 有字段 `ref_table_id = 当前表.id`；

5. 是否存在行 / 列权限配置：

   - RowPermission / ColumnPermission 中绑定了该表。

存在任一引用：

- 删除失败；
- 返回结构化错误信息，至少包括：

  - 引用类型（Flow / Dataset / Board / 关联字段 / 权限）；
  - 数量；

- 前端简化展示，例如：

> “该表当前被 2 个任务流、1 个数据集、1 个关联字段引用，请先在对应模块中删除相关引用，再删除本表。”

---

若无引用：

- 删除元数据中的表记录；
- 删除物理数据库中的实际表；
- 删除该表相关的行/列权限配置等元数据。

---

**并发删除：**

- 若表在当前操作前已经被其他会话删除：

  - 删除接口返回“资源不存在”；
  - 前端提示“该表已被删除，请刷新页面”。

---

### 8.6 字段管理（Schema 管理）

字段管理是表详情中的“结构”页，负责定义表的列结构，包括普通字段与关联字段。

---

#### 8.6.1 字段列表 UI

- Tab 名称：**结构**；
- 粒度：每行一个字段。

**显示列：**

| 列名         | 说明                                                               |
| ------------ | ------------------------------------------------------------------ |
| 字段名称     | `Field.display_name`                                               |
| 字段编码     | `Field.code`（只读）                                               |
| 数据类型     | 面向用户的类型：文本 / 整数 / 小数 / 日期 / 日期时间 / 布尔 / 关联 |
| 主键标记     | `is_primary_key`（图标或标签展示）                                 |
| 必填         | `is_required`（NOT NULL）                                          |
| 默认值       | `default_value`（仅对非“关联”字段有意义）                          |
| 是否系统字段 | `is_internal`（图标区分系统字段）                                  |
| 描述         | `description`                                                      |
| 操作         | 编辑 / 删除（系统字段不显示删除按钮）                              |

> 注：
>
> - 列表展示的是对业务用户友好的“数据类型（UI 类型）”，底层真实数据库类型（db_type）对用户透明，由系统根据统一规则自动选择。

**排序：**

- 默认按 `created_at` 升序；
- 支持拖拽调整展示顺序：

  - 仅调整“展示顺序”，不影响真实物理表字段顺序；
  - 拖拽顺序用于：

    - 数据页字段展示顺序；
    - 表结构导出时的默认顺序等。

**权限控制：**

- `TABLE_SCHEMA < VIEW`：

  - 访问结构页接口返回 403；

- `TABLE_SCHEMA = VIEW`：

  - 仅可查看字段列表；
  - 不展示“新增/编辑/删除”；

- `TABLE_SCHEMA ≥ EDIT`：

  - 可新增 / 编辑 / 删除字段（遵守系统字段和主键相关约束）。

---

#### 8.6.2 新增字段

**入口：**

- 字段列表顶部“新增字段”按钮。

---

##### 8.6.2.1 新增字段表单（通用字段）

| 字段     | 必填 | 说明                                                            |
| -------- | ---- | --------------------------------------------------------------- |
| 字段名称 | 是   | 1–50 字符，字段展示名，如“订单金额”、“状态”                     |
| 字段编码 | 否   | 只读，由系统生成（LLM + 规则），不可手动修改                    |
| 数据类型 | 是   | 下拉：文本 / 整数 / 小数 / 日期 / 日期时间 / 布尔 / 关联        |
| 是否主键 | 否   | 默认 false，V1 仅支持单主键；仅当数据类型 ≠ 关联 时允许勾选     |
| 是否必填 | 否   | 映射 NOT NULL，默认 false                                       |
| 默认值   | 否   | 根据“数据类型”展示不同输入控件；当数据类型 = 关联 时隐藏 / 禁用 |
| 描述     | 否   | 0–200 字符，用于说明字段含义                                    |

---

**字段编码生成逻辑：**

- 与表编码类似：

  - 根据“字段名称”自动调用“生成字段编码”接口；
  - 规则统一由第 11 章“编码规范 & LLM 辅助命名服务”定义；

- 同一表内 `code` 必须唯一；
- 生成失败时：

  - 禁止提交；
  - 提示具体错误信息。

---

**数据类型（UI 类型）说明：**

- 文本：字符串字段，系统内部选用合适的 `varchar` 或 `text` 类型；
- 整数：整型数值，内部选择 `int` / `bigint` 等；
- 小数：带小数的数值，内部选择 `decimal(p,s)` 等；
- 日期：仅年月日；
- 日期时间：年月日 + 时分秒；
- 布尔：是/否；
- 关联：表示“当前表这一列用来指向另一张表的一条记录”（详细见 8.6.2.2 & 8.6.6）。

> 对于非“关联”类型，业务用户只需选择 UI 类型，底层具体 db_type 由系统统一决定。
> 例如：
>
> - “小数”→ 默认 `decimal(18, 2)`；
> - “整数”→ 默认 `bigint` 等。

---

##### 8.6.2.2 新增“关联”字段

当用户在“数据类型”中选择「关联」时：

1. **字段级别 UI 行为调整：**

   - “是否主键”直接禁用（关联字段不允许作为主键）；
   - “默认值”字段隐藏或禁用（关联字段不支持默认值）；
   - “是否必填”仍可配置：

     - 勾选：保存时该字段必须有有效关联值；
     - 未勾选：可为空（允许无关联记录）。

2. **展示“关联配置”区域：**

仅在数据类型 = 关联 时显示，如下：

| 配置项               | 必填 | 说明                                                                 |
| -------------------- | ---- | -------------------------------------------------------------------- |
| 关联表               | 是   | 从当前租户内用户可见且 `TABLE_SCHEMA ≥ VIEW` 的表中选择              |
| 关联字段             | 否   | 选中关联表后，默认使用该表主键字段；也可从该表字段列表中选择其他字段 |
| 展示字段（用于显示） | 否   | 用于数据页展示此关联字段时显示的文字，如“用户名”、“订单号”           |
| 选择方式             | 否   | 下拉选择 / 搜索选择，用于数据录入时的交互表现                        |

3. **底层类型自动匹配（对用户透明）：**

- 用户不需要也不能选择底层存储类型；
- 系统内部逻辑：

  - 读取“关联字段”的底层 db_type；
  - 将当前字段的 db_type 自动设置为与关联字段完全一致；

- 若“关联字段”本身是一个关联字段：

  - V1 限制：

    - 在“关联字段”下拉中，只展示目标表的普通字段和主键字段；
    - 不展示目标表中的关联字段，避免形成复杂链条。

4. **保存约束（V1 简化）：**

- 新建字段时：

  - 可以随意选择 UI 类型；

- 字段创建成功后：

  - 数据类型不可修改：

    - 普通 → 关联：不支持；
    - 关联 → 普通：不支持；

- 如需从普通字段“迁移”为关联字段：

  1. 新增一个“数据类型 = 关联”的新字段；
  2. 通过任务流 / SQL 将旧字段数据迁移到新字段（如匹配 ID）；
  3. 完成后视情况停用或删除旧字段（受依赖检查约束）。

5. **字段保存校验：**

- 当数据类型 = 关联：

  - 必须选择“关联表”；
  - 未选“关联字段”时：

    - 默认使用关联表主键字段；

  - 若目标表没有任何可用字段：

    - 禁止保存，提示“目标表没有可用于关联的字段，无法创建关联字段”。

---

#### 8.6.3 编辑字段

**可编辑项（普通字段）：**

- 字段名称（display_name）；
- 是否必填（is_required）；
- 默认值（default_value）；
- 描述（description）。

**可编辑项（关联字段）：**

- 字段名称（display_name）；
- 是否必填（is_required）；
- 描述（description）；
- 关联配置中部分可调优项：

  - 展示字段（ref_display_field）；
  - 选择方式（ref_input_mode：下拉 / 搜索）。

---

**不可编辑项（统一约束）：**

- 字段编码（code）；
- 数据类型（UI 类型：文本 / 整数 / … / 关联）；
- 底层存储类型（db_type）；
- 是否主键（is_primary_key）；
- 是否系统字段（is_internal）；
- 对于关联字段：

  - 关联表（ref_table_id）；
  - 关联字段（ref_field_id）。

> 说明：
>
> - 一旦字段创建成功，即锁定其类型和主键属性；
> - 对关联字段，要调整关联关系，应通过“新增新字段 + 数据迁移”的方式进行。

---

**修改“是否必填”时的校验：**

- 对于“从可空 → 必填”的变化：

  - 后端需检查现有数据是否存在 `NULL`：

    - 若存在 `NULL` 记录：

      - 修改失败；
      - 提示：“存在 N 条记录该字段为空，不允许改为必填，请先清理数据。”

---

**并发编辑：**

- 使用 `updated_at` 做乐观锁：

  1. 前端加载字段详情时，记住当前 `updated_at`；
  2. 更新请求需带上该时间戳；
  3. 若后端发现 `updated_at` 已变化：

     - 返回冲突错误；
     - 前端提示“字段已被其他人修改，请刷新后重试”。

---

#### 8.6.4 删除字段

**前置条件：**

- 用户对该表具有 `TABLE_SCHEMA ≥ EDIT`；
- 字段不是主键字段；
- 字段不是系统字段（`is_internal = false`）。

---

**依赖检查（删除前必须执行）：**

1. 是否被其他表的“关联字段”引用：

   - 作为 `ref_field_id` 或
   - 作为 `ref_display_field_id`；

2. 是否被任何 Flow 节点使用；
3. 是否被任何 Dataset / Widget 使用；
4. 是否被 RowPermission / ColumnPermission 引用；
5. 是否出现在 FilterDSL（各种过滤配置）中。

存在任一引用：

- 删除失败；
- 返回引用来源列表（类型 + 数量 + ID 列表等）；
- 前端在提示中给出简化说明，引导用户先去目标模块解除依赖。

无引用：

- 删除字段元数据；
- 对应物理表执行 `ALTER TABLE DROP COLUMN`；
- 清理与该字段相关的 ColumnPermission 记录（如有）。

若该字段是“关联字段”：

- 删除字段本身即可，其关联元数据（ref_table_id 等）随字段记录一并删除。

---

#### 8.6.5 系统字段规则

系统字段（如：`id / created_at / updated_at / created_by / updated_by`）：

- UI 中数据类型可以统一展示为“系统字段”或对应类型的只读字段；
- 不允许：

  - 删除；
  - 修改字段编码（code）；
  - 修改底层类型（db_type）；
  - 将其设置为数据类型=关联；
  - 作为其他表的关联字段（ref_field）。

是否允许修改系统字段的“字段名称 / 描述”：

- 建议：

  - 允许修改 display_name / description；
  - 禁止修改其编码（code）与底层含义；

- 用途：

  - 便于本地化和业务语义展示。

---

#### 8.6.6 关联字段（Reference 字段）的行为与约束

本节仅描述“数据类型=关联”的字段在系统中的行为，不引入单独 Relation 实体。

---

##### 8.6.6.1 元数据结构（产品层面）

在 Field 元数据中，需要包含以下与关联相关的字段（命名仅为示意）：

- `ui_type`：UI 数据类型，枚举值之一为 `REFERENCE`（对应“关联”）；
- `is_reference`：bool，与 `ui_type = REFERENCE` 保持一致；
- `ref_table_id`：关联表 ID；
- `ref_field_id`：关联字段 ID；
- `ref_display_field_id`：展示字段 ID；
- `ref_input_mode`：输入模式，枚举：`SELECT` / `SEARCH`。

底层 `db_type`：

- 等于 `ref_field` 的 db_type；
- 对用户完全隐藏。

---

##### 8.6.6.2 数据页中的展示与编辑

**查看：**

- 列表中：

  - 显示“展示字段（ref_display_field）”的值，例如用户姓名、订单号；
  - 若关联记录不存在或已被删除：

    - 显示为“（已失效）ID=xxx”之类的提示；

- 若当前用户对“关联表”拥有 `TABLE_DATA ≥ VIEW`：

  - 可以为关联字段提供“跳转查看关联记录”的入口（新开详情侧滑 / 新页面）。

---

**编辑：**

- 前提：当前用户对本表拥有 `TABLE_DATA ≥ EDIT`；
- 同时还要考虑：

  - 本字段最终列权限（ColumnPermission）是否为 READWRITE；

1. **有查看目标表数据权限（目标表 `TABLE_DATA ≥ VIEW`）的情况：**

   - `ref_input_mode = SELECT`：

     - 小数据量场景：

       - 下拉列表展示目标表有限条记录；

     - 大数据量场景：

       - 需自动采用分页 / 搜索：

         - 可在输入框内进行搜索联想；
         - 后端按展示字段模糊匹配返回候选；

   - `ref_input_mode = SEARCH`：

     - 提供搜索输入框：

       - 用户输入关键字；
       - 后端在展示字段上进行模糊搜索；
       - 返回候选列表供用户选择；

2. **无查看目标表数据权限（目标表 `TABLE_DATA < VIEW`）的情况：**

   - 出于安全考虑：

     - 不提供候选列表（无法展示关联表数据）；
     - 不允许编辑该关联字段的值；

   - UI 中：

     - 展示只读内容；
     - 可提示：“您没有权限查看/修改该关联字段，请联系管理员。”

---

**空值：**

- 若字段 `is_required = false`：

  - 允许为空，不选择任何关联记录；
  - 展示为“空”或“未设置”。

---

##### 8.6.6.3 关系信息的来源（无独立 Relation 实体）

- 系统**不再**存在单独的 Relation 表或实体；

- 表间关系完全由“关联字段”的元数据表达：

  - 若表 A 中有字段 F：

    - `ui_type = 关联`；
    - `ref_table_id = B`；
    - `ref_field_id = B.id`；

  - 则产品语义为：

    > “A 表中的字段 F 指向 B 表的一条记录（通常是主键 ID）”。

- 下游模块（Dataset / Flow 等）在自动推荐 Join 条件时：

  - 当用户选择了 A 表和 B 表：

    - 若存在 A 中字段 F 满足 `ref_table_id = B`：

      - 推荐 Join 条件：`A.F = B.ref_field`；

    - 若存在 B 中字段 G 满足 `ref_table_id = A`：

      - 推荐 Join 条件：`B.G = A.ref_field`。

- 在“结构”页中，对数据类型=关联的字段，可额外展示一列简要描述：

  - 例如：“指向：用户表.主键（展示：用户名）”。

---

##### 8.6.6.4 目标表 / 目标字段删除的影响

- 删除某表时：

  - 若有任一字段的 `ref_table_id = 该表.id`：

    - 删除该表会被依赖检查阻止（8.5.3）；

- 删除某字段时：

  - 若被其他表字段作为：

    - `ref_field_id` 或
    - `ref_display_field_id` 引用：
    - 删除会被依赖检查阻止（8.6.4）；

- 正常产品操作路径下：

  - 不会出现“某个关联字段指向了不存在的表 / 字段”这种数据不一致情况；
  - 若运维绕过系统直接改库导致异常，需要运维负责修复。

---

##### 8.6.6.5 权限约束（与整个权限模型一致）

- 本表的 RowPermission / ColumnPermission：

  - 限制用户是否能看到 / 修改该关联字段所在的列和行；

- 目标表的 RowPermission：

  - 限制“候选列表”和“跳转详情”中能看到哪些关联记录；

- 目标表的 ColumnPermission：

  - 限制展示字段 / 搜索字段是否可见；

- 目标表的 `TABLE_DATA` 资源权限：

  - 决定是否允许加载候选记录以及是否允许跳转查看详情。

---

### 8.7 表数据页（数据浏览 & CRUD）

“数据”页用于查看和编辑表中的记录，是业务用户最常使用的界面之一。

---

#### 8.7.1 入口与权限检查

**入口：**

- 表列表中点击“数据”；
- 表详情中切换到“数据”Tab。

**权限：**

- 若 `TABLE_DATA < VIEW`：

  - 后端返回 403；
  - 前端展示“您没有权限查看该表数据”的提示页。

- 若 `TABLE_DATA ≥ VIEW`：

  - 可以查看数据列表（受行/列权限限制）；

- 若 `TABLE_DATA ≥ EDIT`：

  - 可以新增 / 编辑 / 删除记录（同样受行/列权限限制）。

---

**行/列权限应用：**

- 在任何数据操作前，后端需根据 RowPermission / ColumnPermission 计算：

  - 最终可见列集合：`final_columns`；
  - 最终行过滤条件：`final_row_filter`；

- 所有查询与更新操作必须在 `final_row_filter` 的约束下执行。

---

#### 8.7.2 列展示与列权限应用

- 表格列包括：

  - 用户可见的业务字段；
  - 选定展示的系统字段（如 id / created_at / updated_at）。

- 可见字段定义：

  - 对于当前用户：

    - ColumnPermission ≠ HIDDEN 的字段；
    - READONLY / READWRITE 在展示上相同，仅在编辑行为上有差别。

- 用列控制：

  - 用户可以在前端临时隐藏部分列（前端状态，不影响权限配置）；
  - 已被标记为 HIDDEN 的字段，在任何地方都不展示，也不会出现在导出结果中。

---

系统字段的展示策略（建议）：

- 默认展示：

  - `id`；
  - `created_at`；
  - `updated_at`；

- `created_by` / `updated_by`：

  - 可通过 hover 或详情视图展现；
  - 或在列表中设为可选列。

---

#### 8.7.3 数据查询（列表、筛选、排序、分页）

**基本行为：**

- 默认展示符合 `final_row_filter` 的部分记录：

  - 默认排序可以按 `id` 或 `created_at` 倒序；
  - 默认分页大小如 20 或 50。

---

**筛选方式：**

1. **简单筛选（Quick Filter）：**

   - 在表格上方提供常见字段的简易筛选：

     - 文本字段：模糊包含（contains）；
     - 数值字段：≥ / ≤；
     - 日期 / 日期时间字段：起始、结束时间；

   - 前端将用户输入转换为 FilterDSL 片段，提交给后端。

2. **高级筛选（Advanced Filter）：**

   - 打开条件构建器：

     - 支持 AND / OR；
     - 支持多字段组合；

   - 构建完整 FilterDSL 表达式（与第 4 章保持统一）。

---

**过滤逻辑：**

- 后端最终的 WHERE 条件：

  - `RowPermission_filter AND 用户自定义过滤条件(FilterDSL)`；

- 用户无法绕过 RowPermission：

  - 若用户构造的 FilterDSL 与 RowPermission 冲突，只会得到空数据集。

---

**分页：**

- 使用标准参数：

  - page / pageSize；

- 控制最大 pageSize（如 200）：

  - 若请求超过最大值，自动限制或返回错误；
  - 可提示：“单页数据量过大可能影响性能，已自动限制为 200 条。”

---

**排序：**

- 用户可按任意可见字段排序；
- 被隐藏字段（HIDDEN）不可用于排序；
- 排序与 RowPermission 组合：

  - 若排序字段在应用 RowPermission 后仍在 `final_columns` 中 → 正常；
  - 若排序字段被权限隐藏（极少场景）：

    - 后端应返回错误，前端重置排序。

---

#### 8.7.4 新增记录（Create）

**入口：**

- 数据列表上方的“新增记录”按钮；
- 仅当 `TABLE_DATA ≥ EDIT` 时显示。

---

**新增表单字段：**

- 显示对当前用户可见且可写（READWRITE）的字段；
- 对于 READONLY 字段：

  - 可以只读展示（如自动生成字段）；

- 对于 HIDDEN 字段：

  - 不出现在表单中。

---

**校验逻辑：**

- 前端初步校验：

  - 必填字段（is_required）不可为空；
  - 类型格式检查（数字、日期、布尔、关联字段等）；

- 后端严格校验：

  - 类型 / 长度 / 范围 / 业务约束；
  - 若失败：

    - 返回字段级错误信息；
    - 前端逐字段展示错误提示。

---

**系统字段填充：**

- 新增时：

  - `id`：由数据库生成（自增或 UUID）；
  - `created_at` / `updated_at`：使用服务器当前时间；
  - `created_by` / `updated_by`：当前 TenantUser.id。

---

**成功后行为：**

- 提示“保存成功”；
- 关闭新增弹窗（或清空表单）；
- 刷新列表：

  - 可自动跳转到新记录所在页并高亮。

---

#### 8.7.5 编辑记录（Update）

**入口：**

- 每行的“编辑”按钮；
- 或单击行跳出侧滑详情 + 编辑（视设计而定）。

---

**权限前置：**

- 表级：`TABLE_DATA ≥ EDIT`；
- 列级：

  - READWRITE 字段允许编辑；
  - READONLY 字段只读；
  - HIDDEN 字段不展示。

---

**并发修改策略（V1 简化）：**

- 可采用“最后写入覆盖”，不做版本冲突检查；
- 但建议预留扩展为 `updated_at` 乐观锁的能力：

  - 编辑表单携带 `updated_at`；
  - 保存时若不一致，可提示冲突。

---

**删除后编辑：**

- 若某记录在用户编辑期间已被删除：

  - 保存时后端返回“记录不存在”；
  - 前端展示“该记录已被删除，请刷新列表”。

---

#### 8.7.6 删除记录（Delete）

**入口：**

- 每行“删除”按钮；
- 可选支持勾选后批量删除（V1 可只支持单条删除）。

---

**权限：**

- `TABLE_DATA ≥ EDIT`。

---

**行为：**

- 点击“删除”时弹窗确认：

  - 提示“删除后不可恢复”；

- 后端删除逻辑：

  - V1 可以采用物理删除；
  - 如采用软删除：

    - 需在表结构中加入 `is_deleted` 等字段；
    - 并确保所有查询自动附加 `is_deleted = false` 条件；
    - 软删除方案由架构层统一定义，本 PRD 不强制要求。

---

**与关联字段的关系：**

- 系统不自动维护数据库级外键约束；
- 删除被指向表中的记录时：

  - 不会自动删除从表记录；
  - 从表中对应的关联字段会变为“孤儿引用”；
  - 数据页中展示为“（已失效）ID=xxx”或类似提示；

- 是否清理这些孤儿数据：

  - 由业务 / 运维通过任务流等方式定期处理；
  - 本 PRD 仅在文档中明确此行为，不强制产品实现自动清理。

---

#### 8.7.7 错误反馈与用户体验

- **FilterDSL 非法：**

  - 后端返回 4xx 及错误信息；
  - 前端提示：“筛选条件不合法，请检查后重试”，并可提供“清空筛选”按钮。

- **权限不足：**

  - 后端返回 403；
  - 前端统一文案：“您没有权限执行该操作”。

- **数据校验失败：**

  - 尽量返回字段级错误信息；
  - 前端在对应字段下方展示错误文本；
  - 若存在多个字段错误，逐一展示。

---

### 8.8 建模操作审计

建模操作会直接影响整个租户的数据结构和下游分析结果，需要提供必要的审计能力。

> 本节只规定“必须记录哪些日志”及其内容结构，具体查询展示页面在第 12 章定义。

---

#### 8.8.1 审计范围

需记录的建模相关操作包括（不限于）：

1. **表级操作：**

   - 新建表；
   - 编辑表基本信息（表名 / 类型 / 描述 / 所属文件夹）；
   - 删除表（成功与失败尝试）。

2. **字段级操作：**

   - 新增字段（包括普通字段和关联字段）；
   - 编辑字段（必填 / 默认值 / 描述 / 展示字段 / 选择方式等）；
   - 删除字段（包括删除失败的尝试）。

3. **数据结构类操作（未来扩展）：**

   - 若后续支持索引 / 约束配置等，也应纳入审计。

4. **权限相关拦截：**

   - 对表结构的访问若因权限不足被拒绝，可选记为“安全类审计事件”。

---

#### 8.8.2 审计记录内容

每条建模操作记录至少包含：

- 操作人：

  - TenantUser.id；
  - GlobalUser.id；
  - 显示名（便于界面展示）。

- 操作时间：

  - 统一使用服务器时间，记录精确到秒或毫秒。

- 操作类型（枚举），例如：

  - `CREATE_TABLE`；
  - `UPDATE_TABLE_BASIC`；
  - `DELETE_TABLE`；
  - `CREATE_FIELD`；
  - `UPDATE_FIELD`；
  - `DELETE_FIELD`；
  - `CREATE_REFERENCE_FIELD`（可细分或使用通用类型 + 字段内容区分）；
  - 等。

- 操作对象标识：

  - 表：

    - 表 ID；
    - 表编码（code）；

  - 字段（如有）：

    - 字段 ID；
    - 字段编码（code）；

  - 其他相关标识（如 Folder ID）。

- 操作前后差异（对于编辑类操作）：

  - 以 key-value 形式记录变更字段及其新旧值；
  - 例如：

    - `"is_required": { "from": false, "to": true }`。

- 操作结果：

  - 成功 / 失败；
  - 失败时记录简要原因：

    - 如“被 Dataset 引用，无法删除字段 xxxxxx”。

---

#### 8.8.3 审计查询（与第 12 章联动）

- 本章仅要求“必须记录”；
- 具体展示方式交由第 12 章统一设计，例如：

  - 在租户 Settings 中提供“建模操作日志”页面：

    - 支持按时间、操作人、操作类型筛选；

  - 在平台后台提供跨租户审计能力：

    - 供平台管理员查看高风险操作（批量删表等）。

## 9. 任务流模块（Flows）

> 本章定义租户内“任务流（Flow）”的功能与行为，用于在系统内编排批处理型数据流程：从业务表中读取数据、进行过滤 / 关联 / 汇总 / 计算，并写回到其他业务表。
> 本章所有描述均为本版本必须实现的行为；本版本不实现的能力会明确标注为“本版本不提供”。

---

### 9.1 模块目标 & 典型使用场景

#### 9.1.1 模块目标

任务流模块为租户提供：

1. **批处理型数据流程编排能力**

   - 在一个可视化 DAG 画布上，用节点的方式串联数据源、过滤、关联、聚合、计算、写入等步骤，形成完整数据处理链路。

2. **统一的调度执行入口**

   - 支持“手动运行一次”和“按固定周期调度运行”两种触发方式；
   - 所有运行实例有统一的运行记录与状态追踪。

3. **安全可控的数据读写**

   - 所有节点的读写行为严格受资源级权限约束；
   - 流程执行时对全表进行处理，不叠加 Row/Column 权限的限制（Row/Column 主要作用于交互式查询和看板）。

4. **可观测的运行监控与审计**

   - 每次运行都有完整的“节点级运行状态 + 记录数 + 错误信息”；
   - 关键操作与运行结果纳入系统审计体系。

---

#### 9.1.2 典型使用场景

1. **构建宽表 / 中间表**

   - 从“订单表”“用户表”“渠道表”等多个表中读取数据；
   - 通过 Join 节点关联；
   - 经过清洗、字段标准化；
   - 写入“订单宽表”，供看板和分析使用。

2. **定期生成统计表**

   - 每天 3 点：

     - 从订单表读取前一天数据；
     - 按渠道 / 游戏分组统计 GMV、DAU 等指标；
     - 写入“日报统计表”。

3. **数据清洗与字段修正**

   - 定期扫描某个历史表：

     - 对异常值进行过滤；
     - 重新计算某些衍生字段；
     - 重写目标表（覆盖方式）或写入新表。

---

### 9.2 核心概念与数据实体

#### 9.2.1 Flow（任务流）

**定义**

- Flow 是租户内部的一个“数据处理流程定义”，由若干节点（Node）和它们之间的依赖关系（DAG）构成。

**核心字段（逻辑层）**

- `id`：主键；
- `tenant_id`：所属租户；
- `code`：任务流编码（英文蛇形，租户内唯一）；
- `display_name`：任务流名称（中文或业务名）；
- `description`：描述；
- `folder_id`：所属 Flow 目录（用于左侧资源树，与表类似）；
- `enabled`：是否启用：

  - 控制是否允许调度触发；
  - 手动运行不受 `enabled` 影响；

- `schedule_cron`：调度 CRON 表达式（为空表示不启用调度）；
- `schedule_timezone`：时区标识；
- `owner_id`：负责人（TenantUser）；
- `created_by` / `updated_by`；
- `created_at` / `updated_at`。

> 本版本不提供 Flow 版本管理（不保留多历史版本）。Flow 编辑保存后直接替换当前配置。

---

#### 9.2.2 Node（节点）

**定义**

- Node 是 Flow 内的一个处理单元，输入一份数据集，输出一份数据集（表结构 + 行集），或作为起点 / 终点节点。

**核心字段**

- `id`：主键；
- `flow_id`：所属 Flow；
- `type`：节点类型，枚举（本版本支持）：

  - `TABLE_SOURCE`：表数据源节点；
  - `FILTER_PROJECT`：过滤 + 列选择节点；
  - `JOIN`：表连接节点；
  - `AGGREGATE`：聚合节点；
  - `CALC_FIELD`：计算字段节点；
  - `TABLE_SINK`：写入表节点。

- `name`：节点名称（默认根据类型生成，可编辑）；
- `config`：节点配置 JSON（字段如下各小节描述）；
- `position`：在画布上的坐标（x, y），用于前端展示；
- `created_at` / `updated_at`。

---

#### 9.2.3 Edge（连线）

**定义**

- Edge 表示节点之间的依赖关系（有向边）。整个 Flow 内的边必须构成一个有向无环图（DAG）。

**核心字段**

- `id`；
- `flow_id`；
- `from_node_id`；
- `to_node_id`；
- `created_at`。

**约束**

- 不允许 self-loop（from_node_id = to_node_id）；
- 不允许形成环路（后端在保存前做 DAG 校验）。

---

#### 9.2.4 FlowRun（任务流运行实例）

**定义**

- 每次 Flow 被触发（手动 / 调度）时生成一条 FlowRun 记录。

**核心字段**

- `id`；
- `flow_id`；
- `tenant_id`；
- `trigger_type`：枚举：

  - `MANUAL`：用户手动触发；
  - `SCHEDULE`：调度触发；

- `triggered_by`：触发人（手动时为 TenantUser.id；调度时为系统账号标识）；
- `status`：枚举：

  - `PENDING`：已创建，待执行；
  - `RUNNING`：执行中；
  - `SUCCESS`：全部节点执行成功；
  - `FAILED`：至少有一个节点执行失败；
  - `CANCELLED`：人工取消（本版本不提供取消功能，保留枚举以便扩展）；

- `started_at` / `finished_at`；
- `summary`：运行摘要（如总读取行数 / 写入行数 / 报错节点名称等）。

> 本版本不提供“运行中取消 Flow”的能力，`CANCELLED` 状态保留给后续版本使用。

---

#### 9.2.5 NodeRun（节点运行实例）

**定义**

- 每次 FlowRun 中的每个节点运行生成一条 NodeRun 记录。

**核心字段**

- `id`；
- `flow_run_id`；
- `node_id`；
- `type`：与 Node.type 一致；
- `status`：枚举：

  - `PENDING`；
  - `RUNNING`；
  - `SUCCESS`；
  - `FAILED`；
  - `SKIPPED`（被上游失败阻断，未执行）；

- `started_at` / `finished_at`；
- `input_row_count`：节点实际收到的行数（若上游为多节点 join 输入，可记录 join 前各输入行数在日志中）；
- `output_row_count`：节点输出的行数（对于 TABLE_SINK 节点为成功写入的行数）；
- `error_message`：失败时的错误简要说明（例如 SQL 错误、权限不足等）；
- `extra_info`：扩展 JSON，用于记录执行 SQL 片段、使用的 Join 条件等。

---

### 9.3 模块入口 & 权限前置规则

#### 9.3.1 入口路径

- 前端路由：`/app/:tenantId/flows`
- 进入前必须满足：

  1. 用户已通过身份认证；
  2. 当前租户为 `ACTIVE`；
  3. 当前用户在本租户下存在 TenantUser 记录。

---

#### 9.3.2 Flow 权限模型（资源级）

本版本对 Flow 资源使用单一资源类型 `FLOW`，权限等级枚举：

- `NONE`：无任何权限；
- `VIEW`：查看 Flow 定义与运行记录；
- `RUN`：触发 Flow 运行；
- `EDIT`：修改 Flow 定义（包括节点和连线）；
- `MANAGE`：管理 Flow（编辑 + 删除 + 调度配置 + 权限配置等）。

**权限含义**

- `VIEW`：

  - 允许：

    - 查看 Flow 列表；
    - 打开 Flow 详情和 DAG；
    - 查看运行记录与日志；

  - 不允许：

    - 修改 DAG / 配置；
    - 触发运行；
    - 修改调度配置；
    - 删除 Flow。

- `RUN`：

  - 包含 `VIEW` 能力；
  - 允许：

    - 手动“运行一次”；

  - 不允许：

    - 修改 DAG；
    - 修改调度配置；
    - 删除 Flow。

- `EDIT`：

  - 包含 `RUN` 能力；
  - 允许：

    - 在画布中新增 / 修改 / 删除节点和连线；
    - 修改 Flow 基本信息（名称、描述、所属目录）；

  - 不允许：

    - 删除 Flow；
    - 修改 Flow 权限配置。

- `MANAGE`：

  - 包含 `EDIT` 能力；
  - 额外允许：

    - 配置 / 开关调度；
    - 删除 Flow；
    - 修改 Flow 的 owner；
    - 配置该 Flow 的权限（第 7 章定义）。

---

#### 9.3.3 与表权限的关系

- 在 Flow 的节点中使用表时，要求：

  - 作为源表（TABLE_SOURCE）：

    - 使用者（当前保存/运行 Flow 的用户）对该表拥有 `TABLE_DATA ≥ EDIT` 权限；

  - 作为目标表（TABLE_SINK）：

    - 同样要求 `TABLE_DATA ≥ EDIT`。

- Flow 执行时，不叠加 RowPermission / ColumnPermission：

  - Flow 是面向数据工程师的后端数据处理工具；
  - 一旦用户被授予某表 `TABLE_DATA ≥ EDIT`，即视为有权限在 Flow 中对该表进行全表级操作；
  - 若业务需要在 Flow 中限制数据范围，应通过节点内的过滤条件实现，而不是依赖 RowPermission。

---

### 9.4 Flow 资源树 & 列表

#### 9.4.1 Flow 资源树结构

- 左侧展示 `scope = FLOW` 的资源树：

  - 节点类型：

    - **Folder**：Flow 目录；
    - **Flow**：任务流定义。

- 根节点为“全部任务流”，下挂多层 Folder / Flow。

**Folder 节点**

- 展示：

  - 文件夹图标 + 名称；

- 包含关系：

  - 可以套多级子文件夹。

**Flow 节点**

- 展示：

  - Flow 名称；
  - 可加小图标 / 标签显示调度状态（如“已开启调度”）。

---

#### 9.4.2 资源树权限可见性

- 对某个 Flow：

  - 若用户对该 Flow 的 `FLOW = NONE`：

    - 不在资源树与列表中展示；

  - 若 `FLOW ≥ VIEW`：

    - 在资源树中展示。

- 对 Folder：

  - 若该 Folder 下（递归）不存在任何用户有权限的 Flow：

    - 不展示该 Folder；

  - 否则：

    - 展示该 Folder，即便用户对 Folder 本身没有管理权限（仅作为容器）。

---

#### 9.4.3 Flow 列表区域

- 位于右侧主区域，随资源树选中节点而变化：

  - 选中根 / 某 Folder 时，展示该目录下所有可见 Flow（是否递归展示子目录中的 Flow 由产品统一设定，本版本采用“包含子目录”的策略）。

**列表字段**

| 列名       | 说明                                         |
| ---------- | -------------------------------------------- |
| 任务流名称 | Flow.display_name                            |
| 编码       | Flow.code                                    |
| 所属目录   | Folder 名称链路（可显示为“根 / xxx / yyy”）  |
| 调度状态   | 是否配置了有效 schedule_cron；启用 / 未启用  |
| 最近状态   | 最近一次 FlowRun.status                      |
| 最近运行   | 最近一次运行开始时间                         |
| 负责人     | owner.display_name                           |
| 操作       | 设计 / 运行一次 / 调度配置 / 运行记录 / 删除 |

**操作按钮与权限映射**

- “设计”（打开 DAG 画布）：

  - `FLOW ≥ VIEW` 显示；
  - 打开后是否允许编辑取决于是否 `FLOW ≥ EDIT`。

- “运行一次”：

  - 仅在 `FLOW ≥ RUN` 时可点击；

- “调度配置”：

  - 仅在 `FLOW = MANAGE` 时显示；

- “运行记录”：

  - `FLOW ≥ VIEW` 都可查看；

- “删除”：

  - 仅在 `FLOW = MANAGE` 时显示且可用。

---

#### 9.4.4 筛选、搜索与排序

- 支持按以下条件筛选：

  - 任务流名称 / 编码（模糊搜索）；
  - 调度状态（已开启 / 未开启）；
  - 最近运行状态（成功 / 失败 / 从未运行）；
  - 负责人。

- 排序：

  - 默认按更新时间倒序；
  - 支持按：

    - 名称；
    - 最近运行时间；
    - 最近状态；

  - 支持升序 / 降序切换。

---

#### 9.4.5 新建 / 编辑 / 删除 Flow

- **新建 Flow：**

  - 入口：

    - 资源树根或某 Folder 节点上的“新建任务流”；
    - Flow 列表区域的“新建任务流”按钮；

  - 权限：

    - 需要在目标 Folder 上具备 `FLOW ≥ EDIT` 或专门的“创建 Flow”权限；

  - 新建表单字段：

    | 字段     | 必填 | 说明                                   |
    | -------- | ---- | -------------------------------------- |
    | 名称     | 是   | 1–50 字符                              |
    | 编码     | 否   | 只读，由系统生成（同表编码规则）       |
    | 所属目录 | 否   | 默认当前选中目录，可调整               |
    | 描述     | 否   | 0–200 字符                             |
    | 负责人   | 否   | 默认当前用户，可从本租户用户列表中选择 |
    | 是否启用 | 是   | 默认“启用”；仅影响调度，不影响手动运行 |

- **编辑 Flow 基本信息：**

  - 在 Flow 详情页的“基本信息”区域进行；
  - 需要 `FLOW ≥ EDIT`；
  - 可编辑字段：

    - 名称；
    - 描述；
    - 所属目录；
    - 负责人；
    - 是否启用；

  - 不可编辑字段：

    - 编码（code）；
    - 创建人、创建时间。

- **删除 Flow：**

  - 入口：

    - Flow 列表中“删除”；

  - 权限：

    - 仅 `FLOW = MANAGE`；

  - 删除行为：

    - 删除 Flow 定义与所有节点、连线；
    - 不删除任何业务表与数据；
    - 保留历史 FlowRun / NodeRun 审计记录，不做物理删除。

---

### 9.5 Flow 设计器（DAG 画布）

#### 9.5.1 画布入口与基本行为

- 在 Flow 列表点击“设计”或 Flow 详情中点击“编辑任务流”进入 DAG 画布。

- 画布基本能力：

  - 拖拽放大缩小；
  - 拖拽节点位置；
  - 从左侧节点面板拖拽节点到画布；
  - 节点间连线与删除连线；
  - 保存 / 取消编辑。

- 编辑权限：

  - `FLOW < EDIT`：

    - 画布进入“只读模式”：

      - 节点与连线不可编辑；
      - 不显示“保存”按钮。

  - `FLOW ≥ EDIT`：

    - 画布进入“编辑模式”：

      - 可以新增 / 修改 / 删除节点和连线；
      - 保存时触发完整校验。

---

#### 9.5.2 节点面板（可添加的节点类型）

本版本节点类型固定为：

- 数据源：

  - 表数据源（Table Source）

- 变换：

  - 过滤 / 投影（Filter / Project）
  - Join（关联）
  - 聚合（Aggregate）
  - 计算字段（Calc Field）

- 输出：

  - 表写入（Table Sink）

左侧节点面板展示这些节点的图标 + 名称，用户可拖拽到画布。

---

#### 9.5.3 节点连接规则

- `TABLE_SOURCE` 节点：

  - 不允许有入边；
  - 至少要有一条出边。

- 中间变换节点（FILTER_PROJECT / JOIN / AGGREGATE / CALC_FIELD）：

  - 入边与出边规则：

    - FILTER_PROJECT / AGGREGATE / CALC_FIELD：

      - 入边：**1 条**；
      - 出边：≥0 条；

    - JOIN：

      - 入边：**2 条**，分别标记为左输入与右输入；
      - 出边：≥0 条；

- `TABLE_SINK` 节点：

  - 入边：**1 条**；
  - 不允许有出边。

- 全局 DAG 校验：

  - Flow 内必须至少包含：

    - 1 个 `TABLE_SOURCE`；
    - 1 个 `TABLE_SINK`；

  - 不允许孤立节点（必须在源到汇的路径上）；
  - 不允许环路。

---

#### 9.5.4 节点配置面板

- 点击节点时，在右侧展示配置面板；
- 配置面板内容根据 Node.type 不同而变化；
- 所有配置修改只保存在前端，直到用户点击“保存 Flow”按钮时一起提交；
- 提交前端进行基础校验，后端进行完整校验。

---

### 9.6 节点类型与配置规范

#### 9.6.1 TABLE_SOURCE（表数据源节点）

**用途**

- 从某个业务表中读取数据作为 Flow 的起始数据集。

**配置项**

| 字段               | 必填 | 说明                                                                 |
| ------------------ | ---- | -------------------------------------------------------------------- |
| 节点名称           | 是   | 默认“表数据源\_1”，用户可修改                                        |
| 源表               | 是   | 从当前租户有 `TABLE_DATA ≥ EDIT` 的表列表中选择                      |
| 读取字段           | 否   | 默认读取该表所有字段；可选择子集                                     |
| 过滤条件（Filter） | 否   | 使用 FilterDSL 定义初始过滤条件（与第 4 章 DSL 保持一致）            |
| 排序字段           | 否   | 可选择一个或多个字段进行排序；排序仅影响后续节点处理顺序，不保证稳定 |
| 行数限制（Limit）  | 否   | 限制最大读取行数；为空表示不限制                                     |

**行为**

- 每次 FlowRun 执行到该节点时：

  - 根据“源表 + 读取字段 + FilterDSL + 排序 + Limit”生成查询；
  - 读取数据集作为该节点输出；
  - `input_row_count` 记录为 `NULL`；
  - `output_row_count` 记录为实际读取行数。

**本版本不提供**

- 增量读取模式；
- 基于时间窗口的“仅读取新增数据”。

---

#### 9.6.2 FILTER_PROJECT（过滤 / 投影节点）

**用途**

- 对上游数据集进行行过滤与字段选择。

**配置项**

| 字段     | 必填 | 说明                                         |
| -------- | ---- | -------------------------------------------- |
| 节点名称 | 是   | 默认“过滤\_1”                                |
| 字段选择 | 否   | 默认为上游所有字段；用户可选择需要保留的字段 |
| 过滤条件 | 否   | FilterDSL，基于上游字段定义过滤条件          |

**行为**

- 输入：上游节点输出的数据集；
- 输出：

  - 先按过滤条件筛选行；
  - 再按字段选择保留列；

- `input_row_count` = 上游输出行数；
- `output_row_count` = 过滤后剩余行数。

---

#### 9.6.3 JOIN（关联节点）

**用途**

- 将两个上游数据集按指定条件进行关联。

**输入**

- 必须有两个入边：

  - 左输入；
  - 右输入；

- 在配置面板中明确标记两条入边分别对应左 / 右。

**配置项**

| 字段         | 必填 | 说明                                                                     |
| ------------ | ---- | ------------------------------------------------------------------------ |
| 节点名称     | 是   | 默认“关联\_1”                                                            |
| Join 类型    | 是   | 枚举：INNER JOIN / LEFT JOIN                                             |
| Join 条件    | 是   | 由一组“左字段 = 右字段”的条件构成，至少 1 条                             |
| 输出字段选择 | 否   | 可选择左、右两侧要保留的字段；默认保留左右全部字段，字段名称冲突时重命名 |

> 本版本仅支持 INNER 与 LEFT JOIN，不支持 RIGHT / FULL / CROSS。

**条件推荐（基于关联字段）**

- 当 JOIN 两侧都是 TABLE_SOURCE，或其上游链路最终来自某个具体表时：

  - 系统尝试根据 Modeling 中的“关联字段”（ui_type=关联，ref_table_id/ref_field_id）推断 Join 条件；
  - 若推断成功：

    - 在配置面板中自动填入推荐条件；
    - 用户可以增删修改条件。

**行为**

- 输入：

  - 左输入数据集；
  - 右输入数据集；

- 输出：

  - 按 Join 类型和条件生成结果数据集；

- `input_row_count`：

  - 可记录为 `{left: x, right: y}`（写入 extra_info）；

- `output_row_count`：

  - 记录为 Join 结果行数。

---

#### 9.6.4 AGGREGATE（聚合节点）

**用途**

- 对上游数据集进行分组与聚合，生成聚合结果。

**配置项**

| 字段              | 必填 | 说明                                            |
| ----------------- | ---- | ----------------------------------------------- |
| 节点名称          | 是   | 默认“聚合\_1”                                   |
| 分组字段（Group） | 否   | 可选择 0 个或多个字段；0 个表示全表聚合         |
| 聚合字段配置      | 是   | 至少 1 项：指定目标字段名 + 聚合函数 + 输入字段 |

**聚合函数支持**

- 本版本支持以下聚合函数（与 DSL 一致）：

  - `COUNT`；
  - `SUM`；
  - `AVG`；
  - `MIN`；
  - `MAX`。

**行为**

- 输入：上游数据集；
- 输出：

  - 以分组字段为键，对指定字段执行聚合函数，生成新的数据集；

- `input_row_count` = 上游行数；
- `output_row_count` = 聚合后行数（分组数）。

---

#### 9.6.5 CALC_FIELD（计算字段节点）

**用途**

- 在现有字段基础上增加一个或多个“计算字段”。

**配置项**

| 字段         | 必填 | 说明                                          |
| ------------ | ---- | --------------------------------------------- |
| 节点名称     | 是   | 默认“计算字段\_1”                             |
| 计算字段列表 | 是   | 至少 1 个，每项包含：字段名、数据类型、表达式 |

- 每个计算字段配置项包括：

  - `字段名`：新字段名称；
  - `数据类型`：文本 / 整数 / 小数 / 日期 / 日期时间 / 布尔；
  - `表达式`：基于 DSL 的列表达式，可使用上游字段与常量，支持算术运算与常见函数（与第 4 章保持一致）。

**行为**

- 输入：上游数据集；
- 输出：

  - 在上游字段基础上增加配置中定义的新字段；

- 若表达式计算失败（例如除零、类型不匹配）：

  - 节点整体标记为 FAILED；
  - `error_message` 中记录具体错误；
  - 本版本不提供“跳过错误行”的部分成功模式。

---

#### 9.6.6 TABLE_SINK（表写入节点）

**用途**

- 将上游数据集写入某个业务表。

**配置项**

| 字段     | 必填 | 说明                                                             |
| -------- | ---- | ---------------------------------------------------------------- |
| 节点名称 | 是   | 默认“写入表\_1”                                                  |
| 目标表   | 是   | 当前租户内用户有 `TABLE_DATA ≥ EDIT` 权限的表                    |
| 写入模式 | 是   | 枚举：`APPEND`（追加） / `TRUNCATE_INSERT`（清空后重写）         |
| 字段映射 | 是   | 将上游字段映射到目标表字段，至少覆盖目标表中所有非系统且必填字段 |

**字段映射规则**

- 系统自动尝试按字段名对齐：

  - 上游字段名与目标表字段 code 相同则自动映射；

- 用户可在配置面板中调整映射：

  - 显式选择上游字段 → 目标字段；

- 必填字段处理：

  - 目标表字段 `is_required = true` 且非系统字段：

    - 必须提供映射或配置固定常量；

  - 系统字段（id / created_at 等）：

    - 不允许映射；
    - 由系统自动填充。

**写入模式语义**

- `APPEND`：

  - 每次运行在目标表末尾追加新记录；
  - 不做重复检查，本版本不提供 Upsert；
  - 数据重复控制由上游逻辑和业务流程保证。

- `TRUNCATE_INSERT`：

  - 在一次 FlowRun 中：

    1. 先清空目标表所有业务数据（不删除表结构）；
    2. 再写入本次运行生成的数据；

  - 若写入过程出错：

    - 该节点标记为 FAILED；
    - 已写入的数据视为整体失败，由事务回滚（由技术实现保证）；
    - 目标表数据回退到本次运行前的状态。

**行为**

- 输入：上游数据集；
- 输出：无（终点节点）；
- `input_row_count` = 上游行数；
- `output_row_count` = 实际成功写入的行数。

---

### 9.7 Flow 执行与调度

#### 9.7.1 Flow 运行前校验

在用户点击“保存 Flow”或触发运行前，系统必须对 Flow 做以下校验：

1. DAG 结构校验：

   - 无孤立节点，至少存在一个完整的“源 → 汇”路径；
   - 无环路。

2. 节点配置校验：

   - 每个节点的必填配置项均已填；
   - 关联节点（JOIN）有两个有效上游；
   - TABLE_SINK 节点有有效字段映射且覆盖所有必填字段。

3. 权限校验：

   - 所有使用到的源/目标表：

     - 对当前用户都必须满足 `TABLE_DATA ≥ EDIT`。

校验失败时：

- 拦截保存 / 运行；
- 将错误列表返回给前端；
- 前端在对应节点、对应字段上展示错误提示。

---

#### 9.7.2 运行触发方式

本版本支持两种触发方式：

1. **手动运行一次（Manual Run）**

   - 在 Flow 列表行操作中点击“运行一次”，或在 Flow 详情页中点击“运行一次”；
   - 需要 `FLOW ≥ RUN`；
   - 与 `enabled` 状态无关：即便 Flow 关闭调度，也允许手动运行。

2. **调度运行（Schedule Run）**

   - Flow 配置了有效的 `schedule_cron` 且 `enabled = true` 时，调度器按 cron 触发运行；
   - 调度运行由系统内部触发，`trigger_type = SCHEDULE`，`triggered_by` 记录为系统账号。

本版本不提供：

- API 触发；
- 事件驱动触发（如表变更自动触发）。

---

#### 9.7.3 调度配置（Schedule）

**入口**

- Flow 列表中“调度配置”按钮；
- Flow 详情页中的“调度设置”区域。

**权限**

- 仅 `FLOW = MANAGE` 时允许修改调度配置。

**配置项**

| 字段         | 必填 | 说明                                                   |
| ------------ | ---- | ------------------------------------------------------ |
| 是否启用调度 | 是   | 开启后调度器按照 cron 执行；关闭时仅保留配置           |
| Cron 表达式  | 否   | 标准 5 段 CRON（分、时、日、月、周），为空则不进行调度 |
| 时区         | 是   | 默认租户时区，可选择 IANA 时区（如 Asia/Tokyo）        |

**Cron 配置方式**

- UI 提供两种方式：

  - 常用规则选择：

    - 每小时；
    - 每天某时；
    - 每周某天某时；
    - 每月某日某时；

  - 高级模式：

    - 允许用户直接输入标准 CRON 表达式。

**错过执行的处理**

- 如果调度触发时间点系统处于不可用状态导致执行被错过：

  - 系统不会自动补执行；
  - 调度器恢复后从下一个 cron 时间点开始正常触发；
  - 如需要补跑，由用户手动“运行一次”。

---

#### 9.7.4 运行并发控制

- 对同一个 Flow：

  - 同一时间只允许存在 **1 个 RUNNING 状态的 FlowRun**；
  - 行为：

    - 若上一次运行仍在 RUNNING 状态：

      - 再次手动触发：

        - 直接返回错误：“该任务流已有实例正在运行”；

      - 到达调度触发时间：

        - 记录一条“本次调度被跳过”的日志，不新建 FlowRun。

- 对不同 Flow：

  - 运行实例之间不做互斥控制，可并行运行。

---

#### 9.7.5 节点执行顺序与并行

- 执行引擎对 DAG 做拓扑排序：

  - 保证每个节点在其所有上游节点成功后才开始执行；
  - 对于没有依赖关系的多个节点，本版本允许并行执行或串行执行：

    - 执行顺序不会影响最终结果。

- 节点失败：

  - 若某节点执行 FAILED：

    - 其所有下游节点标记为 SKIPPED；
    - FlowRun 整体状态标记为 FAILED；
    - 不继续执行该节点的下游。

---

### 9.8 运行监控与日志

#### 9.8.1 Flow 运行记录列表

**入口**

- Flow 列表中“运行记录”按钮；
- Flow 详情页中的“运行记录”Tab。

**列表字段**

| 列名     | 说明                               |
| -------- | ---------------------------------- |
| 运行 ID  | FlowRun.id（可截断展示）           |
| 触发方式 | MANUAL / SCHEDULE                  |
| 触发人   | 用户名（调度触发显示为系统账号名） |
| 状态     | SUCCESS / FAILED / RUNNING / …     |
| 开始时间 | started_at                         |
| 结束时间 | finished_at                        |
| 耗时     | 自动计算（结束时间 - 开始时间）    |
| 摘要     | summary                            |

支持按时间范围、状态、触发方式筛选，按时间排序。

---

#### 9.8.2 FlowRun 详情页

**内容**

1. **基本信息区域**

   - Flow 名称；
   - FlowRun 状态；
   - 触发方式与触发人；
   - 开始时间 / 结束时间 / 耗时；
   - Flow 描述。

2. **节点运行列表或 DAG 着色视图**

   - 在 DAG 画布上以不同颜色表示各节点运行状态：

     - 绿色：SUCCESS；
     - 红色：FAILED；
     - 灰色：SKIPPED；
     - 黄色：RUNNING（若在执行过程中查看）。

   - 或使用表格展示节点运行信息（两者可同时存在）。

3. **节点运行信息**

   每个节点显示：

   - 节点名称；
   - 节点类型；
   - 状态；
   - 开始时间 / 结束时间 / 耗时；
   - 输入 / 输出行数；
   - 错误信息（若有）；
   - 展开后可查看 extra_info 中的详情，如：

     - 生成的 SQL 片段；
     - Join 条件配置；
     - 聚合规则等。

---

### 9.9 Flow 权限与安全性细则

#### 9.9.1 Flow 操作权限

- Flow 列表可见性：

  - 仅展示 `FLOW ≥ VIEW` 的 Flow。

- 设计 / 查看画布：

  - `FLOW ≥ VIEW`；
  - 只有 `FLOW ≥ EDIT` 才能修改。

- 运行一次：

  - `FLOW ≥ RUN`。

- 调度配置：

  - `FLOW = MANAGE`。

- 删除 Flow：

  - `FLOW = MANAGE`。

---

#### 9.9.2 与表权限的安全约束

- 在 Flow 内使用某表作为数据源或写入目标时：

  - 保存 Flow 时，要求当前用户对该表 `TABLE_DATA ≥ EDIT`；
  - 运行 Flow 时：

    - 系统再次检查，用于防止运行期间权限变更：

      - 若当前触发人对任意使用到的表 `TABLE_DATA < EDIT`，则本次运行直接失败；
      - FlowRun 状态为 FAILED，错误信息中指出具体表名。

- Flow 执行过程中读取和写入的数据范围：

  - 仅受节点配置的过滤条件和写入模式控制；
  - 不叠加 RowPermission / ColumnPermission，用于避免结果不可预测。

---

### 9.10 任务流操作审计

#### 9.10.1 审计范围

需要记录的 Flow 相关审计事件包括：

1. Flow 定义变更：

   - 创建 Flow；
   - 编辑 Flow 基本信息；
   - 编辑 DAG（新增 / 删除 / 修改节点，新增 / 删除连线）；
   - 删除 Flow；
   - 修改调度配置；
   - 修改 Flow 权限配置。

2. Flow 运行行为：

   - 手动触发运行；
   - 调度触发运行；
   - 运行成功 / 失败；
   - 因已有运行实例而被拒绝触发；
   - 调度触发被跳过（上一次还在运行）。

---

#### 9.10.2 审计记录字段

每条审计记录包含至少：

- 操作人：

  - TenantUser.id；
  - GlobalUser.id；
  - 显示名；

- 操作时间；
- 操作类型（枚举），例如：

  - `CREATE_FLOW`；
  - `UPDATE_FLOW_BASIC`；
  - `UPDATE_FLOW_GRAPH`；
  - `DELETE_FLOW`；
  - `UPDATE_FLOW_SCHEDULE`；
  - `RUN_FLOW_MANUAL`；
  - `RUN_FLOW_SCHEDULE`；
  - `RUN_FLOW_FINISH_SUCCESS`；
  - `RUN_FLOW_FINISH_FAILED`；

- 操作对象：

  - Flow.id / Flow.code；
  - FlowRun.id（若为运行相关事件）；

- 变更内容（对于编辑类事件）：

  - 记录变更前后值（如“schedule_cron from '0 3 \* \* \*' to ''”）；

- 结果：

  - 成功 / 失败；
  - 失败时的失败理由摘要。

---

### 9.11 本版本范围总结

本章节定义的内容即为本版本任务流模块的完整范围：

- **明确包含：**

  - Flow 的创建 / 编辑 / 删除 / 调度配置；
  - DAG 画布编辑（TABLE_SOURCE / FILTER_PROJECT / JOIN / AGGREGATE / CALC_FIELD / TABLE_SINK 六类节点）；
  - 基于表的批处理流程；
  - 手动运行与 CRON 调度运行；
  - 单实例并发控制；
  - 运行记录与节点级日志；
  - Flow 权限（VIEW / RUN / EDIT / MANAGE）与表权限联动；
  - Flow 相关操作审计。

- **明确不包含：**

  - 文件数据源；
  - API / 事件触发；
  - 增量读取 / CDC；
  - Upsert / 合并写入；
  - 实时流式处理；
  - Flow 版本管理；
  - 运行中取消任务。

以上作为第九章“任务流模块（Flows）”的完整 PRD 说明。
