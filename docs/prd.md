## 0. 文档说明

### 0.1 文档目的与读者

**文档目的**

本文件是《多租户配置化数据建模与报表平台》（以下简称“本平台”）的**产品需求文档（PRD）**，用于在产品、技术、设计、测试及运维之间建立统一的需求共识，指导 V1.0 的设计与实现。

本平台主要提供以下能力：

* 多租户架构：同一平台服务多个租户，数据逻辑隔离；
* 配置化建模：业务人员可通过 UI 配置数据表结构，而无需直接写 SQL；
* 任务流（ETL）：通过可视化 DAG 抽取 / 转换 / 写入数据；
* 数据集 & 看板：基于数据集配置图表/指标卡/表格，实现自助分析；
* 权限 & 审计：支持租户内角色体系、资源级权限、行/列权限及关键操作审计；
* LLM 辅助：利用本地 LLM 自动生成表/字段编码，降低命名成本、提升一致性。

**适用读者**

* **产品经理**：需求域和边界的定义、迭代规划参考；
* **后端研发**：数据模型、接口设计、权限体系、DSL 约束等；
* **前端研发**：界面结构、交互流程、错误提示规范等；
* **测试工程师**：测试用例设计、边界场景识别；
* **运维 / 平台管理员**：多租户管理、租户停用影响、监控与告警关注点；
* **业务方 / 实施顾问**：理解平台能力与限制，规划落地方案。

> 备注：本文档优先描述“产品视角下的行为与约束”，技术实现细节（如具体 SQL、框架代码结构）由技术设计文档补充。

---

### 0.2 术语约定（英文缩写说明）

为避免歧义，本文档中使用的关键术语和缩写约定如下：

#### 平台与租户相关

* **平台（Platform）**：指本系统整体（包括平台后台与各租户工作区）。
* **GlobalUser / 平台用户**：在整个平台范围内唯一的用户账号。
* **Tenant / 租户**：一个公司、部门或项目空间，是数据与配置隔离的单位。
* **TenantUser / 租户用户**：GlobalUser 与某个 Tenant 的关联关系，是“在该租户下的用户身份”。

#### 权限与资源

* **Role / 角色**：租户内部定义的权限集合，如“数据工程师”、“分析师”。
* **Resource / 资源**：可授权的实体，如表、任务流、看板。
* **ResourceTree / 资源树**：用于展示和管理资源层级结构的逻辑树，按 scope 分类：

  * `scope=TABLE`：表资源树；
  * `scope=FLOW`：任务流资源树；
  * `scope=BOARD`：看板资源树。
* **RolePermission / 角色资源权限**：某角色对某资源（或目录）的权限配置。
* **RowPermission / 行权限**：基于统一 DSL 定义的某角色在某表上的行级访问过滤规则。
* **ColumnPermission / 列权限**：某角色在某表各字段的列级权限（隐藏/只读/可写）。

#### 数据建模 & 流程

* **Table / 表**：租户内部的业务数据表，由建模模块创建和维护。
* **Field / 字段**：表中的列，具有编码、名称、类型等属性。
* **Relation / 关系**：表之间的逻辑关联（如订单表与用户表的一对多关系）。
* **Flow / 任务流**：ETL 工作流，由多个节点组成的有向无环图。
* **Node / 节点**：Flow 中的处理单元，如 Source / Transform / Sink。
* **Run / 运行实例**：某次 Flow 实际执行记录。
* **Schedule / 调度**：对 Flow 进行周期性执行的配置（Cron 等）。
* **Dataset / 数据集**：基于某张表（或视图）的可复用数据视图，带有基础过滤条件。
* **Board / 看板**：由多个 Widget 组成的数据可视化页面。
* **Widget / 组件**：看板上的最小可视化单元，如指标卡、图表、表格。

#### 技术相关（仅作产品层面说明）

* **API**：后端提供的 HTTP 接口。
* **DSL（Domain Specific Language）**：统一过滤条件 JSON 结构，描述查询条件。
* **LLM（Large Language Model）**：大语言模型，本期使用本地 `ollama` 实例。
* **ETL（Extract-Transform-Load）**：数据抽取、转换、写入流程。

文中如无特别说明：

* “用户”在租户前台语境下，通常指 TenantUser；
* “平台管理员”特指 Platform Admin 角色；
* “行权限”、“列权限”、“资源权限”的详细行为见后续章节。

---

### 0.3 版本历史与评审记录

> 实际项目中建议维护为可更新表格，这里给出 V1.0 初始版本示例。

| 版本号 | 日期         | 作者     | 变更内容                   | 评审人                 | 备注        |
| --- | ---------- | ------ | ---------------------- | ------------------- | --------- |
| 0.1 | 2025-12-10 | PM XXX | 初版：整理文档结构 & 产品概述、角色与概念 | Tech Lead / FE / BE | 仅覆盖章节 0–3 |
| 0.9 | TBD        | PM XXX | 补充 DSL、权限模型、各模块详细交互    | 同上                  | 用于开发前最终评审 |
| 1.0 | TBD        | PM XXX | 根据评审意见修订后冻结，作为 V1.0 基线 | 全体干系人               | 对应上线版本    |

评审方式建议：

* 每个大章节（如“权限模型”、“任务流模块”）单独组织评审；
* 重大行为变更（如权限含义、软删除策略）需在版本记录中显式标记。

---

## 1. 产品概述（Overview）

### 1.1 背景 & 痛点

**业务背景**

在中大型企业中，业务数据来源复杂（广告投放平台、游戏日志、CRM、财务系统等），常见现状：

* 各业务线分别找数据开发写脚本、建临时表，无统一平台；
* 报表依赖数据开发 / BI 工程师，需求响应慢，业务自助分析能力弱；
* 权限粗放：要么全公司都能看，要么只能通过导出 Excel 人工分发；
* 多项目/多品牌同时运营时，不同项目数据逻辑不能很好隔离。

**现有痛点**

1. **建模成本高**

   * 业务字段多且变化快，每次变更都需要数据工程师介入。
   * 业务方很难从“字段/表结构”视角理解数据，只看得懂报表。

2. **ETL 开发门槛高**

   * 抽数逻辑散落在各种脚本、 Airflow 任务或数据工程师个人电脑中。
   * 缺乏可视化运维：失败重跑、监控、依赖排查都不直观。

3. **报表与权限管理混乱**

   * 报表使用 Excel / 各类 BI 工具散落各处，版本不统一。
   * 行/列级权限很难实现，往往通过“复制多份报表”硬编码权限。

4. **多租户 / 多项目场景下复用困难**

   * 同一套指标逻辑，需要在多个项目间复制；
   * 无法在一个统一平台下服务多个租户（集团、客户），部署成本高。

本平台希望通过**多租户 + 配置化建模 + 可视化任务流 + 看板**的组合模式，解决以上痛点。

---

### 1.2 产品定位 & 价值主张

**产品定位**

> 一款面向企业内部或 SaaS 场景的「多租户配置化数据建模与报表平台」，在统一平台上为多个组织/项目提供数据建模、ETL、权限控制和可视化看板能力。

可作为：

* 企业内部数据中台 / 营销数据平台的“上层工具”；
* SaaS 产品中，为不同客户提供可定制看板的“配置型分析平台”；
* 小团队/部门级的数据仓库 + 轻量 BI 一体化解决方案。

**价值主张（对不同角色）**

* **对业务方 / 分析师**

  * 通过 Dataset + Board 自助搭建看板，无需找开发；
  * 业务术语友好（字段显示名称、预设数据集）。

* **对数据工程师**

  * 用可视化 Flow 管理 ETL，不再散落脚本；
  * 多租户复用同一套 ETL 模板 & 表结构；
  * 精细权限 & 审计帮助控制风险。

* **对平台 / IT 管理者**

  * 单一平台服务多个租户，统一维护与监控；
  * 可通过 Plan 控制不同租户的功能与容量；
  * 租户停用与资源回收策略可控。

---

### 1.3 与竞品 / 现有方案的对比

对比对象主要包括：

1. 传统 BI 工具（如 Tableau / Power BI 等）；
2. 传统数仓 / 数据库（如 MySQL + 手写 SQL / 脚本）；
3. 自研脚本 + Airflow 等通用调度工具。

**1）与传统 BI 工具对比**

| 维度     | 传统 BI 工具         | 本平台                    |
| ------ | ---------------- | ---------------------- |
| 数据建模   | 依赖 IT，通常在数仓中完成   | 平台内提供配置化建模模块，可由数据工程师完成 |
| ETL 能力 | 通常弱（依赖外部 ETL 工具） | 内置可视化任务流，实现完整 ETL      |
| 多租户能力  | 一般为“单租户 + 多项目”   | 原生多租户，租户间逻辑隔离          |
| 行/列级权限 | 依赖数据源或复杂配置       | 平台内统一行/列级权限 DSL        |
| LLM 辅助 | 通常为报表层自然语言问答     | 重点用于建模命名/编码，提高模型一致性    |

**2）与传统数仓（数据库 + 脚本）对比**

| 维度     | 传统数仓脚本方案            | 本平台                       |
| ------ | ------------------- | ------------------------- |
| 建模方式   | DBA/工程师手写 DDL       | Web UI 配置字段，自动生成物理表       |
| ETL 管理 | 脚本分散、缺乏拓扑视图         | Flow DAG 统一管理，Run 记录可视    |
| 运维难度   | 日志分析复杂，任务失败排查困难     | Run 详情、节点级日志，错误信息面向产品场景设计 |
| 权限模型   | 依赖数据库权限，粒度粗、难以对接前端  | 行/列/资源三级权限体系，前后端统一        |
| 多租户支持  | 需自行设计 schema 或数据库隔离 | 平台内置 tenant_id 体系及租户空间    |

**3）与 Airflow 等调度平台对比**

| 维度       | Airflow 等通用调度平台            | 本平台                            |
| -------- | -------------------------- | ------------------------------ |
| 定位       | 通用工作流调度                    | 面向数据建模 + 报表的场景化平台              |
| 任务定义方式   | Python DAG / 代码            | Web UI 拖拽节点配置（HTTP/MySQL/内部表等） |
| 权限 & 多租户 | 需另行设计                      | 平台内置多租户 + 行/列/资源权限模型           |
| 使用门槛     | 需要工程师具备 Python & DevOps 能力 | 面向数据工程师 & 分析师，降低脚本依赖           |

---

### 1.4 目标用户 & Persona

**1）平台管理员（Platform Admin）**

* 背景：IT 运维 / 平台团队成员，熟悉基础设施与账号体系；
* 目标：

  * 创建/管理租户；
  * 管控平台级用户（GlobalUser）；
  * 监控租户健康状态（调度任务数量、失败情况等）；
* 典型行为：

  * 新建租户，为租户指定套餐 Plan；
  * 查看某租户成员列表，协助排查登陆问题；
  * 在租户欠费或违规时暂停该租户。

**2）租户 Owner**

* 背景：部门负责人 / 项目负责人，对业务整体负责；
* 目标：

  * 管理本租户成员与角色；
  * 决定谁可以建模、谁可以看报表；
* 典型行为：

  * 邀请新成员加入租户，分配角色（数据工程师/分析师/查看者）；
  * 调整某人权限（例如从“分析师”降为“只读观众”）；
  * 查看权限变更审计记录。

**3）租户数据工程师 / 建模者**

* 背景：熟悉数据库和 ETL，有一定脚本基础；
* 目标：

  * 建立并维护租户的核心数据模型（订单、用户、活动等）；
  * 配置 Flow，从多种数据源抽取数据到平台内表；
* 典型行为：

  * 在 Modeling 中创建订单表、用户表、充值表；
  * 配置从外部 MySQL 抽数的 Flow；
  * 调试 Flow，查看 Run 详情，定位失败节点；
  * 为表配置行/列权限规则。

**4）租户分析师（Analyst）**

* 背景：数据分析师 / 运营人员，会写简单 SQL 或主要使用 BI 工具；
* 目标：

  * 使用 Dataset & Board 进行自助分析；
  * 定期查看看板，辅助业务决策；
* 典型行为：

  * 基于订单表创建“收入分析”数据集；
  * 在看板上配置折线图、柱状图和指标卡；
  * 保存看板并分享给团队成员查看。

**5）租户普通查看者（Viewer）**

* 背景：业务人员、管理者，只需要“看结果”；
* 目标：

  * 及时查看关键指标、日报/周报看板；
* 典型行为：

  * 打开自己有权限的看板；
  * 导出图表数据或截图，用于会议。

---

### 1.5 使用典型场景（End-to-End 示例）

**场景 A：游戏项目的运营数据看板（完整链路：建模 → ETL → 看板）**

1. **建模**

   * 数据工程师在 Modeling 中创建：

     * `user` 用户表；
     * `order` 订单表（含 user_id、amount、pay_time 等）；
   * 使用 LLM 自动生成表/字段编码，规范命名。

2. **ETL（Flow）**

   * 新建 Flow「从日志库导入订单数据」：

     * Source：外部 MySQL（游戏日志库）执行 SELECT；
     * Transform：字段选择与重命名，计算字段（如真实金额、折扣）；
     * Sink：写入内部 `order` 表（TRUNCATE_INSERT，每晚全量覆盖）。
   * 配置调度：每日 3:00 运行一次。

3. **行/列权限**

   * 对 `order` 表配置：

     * 行权限：仅允许查看自己负责的区服数据（基于 server_id 过滤）；
     * 列权限：隐藏用户手机号等敏感字段。

4. **Dataset & Board**

   * 分析师新建数据集「订单收入数据集」，包含订单金额、日期、区服等；
   * 基于该数据集配置「收入总览看板」，包括：

     * 日收入趋势折线图；
     * 区服对比柱状图；
     * 总收入指标卡。

5. **日常使用**

   * 运营人员每天早上打开看板，查看昨日收入与目标差异；
   * 若数据异常，通过查看 Flow Run 确认 ETL 是否成功。

**场景 B：广告投放效果分析（多数据源 + 行权限）**

1. Modeling 中创建：`campaign`（广告计划）、`campaign_stats`（投放效果）表；
2. Flow 从多个广告平台的 HTTP API 抽取数据，统一写入 `campaign_stats`；
3. 行权限规则：

   * 广告投放团队成员只能看到自己负责的广告主数据（基于 `owner_id` 或 `department`）；
4. 分析师创建数据集「投放效果数据集」，配置看板：

   * 查看各广告主的消耗、转化率、ROI；
   * 对不同行业做分组分析。

**场景 C：SaaS 模式下的多租户报表服务**

1. 平台管理员为每个外部客户创建一个 Tenant；
2. 为每个 Tenant 配置 Owner，并让其自行管理成员；
3. 数据工程师在每个 Tenant 下复用类似的数据模型和 Flow；
4. 每个客户只能看到自己租户下的数据和看板，彼此隔离。

---

### 1.6 范围说明（本期 Scope / Out-of-Scope）

**V1.0 范围内（In Scope）**

* 多租户架构 & 平台后台

  * GlobalUser / Tenant / TenantUser 管理；
  * 租户停用后禁止访问、停止调度。

* 租户工作区基础框架

  * 租户选择与切换；
  * Modeling / Flows / Boards / Settings 四大模块导航。

* 建模模块（Modeling）

  * 表资源树（文件夹 + 表）；
  * 表结构管理（字段增删改，类型有限子集，不支持在线变更字段类型）；
  * 表数据的基础 CRUD（分页查询、过滤、编辑、删除）；
  * 关系（Relation）基础管理。

* 任务流模块（Flows）

  * Flow 资源树（文件夹 + Flow）；
  * DAG 画布，节点类型包括：

    * Source：HTTP / MySQL / 文件；
    * Transform：字段选择/重命名、过滤、聚合、Join、计算字段；
    * Sink：写入内部表 / 写入 HTTP API；
  * 调度（CRON / 手动触发）、Run 记录与详情。

* 数据集 & 看板模块（Datasets & Boards）

  * Dataset 的创建 / 编辑 / 删除，绑定单表；
  * Board 资源树（文件夹 + 看板）；
  * Widget 类型：指标卡 / 折线 / 柱状 / 饼图 / 表格；
  * Widget 查询配置（维度、指标、过滤、排序、分页）。

* 权限与 DSL（基础能力）

  * 统一过滤 JSON DSL 的语法定义；
  * 资源级权限（表结构 / 表数据 / Flow / Board）；
  * 行权限 / 列权限配置及在数据查询/展示时的应用。

* LLM 辅助（表/字段编码生成）

**V1.0 暂不支持（Out-of-Scope）**

* 字段类型在线变更（例如从 string → int 的自动迁移）；
* 跨租户的数据联邦查询；
* 数据血缘可视化（字段级 lineage）；
* 通知中心 / 消息中心（任务失败推送到 IM 等）；
* 多语言 UI 国际化（V1 默认为简体中文）。

上述 Out-of-Scope 功能在后续版本中可以规划，但**本期开发与测试不需覆盖**。

---

### 1.7 成功指标（业务指标 + 使用指标）

**业务层面指标（由业务团队评估）**

* 在目标时间内（如 6 个月）上线的租户数量：

  * 目标：≥ N 个内部项目租户 / M 个外部客户租户。
* 人力节省：

  * 数据报表相关需求中，≥ X% 可由业务方自助完成，无需研发介入。

**产品使用指标（平台可直接统计）**

* 日/周/月活跃租户数（有登录行为或运行 Flow / 打开看板）；
* 日/周/月活跃用户数（按 TenantUser）；
* 任务流运行情况：

  * 每日 Flow Run 成功率 ≥ 99%；
  * 单个 Flow 的平均运行耗时（用于优化 ETL 逻辑）。
* 看板使用情况：

  * 平均每个租户的看板数；
  * 看板打开次数（识别核心看板）。

**质量与稳定性指标**

* 关键操作错误率（“看板加载失败”、“Flow 配置错误”等）低于一定阈值；
* 权限相关 bug 严重程度高，需重点关注：

  * 不允许出现“未授权用户看到敏感数据”的情况；
  * 不允许出现“合法用户完全无法访问自己应有资源”的情况。

---

## 2. 系统角色与访问边界

### 2.1 顶层架构视角

系统从产品层面分为两个主要工作空间：

1. **平台后台（Platform Admin Console）**

   * 面向平台管理员；
   * 功能：

     * GlobalUser 管理；
     * Tenant 管理（创建、停用、查看计划）；
     * 平台级审计（可选、后续扩展）。

2. **租户工作区（Tenant Workspace）**

   * 面向租户 Owner、数据工程师、分析师、查看者等；
   * 每个租户拥有逻辑上独立的工作区：

     * 建模模块（Modeling）；
     * 任务流模块（Flows）；
     * 数据集 & 看板模块（Datasets & Boards）；
     * 租户设置模块（Tenant Settings：用户、角色、权限）。

**访问关系：**

* 平台管理员通过 Platform Admin Console 可查看所有 Tenant 基本信息，但**不直接访问租户业务数据**；
* 租户内用户只能访问自己有权限的租户工作区，无法看到其他租户；
* 同一 GlobalUser 可以加入多个 Tenant，在不同租户之间切换视角。

---

### 2.2 用户角色定义

> 下述角色为**系统内置角色**建议，具体权限映射将在后续“权限模型”章节详述。

#### 2.2.1 平台管理员（Platform Admin）

* 所在空间：平台后台；
* 职责：

  * 管理平台级用户（GlobalUser）；
  * 管理租户（创建、修改、停用）；
  * 查看租户基本运行情况（如 Flow 数量、失败率等汇总）。
* **不**直接参与租户内部建模、Flow、看板配置。

#### 2.2.2 租户 Owner

* 所在空间：租户工作区（某个 Tenant 内）；
* 特点：

  * 每个 Tenant 至少 1 个 Owner，可配置多个；
* 职责：

  * 租户用户管理（添加/移除成员、分配角色）；
  * 角色与权限配置（包括行/列权限）；
  * 对权限变更与数据泄露风险负责。

#### 2.2.3 租户数据工程师 / 建模者（Data Engineer）

* 职责：

  * 负责建模模块：创建/修改表与字段；
  * 负责 ETL 任务流的配置、调试与运维；
  * 参与行/列权限设计（与 Owner 协作）。

#### 2.2.4 租户分析师（Analyst）

* 职责：

  * 消费已有数据模型与 Dataset；
  * 创建/编辑看板与 Widget；
  * 不直接修改底层表结构与 Flow 配置。

#### 2.2.5 租户普通查看者（Viewer）

* 职责：

  * 查看自己有权限的看板 / 数据集结果；
  * 不创建/编辑任何模型或看板。

> 说明：实际实现中，这些角色会映射到具体的 Role 配置组合，是系统内置的若干 Role 记录，其权限不可删除但可由平台/产品调整默认策略。

---

### 2.3 角色与模块访问矩阵

下表为**默认内置角色**与各模块的访问能力（租户工作区）：

| 模块 / 能力             | Owner    | Data Engineer | Analyst  | Viewer   |
| ------------------- | -------- | ------------- | -------- | -------- |
| 租户设置：用户管理           | 管理（增删改）  | 无             | 无        | 无        |
| 租户设置：角色管理           | 管理（增删改）  | 只读            | 无        | 无        |
| 租户设置：资源权限配置         | 管理（增删改）  | 建议只读          | 无        | 无        |
| 租户设置：行/列权限配置        | 管理（增删改）  | 建议可编辑/协作      | 无        | 无        |
| Modeling：表资源树       | 全部可见/可管理 | 可见/可管理有权限表    | 只读（可选）   | 只读（可选）   |
| Modeling：表结构（字段增删改） | 管理       | 管理            | 无        | 无        |
| Modeling：表数据 CRUD   | 管理       | 编辑/查看         | 视权限可查看   | 部分只读     |
| Modeling：关系管理       | 管理       | 管理            | 只读       | 无        |
| Flows：资源树 & 列表      | 管理       | 管理            | 只读       | 只读（可选）   |
| Flows：配置 & 保存       | 管理       | 管理            | 无        | 无        |
| Flows：手动运行          | 管理       | 管理            | 只读查看 Run | 只读查看 Run |
| Flows：调度配置          | 管理       | 管理（可选）        | 无        | 无        |
| Datasets：管理         | 管理       | 管理（可选）        | 管理       | 只读       |
| Boards：管理（创建/编辑/删除） | 管理       | 管理（可选）        | 管理       | 只读       |
| Boards：查看           | 全部       | 全部            | 全部       | 仅授权看板    |

> 说明：
>
> * 上表描述的是**预置角色的默认权限范围**，真正的权限粒度由资源级权限/行权限/列权限决定；
> * 出于安全考虑：**行/列权限配置**的实际操作建议仅开放给 Owner 和少数 Data Engineer。

---

### 2.4 多租户隔离边界

为保证不同租户间数据安全与逻辑隔离，统一定义如下边界：

1. **数据隔离原则**

   * 所有与业务数据相关的表（包括 meta 表和实际数据表）必须包含 `tenant_id` 字段；
   * 所有后端查询/修改逻辑必须在 WHERE 条件中包含 `tenant_id = 当前租户`；
   * 不允许出现跨租户的 JOIN 查询或写入操作（即使在同一数据库实例中）。

2. **访问路径隔离**

   * 前端访问租户工作区时，URL 中包含 `:tenantId`（或等价标识）；
   * 后端根据用户当前租户上下文 + token 进行双重校验：

     * 用户是否属于该租户（TenantUser 存在且 ACTIVE）；
     * 租户是否处于 ACTIVE 状态。

3. **平台管理员访问限制**

   * 平台 Admin 在平台后台可查看租户的**元信息**（如名称、状态、Plan）；
   * 默认情况下，平台 Admin **不通过前台身份直接查看某租户业务数据**；
   * 如有特殊需求（如运维排查），需通过专门接口与审计记录实现。

4. **跨租户复用能力（仅配置级）**

   * V1.0 不支持“跨租户的数据共享”；
   * 允许在产品设计上保留“模板导出/导入”的概念，以便在后续版本支持：

     * 在一个租户中导出模型/Flow/Board 模板，在另一个租户中导入。

5. **租户停用行为**

   * 当 Tenant 状态变为 SUSPENDED：

     * 所有该租户下的 TenantUser 无法登录工作区；
     * 所有调度类型为 CRON 的 Flow 不再触发；
     * 已在运行中的 Flow 可以允许自然结束（不强杀），由运维策略决定；
   * 重新启用后，恢复以上能力。

---

## 3. 核心概念与全局规范

### 3.1 核心领域概念

> 本小节从“概念与关系”角度定义数据模型，字段级详细定义将在附录 15.1 中汇总。

#### 3.1.1 GlobalUser / 平台用户

* 平台级账号，一个 GlobalUser 可以加入多个租户；
* 主要字段（简要）：

  * `id`：主键（详见 3.2）；
  * `login_name`：登录账号，平台内唯一；
  * `display_name`：显示名称；
  * `email`：邮箱；
  * `status`：ACTIVE / DISABLED；
  * `created_at` / `updated_at`。
* 约束：

  * 禁用后无法登录任何租户；
  * `(login_name)` 全局唯一。

#### 3.1.2 Tenant / 租户

* 平台中的逻辑隔离单元（组织/公司/项目）；
* 主要字段：

  * `id`：主键；
  * `code`：租户编码（业务编码，唯一）；
  * `name`：租户名称；
  * `status`：ACTIVE / SUSPENDED；
  * `plan`：BASIC / PRO / ENTERPRISE；
  * `created_at` / `updated_at`。
* 关键行为：

  * SUSPENDED 时禁止所有租户用户访问前台，停止调度。

#### 3.1.3 TenantUser / 租户用户

* 描述 GlobalUser 在某个 Tenant 中的成员关系；
* 主要字段：

  * `id`；
  * `tenant_id`（FK → Tenant）；
  * `user_id`（FK → GlobalUser）；
  * `status`：ACTIVE / DISABLED（仅影响该租户）；
  * `is_owner`：是否该租户 Owner；
  * `last_login`；
  * `created_at` / `updated_at`。
* 约束：

  * `(tenant_id, user_id)` 唯一；
  * 每个租户至少有 1 个 `is_owner = true` 的 TenantUser。

#### 3.1.4 Role / 角色

* 作用范围：**租户内**；
* 主要字段：

  * `id`；
  * `tenant_id`；
  * `name`：角色名称，同一租户内唯一；
  * `description`：描述；
  * `is_system`：是否系统内置（不可删除，可限制部分字段不可修改）；
  * `created_at` / `updated_at`。
* 行为：

  * 租户 Owner 可创建/编辑/删除自定义角色；
  * 系统内置角色（如 Owner、DataEngineer、Analyst、Viewer）不可删除。

#### 3.1.5 TenantUserRole / 用户-角色关联

* 描述 TenantUser 与 Role 的多对多关系；
* 主要字段：

  * `tenant_user_id`；
  * `role_id`；
* 约束：

  * `(tenant_user_id, role_id)` 唯一；
  * 一名 TenantUser 可以有多个 Role。

> 最终权限计算会合并该用户所有角色上的权限配置，详见后续权限模型章节。

#### 3.1.6 ResourceTree / 资源树

* 用于表示表、任务流、看板三类资源的目录结构；

* 每类资源维护一棵独立的树，以 `scope` 区分：

  * `scope=TABLE`：表资源树；
  * `scope=FLOW`：任务流资源树；
  * `scope=BOARD`：看板资源树。

* 节点类型：

  * FOLDER：目录；
  * TABLE / FLOW / BOARD：具体资源。

* 核心字段（逻辑）：

  * `id`；
  * `tenant_id`；
  * `scope`：TABLE / FLOW / BOARD；
  * `type`：FOLDER / RESOURCE（如 TABLE 等）；
  * `resource_id`：当 type 为资源时，指向目标资源表的主键；
  * `parent_id`：父节点；
  * `display_name`：显示名称；
  * `sort_order`：排序。

> 说明：
>
> * 前端展示时，用户只看到自己有权限的资源节点及其父目录；
> * 对 FOLDER 节点配置的权限，会作为默认权限向下继承；
> * 目录禁止挂载在具体资源之下。

#### 3.1.7 权限相关实体

**1）RolePermission / 角色-资源权限**

* 描述某角色对某资源（或目录）的访问级别；
* 范围包括：

  * TABLE_SCHEMA：表结构；
  * TABLE_DATA：表数据；
  * FLOW：任务流；
  * BOARD：看板。
* 核心字段（逻辑）：

  * `id`；
  * `tenant_id`；
  * `role_id`；
  * `resource_type`：TABLE_SCHEMA / TABLE_DATA / FLOW / BOARD；
  * `resource_id`：可以是资源本身 ID，也可以是 FOLDER 节点 ID；
  * `permission`：NONE / VIEW / EDIT / MANAGE。

**2）ColumnPermission / 列权限**

* 描述某角色在某张表上的**列级访问控制**；
* 核心字段：

  * `id`；
  * `tenant_id`；
  * `role_id`；
  * `table_id`；
  * `column_code`；
  * `access_level`：HIDDEN / READONLY / READWRITE。

**3）RowPermission / 行权限**

* 描述某角色在某张表上的**行级过滤规则**；
* 核心字段：

  * `id`；
  * `tenant_id`；
  * `role_id`；
  * `table_id`；
  * `rule_name`；
  * `filter_json`：统一 JSON DSL；
* 执行时，多个规则通常通过 OR 合并（细节见权限章节）。


### 3.1.8 Table / Field / Relation（表 / 字段 / 表间关联）

本小节只定义三个核心建模对象的**概念与全局约定**，具体创建/编辑/删除逻辑及交互细节，放在后文「8. 建模模块（Modeling）」中说明。

---

#### 3.1.8.1 Table / 表

**定义**

* 每个 Table 代表租户内部的一类业务数据集合（如：订单表、用户表、广告计划表等）。
* Table 在平台中有一份**元信息记录**，并对应一张**物理数据表**（一一对应）。

**核心元信息字段（逻辑层）**

> 仅列出产品层需要统一约定的字段，具体物理实现由技术设计细化。

* `id`：表主键（系统生成，UUID/int 均可）
* `tenant_id`：所属租户
* `code`：表编码（英文小写蛇形，LLM 辅助生成；租户内唯一）
* `display_name`：表显示名（中文/业务名）
* `type`：表类型，枚举：维度 / 事实 / 配置 / 其他
* `description`：表描述
* `created_by` / `updated_by`：操作人（TenantUser）
* `created_at` / `updated_at`：时间戳

**全局规范**

1. **命名与唯一性**

   * `(tenant_id, code)` 组合必须唯一。
   * `code` 使用英文小写蛇形命名，长度与字符集要求统一于 3.2「编码规范」。

2. **与物理表的对应关系**

   * 每个 Table 对应数据库中的一张物理表，命名采用统一规则（如 `t_{tenantId}_{tableCode}`），具体格式由技术设计确定。
   * 任何对字段结构的变更都必须以 Table / Field 元信息为准，再同步到物理表。

3. **主键约定**

   * V1 要求每张业务表必须有且仅有一个主键字段（详见 Field 定义），用作行级唯一标识及 Relation 关联目标。

4. **租户隔离**

   * 所有物理表都必须包含 `tenant_id` 列，确保多租户数据隔离（具体查询规范见 3.3 / 13.1）。

---

#### 3.1.8.2 Field / 字段

**定义**

* Field 是 Table 内的列定义，用于描述每条记录的某个属性（如「订单金额」「下单时间」）。
* 字段既有**物理类型**（数据库类型），也有**逻辑类型**（普通字段/关联字段/计算字段）。

**核心元信息字段**

* `id`：字段主键
* `tenant_id`：所属租户
* `table_id`：所属表 ID
* `code`：字段编码（英文蛇形，表内唯一）
* `display_name`：字段显示名称
* `type`：物理类型，如 string / int / float / decimal / bool / date / datetime …（平台支持的子集）
* `logical_type`：逻辑类型，枚举：

  * `NORMAL`：普通字段（默认）
  * `LOOKUP`：关联字段（Lookup，表示指向另一张表的记录）
  * `COMPUTED`：计算字段（预留，V1 可暂不实现具体能力）
* `is_primary_key`：是否主键（V1 约束同一表仅允许一个主键字段为 true）
* `is_required`：是否 NOT NULL
* `default_value`：默认值（按类型序列化）
* `is_internal`：是否系统字段（如 created_at/updated_at 等，受保护）
* `description`：字段描述
* `created_at` / `updated_at`：时间戳

**全局规范**

1. **唯一性与命名**

   * 同一表内 `(table_id, code)` 必须唯一。
   * `code` 命名规则统一由 3.2「编码规范」约束。

2. **主键约束**

   * V1 规定每张业务表**最多一个** `is_primary_key = true` 的字段。
   * 该字段用作行级唯一标识，并作为 Relation 关联目标（to_field）使用。

3. **逻辑类型语义**

   * `NORMAL`：纯值字段，仅描述当前表自身属性。
   * `LOOKUP`：关联字段，表示“当前表这一列指向另一张表的一条记录”，是 Relation 元数据的主要来源。
   * `COMPUTED`：用于表达基于表达式或派生规则的虚拟字段，具体实现与表达式规则在后续版本及相关章节定义。

4. **系统字段**

   * `is_internal = true` 的字段为平台保留字段，字段删除/修改能力受限（禁止删除、限制类型修改），具体约束在建模模块中统一说明。


#### 3.1.8.3 Relation / 表间关联（Lookup 元数据）

**定义**

* Relation 是平台内部维护的表间关联元数据，用于显式描述：

  > “某张表中的某个 LOOKUP 字段，指向另一张表的主键字段。”

* Relation 主要用于：

  * 多表间业务关系的统一建模；
  * Flow Join / Dataset / 看板 等功能中的自动关联推断；
  * 删除保护 / 血缘分析 / 未来 LLM 辅助建模等能力。

**核心元信息字段**

> Relation 不直接面向普通业务用户展示，“Relation”一词主要出现在内部文档与研发实现中。

* `id`：主键
* `tenant_id`：所属租户
* `from_table_id`：来源表 ID（包含 LOOKUP 字段的表）
* `from_field_id`：来源字段 ID（该 LOOKUP 字段）
* `to_table_id`：目标表 ID（被指向的表）
* `to_field_id`：目标字段 ID（通常为目标表主键）
* `name`：关系名称（可选，便于内部管理与只读展示）
* `description`：描述（可选）
* `created_at` / `updated_at`：时间戳

**全局规范**

1. **来源于 LOOKUP 字段**

   * 平台约定：**每一个 `logical_type = LOOKUP` 的字段，都对应一条 Relation 记录**。
   * Relation 不用于描述任意手工定义的“抽象关系”，而是紧密绑定到具体字段，便于行为收敛与后续扩展。

2. **关系语义（V1）**

   * 语义固定为：

     > 多条 `from_table` 记录 → 指向 `to_table` 中的一条记录（Many-to-One）。
   * 不直接建模多对多或“一对多集合字段”等复杂场景，此类需求通过中间表 + 普通字段在业务层解决。

3. **作用范围**

   * Relation 始终在同一租户内部使用，不跨租户。
   * 其他模块（Flows / Datasets / Boards / 权限等）如需依赖表间关系，应通过 Relation 元数据获取，不自行硬编码表 join 规则。

4. **实现细节位置说明**

   * Relation 的创建/更新/删除具体触发条件、与字段/表生命周期的联动、以及 UI 呈现方式，均在后文章节中定义：

     * 8.x 建模模块（字段管理 / 关联字段配置）
     * 9.x 任务流模块（Join 节点行为）
     * 10.x 数据集 & 看板模块（多表分析行为）

#### 3.1.9 Flow / Node / Run / Schedule

**Flow / 任务流**

* 描述一个 ETL 工作流；
* 核心字段：

  * `id`；
  * `tenant_id`；
  * `name`；
  * `description`；
  * `status`：ACTIVE / INACTIVE（逻辑状态，可选）；
  * `schedule_type`：MANUAL / CRON；
  * `cron_expr`：当类型为 CRON 时必填；
  * `config_json`：包含 DAG 拓扑和节点配置；
  * `created_by` / `updated_by`；
  * `created_at` / `updated_at`。

**Node / 节点**

* 作为 Flow 配置的一部分，一般以内嵌 JSON 表示：

  * `node_id`：节点唯一标识；
  * `type`：SOURCE / TRANSFORM / SINK；
  * `sub_type`：HTTP_SOURCE / MYSQL_SOURCE / FILE_SOURCE / FILTER / AGGREGATE / JOIN / CALC_FIELD / WRITE_TABLE / WRITE_HTTP 等；
  * `config`：各子类型的具体配置项（见任务流模块章节）。

**Run / 运行实例**

* 每次 Flow 执行对应一条 Run 记录；
* 核心字段：

  * `id`（Run ID）；
  * `flow_id`；
  * `tenant_id`；
  * `trigger_type`：MANUAL / SCHEDULED；
  * `status`：PENDING / RUNNING / SUCCESS / FAILED；
  * `started_at` / `finished_at`；
  * `error_message`（如失败）；
  * `node_stats_json`：节点级耗时、行数、错误信息等。

**Schedule / 调度**

* V1 可以通过 Flow 自带字段管理调度（不一定单独建表）；
* 统一要求：
  * 对于调度任务，必须记录最近一次触发时间和结果；
  * 租户停用时，不再触发调度任务。

#### 3.1.10 Dataset / Board / Widget

**Dataset / 数据集**

* 基于某个 Table（或视图）的可复用数据视图，封装了基础过滤条件；
* 核心字段：

  * `id`；
  * `tenant_id`；
  * `table_id`；
  * `name`；
  * `description`；
  * `base_filter_json`：统一 DSL；
  * `created_by` / `updated_by`；
  * `created_at` / `updated_at`。

**Board / 看板**

* 看板页面，由若干 Widget 组成；
* 核心字段：

  * `id`；
  * `tenant_id`；
  * `name`；
  * `description`；
  * `layout_json`：整体布局（可选）；
  * `created_by` / `updated_by`；
  * `created_at` / `updated_at`。

**Widget / 组件**

* 看板上的可视化组件；
* 核心字段：

  * `id`；
  * `board_id`；
  * `tenant_id`；
  * `type`：METRIC_CARD / CHART / TABLE 等；
  * `title` / `description`；
  * `dataset_id`；
  * `query_config`：指标、维度、过滤、排序、limit 等；
  * `viz_config`：图表样式配置；
  * `layout`：组件在看板中的位置与尺寸（x, y, w, h）；
  * `created_at` / `updated_at`。

---

### 3.2 全局 ID & 编码规范

#### 3.2.1 主键 ID 统一规范

1. **主键类型**

   * 所有核心业务表（GlobalUser、Tenant、TenantUser、Table、Field、Flow、Dataset、Board、Widget 等）的主键 `id` 统一采用：

     * 数据库层面：`BIGINT` 自增（或等价实现）；
     * 对前端/API：作为不透明整数 ID 使用，不对外承诺 ID 的任何含义和连续性。

2. **tenant_id 使用规范**

   * 所有租户内实体表（Table、Field、Flow、Dataset、Board、ResourceTree、Role、Permission 等）必须包含 `tenant_id`；
   * `(tenant_id, id)` 组合视为唯一标识该租户内的某条记录；
   * API 层禁止跨租户传入 ID 并访问其他租户数据。

3. **ID 对外暴露原则**

   * API 返回时，可以直接返回 `id` 的数值；
   * 若存在安全或隐私顾虑，可在后续版本考虑引入 opaque key（如加密/编码）。

#### 3.2.2 业务编码（code）规范

部分实体需要对外有**稳定的业务编码**，如：

* Tenant.code；
* Table.code；
* Field.code；
* 未来可能扩展的 Dataset.code、Board.code 等。

统一命名规范：

* 字符集：`[a-z0-9_]+`；
* 命名风格：小写蛇形（snake_case）；
* 长度：1–50 字符；
* 必须以字母开头（`[a-z]`）；
* 不允许使用系统保留字（如 `select`, `from`, `where` 等，具体保留字列表由技术实现约定）。

**唯一性约束**

* `Tenant.code`：平台全局唯一；
* `Table.code`：同一租户内唯一（`(tenant_id, table_code)` 唯一）；
* `Field.code`：同一表内唯一（`(table_id, field_code)` 唯一）。

**生成与维护方式**

* V1 中，表/字段编码由 LLM 辅助生成 + 本地兜底：

  * 输入：display_name（中文/业务名）；
  * 输出：一个符合上述规则的编码；
  * 后端负责清洗、去重和加后缀。
* 用户层面：

  * 前端通常将 `code` 字段设为只读，不支持手动编辑；
  * 如未来允许手动编辑，必须进行冲突检测和影响分析。

---

### 3.3 时间、时区与日期处理规范

#### 3.3.1 存储与传输原则

1. **时间存储**

   * 数据库中所有 `datetime` 字段统一存储为 **UTC 时间**；
   * 字段命名统一为 `*_at` 结尾，如 `created_at`, `updated_at`, `started_at`, `finished_at`。

2. **API 传输格式**

   * 前后端之间传递日期时间统一使用 ISO8601 字符串：

     * 例如：`"2025-12-10T08:30:00Z"`（UTC），或带偏移的形式；
   * 仅日期（无时间）字段统一使用 `"YYYY-MM-DD"` 字符串格式。

3. **前端显示时区**

* 每个 Tenant 可配置一个“默认时区”（V1 可默认固定为 Asia/Shanghai，如无特别需求）；
* 前端展示时将 UTC 转换为租户默认时区后再格式化显示，例如：

  * `YYYY-MM-DD HH:mm`；
* 用户在前端输入的日期时间（如筛选条件）按租户时区解释，再转换为 UTC 传给后端。

#### 3.3.2 DSL 中的日期时间

1. DSL 中的 `value` 字段，日期/时间字段使用：

* 日期：`"YYYY-MM-DD"`；
* 日期时间：`"YYYY-MM-DD HH:mm:ss"`，默认解释为租户时区，再由后端统一转换为 UTC。

2. 特殊变量：

* `CURRENT_DATE`：当前日期（租户时区）；
* `CURRENT_DATETIME`：当前时间（租户时区）；

后端将这些变量在执行前“展开”为具体 UTC 时间。

#### 3.3.3 审计与排序

* 所有有业务生命周期的实体必须包含 `created_at`、`updated_at` 字段；
* 列表默认按 `updated_at` 降序排序，除非业务有特殊要求。

---

### 3.4 软删除、状态字段统一约定

#### 3.4.1 状态字段（status）的通用规则

1. **适用实体**

* GlobalUser：`status = ACTIVE / DISABLED`；
* Tenant：`status = ACTIVE / SUSPENDED`；
* TenantUser：`status = ACTIVE / DISABLED`；
* Flow：可选 `status = ACTIVE / INACTIVE`（用于控制是否允许调度/运行）；
* 其他需要生命周期管理的实体，可根据需要增加 `status`。

2. **状态含义**

* ACTIVE：正常可用；
* DISABLED：账号/关系存在，但禁止登录或使用；
* SUSPENDED（租户）：租户暂时停用，不允许任何租户用户访问，也不触发调度。

3. **使用原则**

* 在能通过 `status` 表示“可用/不可用”的场景，优先使用 `status` 而非 `is_deleted`；
* 对用户、租户、成员关系等实体，不做物理删除，以便保留审计轨迹。

#### 3.4.2 软删除（is_deleted）策略

V1.0 中为简化实现：

* **绝大部分业务实体（如 Table、Field、Flow、Dataset、Board）采用“物理删除 + 依赖检查”的方式**：

  * 删除前进行依赖检查（是否被 Flow/Dataset/Board/Relation/权限引用）；
  * 若存在依赖则禁止删除并给出清晰提示；
  * 若无依赖则执行物理删除；
* 对于审计类记录（如操作日志、运行记录等），不使用软删除，而是按时间归档/清理。

后续如有需要：

* 可以在特定实体上引入 `is_deleted` 字段，实现“逻辑删除”，同时不在前端展示被软删除的记录；
* 一旦某实体启用 `is_deleted`，文档需要在对应章节明确说明删除行为是“软删除”，以防歧义。

---

### 3.5 错误码 & 错误提示统一规范

#### 3.5.1 API 响应结构约定

所有 API（包括前台/后台）统一采用如下响应结构：

```json
{
  "success": false,
  "code": "ERR_PERMISSION_DENIED",
  "message": "您没有权限执行此操作",
  "data": null,
  "trace_id": "optional-debug-id"
}
```

字段说明：

* `success`：布尔值，表示本次请求是否成功；
* `code`：错误码字符串，便于前后端 & 运维定位问题；
* `message`：面向用户的简要错误提示（可展示在 UI 中）；
* `data`：成功时返回数据，失败时通常为 null 或附带少量上下文信息；
* `trace_id`：可选，用于日志追踪。

#### 3.5.2 错误码命名规范

* 格式：`ERR_` + 模块 + 简要说明，例如：

  * `ERR_PERMISSION_DENIED`：无权限；
  * `ERR_TENANT_SUSPENDED`：租户已停用；
  * `ERR_TABLE_IN_USE`：表被其他资源引用，无法删除；
  * `ERR_INVALID_DSL`：DSL 不合法；
  * `ERR_FLOW_RUNNING_ALREADY`：Flow 正在运行，禁止再次触发。

* 模块前缀（建议）：

  * `USER_`：账号/用户相关；
  * `TENANT_`：租户相关；
  * `MODEL_`：建模相关（表/字段/关系）；
  * `FLOW_`：任务流相关；
  * `BOARD_`：看板/Widget 相关；
  * `PERM_`：权限相关；
  * `LLM_`：LLM 辅助相关。

#### 3.5.3 前端错误展示要求

* 对于**权限相关错误**（如 403 / `ERR_PERMISSION_DENIED`）：

  * UI 提示：

    * 文案示例：“您没有权限执行此操作，如需访问请联系租户管理员”；
  * 可选提供“查看权限说明”链接。

* 对于**输入校验错误**（如 `ERR_INVALID_DSL`, `ERR_INVALID_FIELD_TYPE`）：

  * 尽可能标明具体字段与错误原因：

    * 示例：“字段『订单金额』的默认值格式不正确，应为数字”；

* 对于**后端异常/未知错误**（如 500 系统错误）：

  * 对用户仅提示：

    * “系统开小差了，请稍后重试，如果多次失败请联系管理员”；
  * 具体异常信息仅记录在后台日志中，不直接暴露给用户。

* 对于**业务约束导致的错误**（如删除表存在依赖）：

  * 提示内容需包含关键依赖信息：

    * “该表被以下资源引用，无法删除：任务流『每日订单同步』、看板『收入看板』中的 Widget『订单趋势图』”。
## 4. 统一查询 DSL & 权限模型（横切关注）

本章定义整个系统中**统一使用**的过滤 DSL 以及资源级 / 行级 / 列级权限模型。
后续所有模块（建模、任务流、数据集&看板、设置）涉及到“筛选 / 查询 / 权限”时，都应引用本章约定，避免各自实现。

---

### 4.1 统一过滤 JSON DSL（FilterDSL）

#### 4.1.1 设计目标

统一的 FilterDSL 用于：

* 表数据页的高级筛选；
* RowPermission（行级权限）规则；
* Dataset 的基础过滤（base_filter）；
* Widget 的过滤条件（图表、指标卡、表格）；
* Flow 中的“过滤节点”。

目标：

1. **统一语义**：所有地方的“过滤条件”都转成同一套 JSON 结构；
2. **安全可控**：可受控映射为 SQL，避免用户拼接 SQL 注入风险；
3. **可视化编辑**：适合作为可视化条件配置器（Condition Builder）的底层结构；
4. **可拓展**：后续可以增加运算符，而不影响既有数据。

#### 4.1.2 结构定义（Group / Condition）

FilterDSL 由两类节点构成：

* 条件组（Group）：`{ op, conditions }`
* 简单条件（Condition）：`{ field, operator, value }`

顶层可以是一个 Group，也可以是一个单独的 Condition。

```jsonc
// 示例：金额 > 100 且 (状态 = SUCCESS 或 PARTIAL)
{
  "op": "and",
  "conditions": [
    { "field": "amount", "operator": ">", "value": 100 },
    {
      "op": "or",
      "conditions": [
        { "field": "status", "operator": "=", "value": "SUCCESS" },
        { "field": "status", "operator": "=", "value": "PARTIAL" }
      ]
    }
  ]
}
```

**条件组（Group）字段：**

| 字段         | 类型            | 说明                       |
| ---------- | ------------- | ------------------------ |
| op         | string        | `"and"` / `"or"`         |
| conditions | Array<Object> | 子条件列表（Group 或 Condition） |

**简单条件（Condition）字段：**

| 字段       | 类型     | 说明                    |
| -------- | ------ | --------------------- |
| field    | string | 字段编码（Field.code）      |
| operator | string | 操作符                   |
| value    | any    | 操作值（部分操作符可为空 / 省略，见下） |

#### 4.1.3 操作符列表 & 类型约束

**通用比较：**

* `=`, `!=`, `>`, `>=`, `<`, `<=`

**集合：**

* `in`, `not_in`

  * `value` 为数组类型

**范围：**

* `between`

  * `value` 为长度为 2 的数组 `[min, max]`

**文本：**

* `contains`, `not_contains`
* `starts_with`, `ends_with`

**空值判断：**

* `is_null`, `is_not_null`

  * 此时 `value` 一般省略或为 `null`（由实现统一）

**类型约束（产品统一要求）：**

* 数值型字段（int/float/decimal 等）允许：
  `= != > >= < <= in not_in between is_null is_not_null`
* 字符串字段允许：
  `= != in not_in contains not_contains starts_with ends_with is_null is_not_null`
* 日期 / 时间字段允许：
  `= != > >= < <= between in not_in is_null is_not_null`
  值统一为字符串：

  * date：`"YYYY-MM-DD"`
  * datetime：`"YYYY-MM-DD HH:mm:ss"`
* 布尔字段允许：
  `= != is_null is_not_null`

前端的条件编辑器需要根据字段类型自动过滤出合法的 operator，避免生成无法执行的 DSL。

#### 4.1.4 特殊变量（动态值注入）

FilterDSL 支持内置“变量值”，用于表达如“当前用户”、“今天”类条件，由后端解析：

内置变量：

* `CURRENT_USER_ID`：当前 TenantUser.id；
* `CURRENT_TENANT_ID`：当前租户 id（多数情况下隐含在上下文）；
* `CURRENT_DATE`：当前日期；
* `CURRENT_DATETIME`：当前时间。

统一格式：

```json
{
  "field": "owner_id",
  "operator": "=",
  "value": { "__var__": "CURRENT_USER_ID" }
}
```

产品约束：

* 所有变量统一使用 `{"__var__": "<NAME>"}` 的形式；
* 前端只能从变量枚举列表中选择，不允许自由填写变量名。

#### 4.1.5 DSL → SQL 映射约束

确保安全与一致性：

1. **仅支持 AND / OR 逻辑**

   * 不支持 NOT；
   * 不在 DSL 中支持 SQL 函数或子查询。

2. **禁止 SQL 直写**

   * FilterDSL 不提供任何“直接输入 SQL 条件”的字段。

3. **字段受限**

   * `field` 必须是当前查询上下文的 Field.code；
   * 不允许使用表别名/点号等跨表写法（跨表由系统自动拼接，不由用户控制）。

4. **运算符白名单**

   * 仅允许 4.1.3 列出的 operator。

5. **映射失败统一处理**

   * 字段不存在 / 类型不匹配 / 结构非法 → 视为配置错误；
   * 接口返回 4xx，前端提示错误原因，不做“默认放宽”或 silent ignore。

#### 4.1.6 版本与兼容性

* 当前版本可视为 V1，未来可增加 `operator` 或结构字段；
* 产品约束：不得改变既有字段的语义（例如 `op`、`conditions` 等）；
* 如需在未来支持多版本 DSL，可在顶层增加 `version` 字段，当前版本可省略。

---

### 4.2 行级权限模型（RowPermission）

#### 4.2.1 目标和范围

RowPermission 用于控制：

> 同一张表中，不同角色能够访问**哪些行**的数据。

典型场景：

* 销售只看自己负责的客户；
* 某部门成员只看本部门数据；
* 管理员可以看全量数据。

行级权限基于 FilterDSL 实现，并且与业务过滤、Dataset 过滤叠加。

#### 4.2.2 角色内规则合并（OR）

对某个（role, table）：

* 允许配置 0~N 条行权限规则（RowPermission 记录）；
* 每条规则是一个 FilterDSL；
* 对该角色而言，所有规则以 **OR** 方式合并：

> `row_filter(role, table) = rule1 OR rule2 OR ...`

如果某个角色在该表上**没有任何 RowPermission 规则**：

* 视为该角色在该表上**不施加额外行级限制**（即“看到该表的全部行”，前提是资源级 TABLE_DATA 允许）。

#### 4.2.3 多角色合并（再 OR）

一个 TenantUser 通常拥有多个角色。

对某张表 t，这些角色对应的 RowPermission 都会参与合并：

> `final_row_filter(user, t) = OR_over_roles(row_filter(role_i, t))`

直观理解：

* 用户拥有的角色越多，可访问的行“有可能更多”，不会被其它角色“收窄”；
* 行级权限是“放开的合集”而不是“最小交集”。

#### 4.2.4 与业务过滤叠加顺序

对于任意一张表的查询（表数据页、Flow 节点查询、Dataset/Widget 查询）统一约定：

1. 应用 Dataset.base_filter（若存在）；
2. 应用 Widget / Flow 节点设置的业务过滤条件；
3. 应用 RowPermission 行级权限过滤。

这三部分之间按 **AND** 组合：

> `总 WHERE 条件 = base_filter AND business_filter AND row_permission_filter`

产品约束：

* 任何业务配置过滤，都不能绕过行级权限；
* 行级权限不会减弱业务过滤（不会扩大结果集，只会收紧）。

#### 4.2.5 MANAGE 权限与行级权限

对于某表：

* 若用户在该表的 `TABLE_DATA` 上，有任一角色获得 `MANAGE` 权限；
* 本期默认策略：**该用户在该表上不受行级权限限制**（即行级权限绕过）。

这个策略是全局统一的，主要用于：

* 管理员调试；
* 权限配置错误时拥有兜底人。

后续如需要“管理员也受行级限制”，可以增加租户级配置开关，但不在本期范围内。

---

### 4.3 列级权限模型（ColumnPermission）

#### 4.3.1 目标和范围

ColumnPermission 控制：

> 在同一张表中，不同角色对不同字段的**可见 / 可写**权限。

典型需求：

* 对普通用户隐藏敏感字段（如身份证号、成本价）；
* 允许部分角色查看但禁止修改某些字段（如审核状态）。

#### 4.3.2 权限级别定义

针对（role, table, column）：

* `HIDDEN`：字段不可见

  * 查询结果中不返回该字段；
  * 表数据页不显示该列；
  * Widget 字段选择器不列出该字段（若可能）。
* `READONLY`：字段可见，但不可编辑

  * 查询结果中返回该字段；
  * 表数据页显示该列，但编辑/新增时字段为只读；
  * API 不接受该字段的修改。
* `READWRITE`：字段可见且可编辑

  * 完整读写权限。

#### 4.3.3 多角色合并规则

对于用户 U 在表 T 的字段 F：

1. 收集 U 所有角色在该字段上的列权限；
2. 若所有角色权限都是 `HIDDEN` → 最终为 `HIDDEN`；
3. 否则：

   * 若有任一角色为 `READWRITE` → 最终为 `READWRITE`；
   * 否则若有任一角色为 `READONLY` → 最终为 `READONLY`。

**注意：**

* 最终列权限仍受资源级 TABLE_DATA 权限控制：

  * 若用户对表 T 的 TABLE_DATA < EDIT，则即使最终列权限是 READWRITE，也不允许修改数据。

#### 4.3.4 前端与接口行为

* 对 HIDDEN 字段：

  * 查询接口不返回该字段；
  * 表数据页、Widget 字段选择器中不展示；
  * 若历史配置中某 Widget 已引用该字段，而当前用户对该字段为 HIDDEN：

    * 查询该 Widget 时，后端可直接返回字段权限错误，前端提示“当前无权使用字段 X”。

* 对 READONLY 字段：

  * 查询接口正常返回；
  * 新建/编辑表单中以禁用状态展示；
  * 前端不允许修改；若前端传入了值，后端应忽略或报错（由实现统一决定）。

* 对 READWRITE 字段：

  * 正常读写。

---

### 4.4 资源级权限模型（RolePermission）

#### 4.4.1 资源类型（resource_type）

本期资源级权限覆盖以下类型：

* `TABLE_SCHEMA`：表结构（建模能力：新增字段、修改字段等）；
* `TABLE_DATA`：表数据（增删改查记录）；
* `FLOW`：任务流；
* `BOARD`：看板。

  > Dataset 可以作为 Board 的子资源处理，是否单独抽象为资源类型可由实现决定。

#### 4.4.2 权限等级（permission）

统一权限等级：

* `NONE`：无权限；
* `VIEW`：仅查看；
* `EDIT`：修改内容，但不包含删除 / 配置权限；
* `MANAGE`：管理权限，包括删除资源、移动资源、配置权限等。

不同模块对 EDIT / MANAGE 的具体按钮控制会在对应章节详细说明。

#### 4.4.3 资源树与 Folder 默认权限

系统通过 ResourceTree 组织资源（表、Flow、Board），包含 Folder 节点和资源节点：

* Folder 节点上可以配置“默认权限”；
* 对于该 Folder 下**未单独配置权限**的子资源节点（表 / Flow / Board），使用最近祖先 Folder 的默认权限；
* 一旦在资源节点上显式配置了权限，则以该资源节点配置为准，覆盖 Folder 默认值。

合并顺序（单角色内部）：

1. 从资源节点向上回溯到根 Folder，收集所有权限设置；
2. 取其中**最大权限等级**作为该角色对该资源最终的资源级权限。

#### 4.4.4 多角色合并（Effective Resource Permission）

对于某个用户 U 和某个资源 R（resource_type + resource_id）：

1. 对 U 的每个角色 role_i：

   * 计算该角色在资源 R 上的“单角色权限”（按照 4.4.3）；
2. 所有角色的权限再次取最大值：

> `permission(U, R) = max(permission(role1, R), permission(role2, R), ...)`
> 等级顺序：`NONE < VIEW < EDIT < MANAGE`。

---

### 4.5 权限校验原则

#### 4.5.1 后端强校验为准

* **所有**需要权限控制的接口都必须在后端进行强制校验：

  * 资源级：RolePermission；
  * 行级：RowPermission；
  * 列级：ColumnPermission。
* 前端权限仅用于改善体验（隐藏按钮、禁用操作），不能作为安全边界。

#### 4.5.2 错误码与提示

* 未登录或 Token 失效 → 返回 `401 Unauthorized`；
* 已登录但权限不足 → 返回 `403 Forbidden`。

前端统一提示示例（可 i18n）：

> “您没有权限执行该操作，如有需要请联系租户管理员。”

#### 4.5.3 审计与追踪

* 涉及权限变更的操作（角色创建/删除、角色权限变更、行/列权限变更、用户角色调整等）必须产生日志记录；
* 日志格式与查询方式在第 12 章统一说明；
* 本期至少保证**后端有可追溯的变更记录**，前端查看页面可以逐步增强。

---

## 5. 平台后台（Platform Admin Console）

本章描述平台级后台，服务对象为 **Platform Admin**，主要能力包括：

* 平台用户（GlobalUser）管理；
* 租户（Tenant）管理；
* 租户成员管理（TenantUser）；
* （后续）平台级审计日志与监控。

本期默认约定：

* GlobalUser 上有字段 `is_platform_admin: bool`；
* 仅 `is_platform_admin = true` 的用户可以访问 `/admin/*` 路径的页面与接口。

---

### 5.1 导航结构 & 访问控制

#### 5.1.1 导航结构

平台后台主导航（示例）：

* 用户管理（Global Users） `/admin/users`
* 租户管理（Tenants） `/admin/tenants`
* （可选）平台审计日志（后续版本）

每个导航项下再有相应列表 / 详情页。

#### 5.1.2 访问控制规则

* 登录后，前端通过 `/api/me` 等接口获取当前用户信息，其中包含 `is_platform_admin`；
* 若 `is_platform_admin = true`：

  * 显示“平台后台”入口；
  * 允许访问 `/admin/*` 路由；
* 否则：

  * 不显示平台后台菜单；
  * 用户直接访问 `/admin/*` 时，后端返回 403。

后端统一中间件规则：

* 所有 `/admin/*` 接口必须校验：

  * 未登录 → 401；
  * 已登录但 `is_platform_admin != true` → 403。

---

### 5.2 GlobalUser 管理

#### 5.2.1 GlobalUser 列表页

* 路径：`/admin/users`
* 粒度：每行一个 GlobalUser。

显示字段：

| 列名      | 说明                     |
| ------- | ---------------------- |
| 登录名     | login_name             |
| 显示名     | display_name           |
| 邮箱      | email                  |
| 是否平台管理员 | is_platform_admin（是/否） |
| 状态      | ACTIVE / DISABLED      |
| 创建时间    | created_at             |
| 更新时间    | updated_at             |
| 操作      | 编辑 / 启用/禁用 /（可选重置密码）   |

筛选与搜索：

* 搜索条件：

  * 输入框：按登录名 / 显示名 / 邮箱模糊查询；
* 筛选条件：

  * 状态：全部 / ACTIVE / DISABLED；
  * 是否平台管理员：全部 / 是 / 否。

禁用行为：

* 禁用 GlobalUser → 用户无法再登录系统，也无法访问任何租户；
* 不自动删除已有的 TenantUser 关系。

#### 5.2.2 创建 / 编辑 GlobalUser

创建 GlobalUser 表单字段：

* 登录名（必填、平台全局唯一）；
* 显示名（必填）；
* 邮箱（必填，格式校验）；
* 是否平台管理员（布尔开关）；
* 初始密码（是否自动生成由实际安全策略决定）。

编辑 GlobalUser：

* 登录名不可修改；
* 显示名、邮箱、是否平台管理员、状态可修改。

在产品层面，是否允许通过 UI 创建/编辑 `is_platform_admin` 可配置：

* 若担心误操作，可只允许运维通过脚本修改；
* 或在 UI 中加二次确认（“将该用户设为平台管理员将赋予其最高权限，确认操作吗？”）。

---

### 5.3 租户管理（Tenant）

#### 5.3.1 租户列表页

* 路径：`/admin/tenants`
* 粒度：每行一个 Tenant。

显示字段：

| 列名   | 说明                       |
| ---- | ------------------------ |
| 租户编码 | code（唯一）                 |
| 租户名称 | name                     |
| 状态   | ACTIVE / SUSPENDED       |
| 套餐   | BASIC / PRO / ENTERPRISE |
| 创建时间 | created_at               |
| 更新时间 | updated_at               |
| 操作   | 编辑 / 启用/停用 / 查看成员/详情     |

功能：

* 按编码 / 名称模糊搜索；
* 按状态 / 套餐筛选。

#### 5.3.2 新建 / 编辑租户

新建 Tenant 表单字段：

* 租户编码（code，必填、唯一）；
* 租户名称（name，必填）；
* 套餐（plan：BASIC/PRO/ENTERPRISE，必填）；
* 状态（默认 ACTIVE）。

编辑 Tenant：

* 租户编码不可修改；
* 可修改租户名称、套餐、状态。

状态含义：

* `ACTIVE`：

  * 租户用户可正常访问租户工作区；
  * 该租户下的任务流调度正常运行。
* `SUSPENDED`：

  * 所有 TenantUser 无法访问该租户（接口返回 403）；
  * 所有 Flow 调度停止触发新的 Run。

停用租户时弹窗提示：

> “停用后，该租户下所有用户将无法登录工作区，所有定时任务将暂停执行。确认要停用吗？”

启用租户时提示：

> “启用后，该租户下用户可再次访问工作区，定时任务可重新生效。”

---

### 5.4 租户成员管理（TenantUser）（平台视角）

平台管理员可从租户详情页进入成员管理视图：

* 路径：`/admin/tenants/:tenantId/users`

#### 5.4.1 成员列表

显示字段：

| 列名       | 说明                       |
| -------- | ------------------------ |
| 登录名      | GlobalUser.login_name    |
| 显示名      | GlobalUser.display_name  |
| 邮箱       | GlobalUser.email         |
| 状态       | ACTIVE / DISABLED（租户内状态） |
| 是否 Owner | is_owner                 |
| 角色列表     | 该租户下绑定的角色名（逗号分隔）         |
| 创建时间     | created_at               |
| 更新时间     | updated_at               |

操作：

* 添加成员（从 GlobalUser 搜索添加）；
* 修改成员状态（ACTIVE / DISABLED）；
* 设置/取消 Owner；
* 移除成员（删除 TenantUser 记录）。

约束：

* `(tenant_id, user_id)` 唯一；
* 至少有一个 Owner：

  * 若某操作会导致租户不再有 Owner，应阻止并提示。

#### 5.4.2 添加成员流程

* 点击“添加成员”；
* 在弹窗中：

  * 搜索 GlobalUser（按登录名 / 邮箱 / 显示名）；
  * 勾选一个或多个用户；
  * 可选择是否设为 Owner；
  * 可选择初始角色（可选）。
* 点击“确认”后批量创建 TenantUser。

> 本期不在平台后台提供“注册新用户”的流程，仅能从已有 GlobalUser 中添加成员。

---

### 5.5 平台级审计日志（后续版本）

本期可以只在后端记录，不提供 UI 页面。方向如下：

* 记录的操作包括：

  * GlobalUser 创建 / 编辑 / 启用 / 禁用；
  * Tenant 创建 / 编辑 / 启用 / 停用；
  * 租户成员添加 / 移除 / Owner 变更；
* 日志字段：

  * 操作人（GlobalUser）；
  * 操作时间；
  * 操作类型；
  * 操作对象（Tenant / GlobalUser / TenantUser 等）；
  * 变更摘要；
  * 操作结果（成功/失败及原因）。

后续可在 `/admin/audit` 提供查询界面。

---

## 6. 租户通用体验（Tenant Workspace Shell）

本章定义租户工作区的“外壳”体验，包括租户切换、导航结构、空状态和任务通知等。本期**不做全局搜索**，**不做系统级通知**，**不提供语言切换**。

---

### 6.1 租户选择与切换

#### 6.1.1 首次进入逻辑

用户登录后：

* 若仅属于一个租户：

  * 直接进入该租户工作区（例如 Modeling 模块的默认页）；
* 若属于多个租户：

  * 可在首次登录时弹出租户选择页，或在顶部提供明显的租户下拉供选择；
  * 选择后进入对应租户工作区。

系统需记住**最近一次进入的租户**，下次登录时可直接跳转到该租户。

#### 6.1.2 顶部租户切换控件

* 顶部导航左侧区域显示当前租户名称；
* 点击后下拉展示：

  * 当前用户可访问的所有租户（状态为 ACTIVE）；
  * 支持按租户名称搜索。
* 切换后：

  * URL 中的 `tenantId` 更新；
  * 跳转到该租户的工作区首页（例如 Modeling 列表页或统一欢迎页）。

#### 6.1.3 访问被停用租户时

* 当用户尝试进入 `SUSPENDED` 状态的租户：

  * 后端返回 403；
  * 前端展示“租户已停用”提示页，例如：

    > “该租户已被停用，如需恢复访问，请联系平台管理员或本租户的 Owner。”
  * 不展示具体业务菜单。

---

### 6.2 导航布局（模块框架）

#### 6.2.1 顶部导航

顶部导航包含：

* 左侧：

  * 当前租户名称（下拉切换入口）；
* 中间（可选）：

  * 产品 Logo / 名称；
* 右侧：

  * 通知图标（任务流相关通知）；
  * 用户菜单：

    * 显示当前 GlobalUser.display_name；
    * 包含“退出登录”等操作（个人信息页可后续设计）。

#### 6.2.2 侧边导航

租户工作区侧边菜单包含：

* 建模（Modeling）
* 任务流（Flows）
* 数据集 & 看板（Boards）
* 设置（Settings）

要求：

* 当前模块高亮；
* 支持折叠展开；
* 模块入口的展示与否可以根据用户是否拥有该模块下**任一资源的 VIEW 权限**来决定：

  * 若完全无权限，前端可以隐藏入口，或保留入口但点击后显示“暂无可访问资源 / 无权限”页。

---

### 6.3 首次使用 / 无数据状态（Empty States）

各模块在完全无数据时，需要给出清晰引导。

#### 6.3.1 建模模块（无表时）

* 显示说明文本，例如：

  > “还没有任何数据表，您可以创建第一张表来开始建模。”
* 若当前用户具备任一目录下 `TABLE_SCHEMA` 的创建权限：

  * 显示“新建表”主按钮；
* 可选：提供“查看建模指南”或“示例文档”的链接。

#### 6.3.2 任务流模块（无 Flow 时）

* 显示说明文本，例如：

  > “暂时还没有任务流。您可以创建一个任务流，从外部数据源抽取数据并写入表中。”
* 若用户有 Flow 创建权限：

  * 显示“新建任务流”按钮；
* 可在空状态中用 1–2 行文字说明典型使用方式（如：“从外部 MySQL 抽数据 → 清洗 → 写入订单表”）。

#### 6.3.3 看板模块（无 Board 时）

* 显示说明文本，例如：

  > “还没有任何看板。您可以创建一个看板，将关键指标和图表集中展示。”
* 若用户具有 Board 创建权限：

  * 显示“新建看板”按钮；
* 提示：

  > “建议先为常用业务表创建数据集（Dataset），再基于数据集添加图表和指标卡。”

#### 6.3.4 Settings 模块（无成员 / 无角色时）

* 用户管理页只有当前用户一人时：

  * 文案示例：

    > “当前租户只有您一位成员。您可以添加其他同事加入，共享数据模型和报表。”
  * 按钮：“添加成员”（前提是用户有 Settings 管理权限）。

* 角色管理页无自定义角色时：

  * 文案示例：

    > “尚未创建任何自定义角色。建议根据团队职责创建角色并配置权限，避免所有人使用同一角色。”

---

### 6.4 全局搜索（本期不做）

* 本期不提供跨模块的全局搜索功能；
* 各模块通过自己的列表页搜索/筛选满足需求（例如：

  * 表列表的名称搜索；
  * Flow 列表名称/状态筛选；
  * Board 列表名称搜索等）。

如未来需要全局搜索，会在后续版本单独设计。

---

### 6.5 全局通知（仅任务流相关）

本期通知仅用于提醒**任务流运行结果**，不做系统级通知。

#### 6.5.1 通知类型范围

* 手动触发的 Flow Run 完成（成功/失败）；
* 调度触发的 Flow Run 失败。

成功调度运行一般不必通知，避免打扰。

#### 6.5.2 通知入口与交互

* 顶部右侧使用“铃铛”图标作为通知入口；

  * 当存在未读通知时显示红点或数量。
* 点击图标展开最近 N 条通知：

  * 每条通知至少包含：

    * 任务流名称；
    * 运行状态（成功/失败）；
    * 完成时间；
    * 触发方式（手动/调度）。
  * 点击通知后跳转到对应的 Flow Run 详情页（只读）。

通知状态：

* 新产生的通知标记为“未读”；
* 用户点击查看详情后自动标记为“已读”；
* 可提供“全部标记为已读”按钮（可选）。

---

### 6.6 国际化 & 语言切换（本期不做）

* 本期界面语言统一使用中文（简体）；
* 不提供语言切换入口；
* 实现时建议仍将文案抽离为配置文件，便于未来增加英文等多语言版本；
* 时间/日期/数字格式本期可以采用统一格式（如 `YYYY-MM-DD HH:mm:ss`）。

---

## 7. 租户设置模块（Tenant Settings & 权限管理）

Settings 模块是租户内部的管理中心，目标：

* 管理租户成员与角色；
* 配置资源级权限（表/任务流/看板）；
* 配置数据级权限（行/列权限）；
* 为后续权限变更审计打基础。

本期假设：只有具有特定 Settings 管理权限的角色（通常包含租户 Owner）可以访问本模块。

---

### 7.1 租户用户管理（Settings → Users）

#### 7.1.1 用户列表页

* 路径：`/app/:tenantId/settings/users`
* 粒度：每行一个 TenantUser。

显示字段：

| 列名       | 说明                         |
| -------- | -------------------------- |
| 登录名      | GlobalUser.login_name      |
| 显示名      | GlobalUser.display_name    |
| 邮箱       | GlobalUser.email           |
| 状态       | ACTIVE / DISABLED（仅指本租户状态） |
| 是否 Owner | is_owner                   |
| 角色列表     | 当前租户内绑定的角色名列表（逗号分隔）        |
| 最近登录时间   | last_login                 |
| 创建时间     | created_at                 |

操作：

* 添加成员（从已有 GlobalUser 中选择）；
* 编辑成员角色；
* 启用 / 禁用成员（仅影响本租户）；
* 设置 / 取消 Owner。

权限：

* 仅具有 Settings 管理权限的角色可访问此页并执行操作。

#### 7.1.2 添加成员（本期仅支持“从已有用户中添加”）

本期不支持“邀请新用户注册”，即：

* 不发送邀请邮件；
* 不提供自助注册流程。

添加成员流程：

1. 点击“添加成员”；
2. 弹出对话框：

   * 搜索已有 GlobalUser（按登录名 / 邮箱 / 显示名）；
   * 选择一个或多个用户；
   * 可勾选“设为 Owner”；
   * 可为其分配初始角色（多选）。
3. 点击保存后：

   * 为每个选中用户创建 TenantUser 记录，状态默认为 ACTIVE。

约束：

* `(tenant_id, user_id)` 唯一；
* 若操作会导致该租户不再有任何 Owner，应禁止并提示。

#### 7.1.3 编辑成员角色与状态

* 编辑角色：

  * 在列表中点击“编辑角色”，弹出角色多选；
  * 选中后保存，覆盖该成员在本租户的角色列表。
* 启用/禁用成员：

  * 切换 TenantUser.status；
  * 禁用后，该成员无法访问该租户工作区，但不影响其在其他租户的访问。

---

### 7.2 角色管理（Settings → Roles）

#### 7.2.1 角色列表页

* 路径：`/app/:tenantId/settings/roles`

显示字段：

| 列名      | 说明                           |
| ------- | ---------------------------- |
| 角色名称    | name                         |
| 描述      | description                  |
| 是否系统初始化 | is_system（系统初始化角色的标识，仅作来源说明） |
| 成员数     | 当前绑定该角色的用户数量                 |
| 创建时间    | created_at                   |
| 更新时间    | updated_at                   |

操作：

* 新建角色；
* 编辑角色名称/描述；
* 删除角色（如有成员绑定，可选择提示或阻止，视设计而定）。

#### 7.2.2 系统初始化角色（模板角色）

系统可预置若干角色作为模板（如“Owner 模板”“分析师模板”等），在数据上体现为：

* `is_system = true`。

本期约定：

* **系统初始化角色不施加特殊约束**：

  * 可以像普通角色一样修改名称、描述；
  * 可以自由调整资源权限、行权限、列权限；
  * 可以删除（若有需要）。
* `is_system` 仅表示“角色来源”，方便统计和后续版本可能做引导，不作为强约束逻辑。

---

### 7.3 资源树权限配置（RolePermission）

此处配置的是：**角色**在**表 / 任务流 / 看板**上的 VIEW / EDIT / MANAGE 权限。

#### 7.3.1 页面结构

* 顶部：角色选择（下拉框）；
* 主体：

  * Tab 切换不同资源类型：

    * 表权限（Tables）
    * 任务流权限（Flows）
    * 看板权限（Boards）
  * 每个 Tab 内部采用 ResourceTree + 权限编辑区。

#### 7.3.2 表权限配置

在“表权限” Tab 内：

* 左侧展示 scope=TABLE 的 ResourceTree（Folder + 表）；
* 选中某一表节点时，右侧显示：

| 权限项   | 可选值                         |
| ----- | --------------------------- |
| 表结构权限 | NONE / VIEW / EDIT / MANAGE |
| 表数据权限 | NONE / VIEW / EDIT / MANAGE |

在 Folder 节点上：

* 可配置“默认表结构权限 / 默认表数据权限”；
* 未在表节点显式配置权限的表，使用最近祖先 Folder 的默认值。

用户操作：

* 可以在 Folder 上快速设置默认权限；
* 需要对个别表做差异化配置时，可以在表节点上单独设置。

#### 7.3.3 任务流权限配置

在“任务流权限” Tab 内：

* 展示 scope=FLOW 的 ResourceTree（Folder + Flow）；
* 对每个 Flow 节点配置：

| 权限项     | 可选值                         |
| ------- | --------------------------- |
| Flow 权限 | NONE / VIEW / EDIT / MANAGE |

Folder 节点支持“默认 Flow 权限”。

#### 7.3.4 看板权限配置

在“看板权限” Tab 内：

* 展示 scope=BOARD 的 ResourceTree（Folder + Board）；
* 对每个 Board 节点配置：

| 权限项      | 可选值                         |
| -------- | --------------------------- |
| Board 权限 | NONE / VIEW / EDIT / MANAGE |

Folder 节点支持“默认 Board 权限”。

#### 7.3.5 保存与错误反馈

* 所有更改（无论是 Folder 还是具体资源）通过一个“保存”按钮统一提交；
* 后端若校验失败（参数错误、数据不一致等），需要返回明确错误消息；
* 前端需在界面上明显提示保存失败的原因，避免“点了没反应”的体验。

---

### 7.4 行/列权限配置（数据级权限）

数据级权限以“表”为维度进行配置，入口可以有：

* Modeling → 某表详情 → “数据权限” Tab；
* 或 Settings → 表列表 → 对应表的“数据权限配置”按钮（跳转同一页面）。

#### 7.4.1 列权限配置（ColumnPermission）

页面结构：

* 顶部：角色选择下拉框；
* 中部：字段列表表格。

字段表格列：

| 列名   | 说明                               |
| ---- | -------------------------------- |
| 字段名称 | Field.display_name               |
| 字段编码 | Field.code                       |
| 类型   | Field.type                       |
| 列权限  | 下拉：HIDDEN / READONLY / READWRITE |

行为：

* 修改列权限后，点击“保存”，覆盖该角色在该表上的列权限配置；
* 未显式配置的字段，使用系统默认策略（建议默认 READWRITE，只受资源级 TABLE_DATA 约束）。

可选约束（按需要实现）：

* 对于某些系统字段（如主键 id），可限制最低为 READONLY 不允许 HIDDEN；
  若不需要严格限制，亦可全部交给租户自定义。

#### 7.4.2 行权限配置（RowPermission）

页面结构：

* 顶部：角色选择下拉框；
* 中部：规则列表，每条记录代表一条 RowPermission；
* 每一条包含：

  * 规则名称（可空）；
  * 条件编辑器（可视化 FilterDSL）；
  * 删除按钮。

行为：

* 新建规则：

  * 用户通过选择字段、操作符、输入值的方式配置条件；
  * 保存时将条件序列化为 FilterDSL JSON 保存到 RowPermission。
* 编辑规则：

  * 打开已有规则的条件编辑器进行修改；
* 删除规则：

  * 删除对应 RowPermission 记录。

生效逻辑严格遵从第 4 章：

* 角色内多条规则 → OR；
* 多角色 → 再 OR；
* 与业务过滤 / Dataset 过滤 → AND。

#### 7.4.3 生效时机与风险提示

* 行/列权限修改提交成功后即刻生效：

  * 后续请求立即使用新配置；
  * 已打开页面在刷新或重新查询时才体现新权限。
* 对潜在影响较大的变更（如大量字段设置为 HIDDEN），可以在保存前提示：

  > “该操作可能导致部分用户无法看到字段 X / Y / Z，确认保存吗？”

---

### 7.5 权限变更审计（基础）

本期至少保证权限变更相关操作在后端有可追溯记录。

#### 7.5.1 审计范围

需要记录的操作包括但不限于：

* 角色管理：

  * 创建角色；
  * 编辑角色名称 / 描述；
  * 删除角色。
* 成员角色关系：

  * 为用户添加 / 移除角色；
  * 设置 / 取消 Owner。
* 资源权限：

  * 修改角色在表 / Flow / Board 上的资源级权限。
* 行权限：

  * 新增 / 修改 / 删除 RowPermission 规则。
* 列权限：

  * 修改 ColumnPermission（例如字段权限从 READWRITE → HIDDEN）。

#### 7.5.2 审计记录内容（最低要求）

每条记录至少包括：

* 操作人（TenantUser + 对应 GlobalUser 标识）；
* 操作时间；
* 操作类型（枚举）；
* 操作对象（角色 ID / 用户 ID / 表 ID / Flow ID / Board ID 等）；
* 变更摘要（如“字段 amount 列权限：READWRITE → HIDDEN”）；
* 操作结果（成功 / 失败及失败原因）。

前端是否提供完整的“权限变更记录”页面，可在第 12 章统一规划，本期可选择只做后端记录。

## 8. 建模模块（Modeling）

> 本章是整个系统最核心的功能之一，描述如何在租户内管理业务表、字段结构、表数据以及表间关系。
> 涉及的权限规则需与第 4 章（DSL & 权限模型）、第 7 章（Tenant Settings）保持一致。

---

### 8.1 模块目标 & 典型使用流程

#### 8.1.1 模块目标

建模模块为租户提供：

1. **结构化数据建模能力**

   * 定义业务表（Table）、字段（Field）、表间关系（Relation）。
2. **统一的数据管理入口**

   * 浏览、筛选、增删改查表中的数据记录。
3. **权限安全的数据操作**

   * 严格遵守资源级 / 行级 / 列级权限。
4. **可供下游复用的元数据中心**

   * 提供给任务流（Flows）、数据集 & 看板（Datasets & Boards）使用。

#### 8.1.2 主要角色

* **租户数据工程师 / 建模者**

  * 负责表结构设计、字段配置、关系定义。
* **业务分析师**

  * 可在权限允许下查看或录入数据，理解字段含义，为看板配置做准备。
* **普通业务用户**

  * 在有限权限范围内查看/维护部分业务数据。

#### 8.1.3 典型使用流程（示例）

**流程 A：从 0 到可以查询的一张业务表**

1. 进入建模模块 → 创建“订单表”；
2. 在“结构”中添加字段：订单号、下单时间、用户 ID、金额、状态等；
3. 保存后，在“数据”页手工录入几条订单数据；
4. 分析师在数据集模块中基于该表创建 Dataset，再配置看板。

**流程 B：建立主表-明细表关系**

1. 已有“订单表”“订单明细表”；
2. 在关系管理中，配置“订单.id 与 订单明细.order_id”的关系；
3. 在任务流 / 数据集配置 Join 时，系统推荐该关系作为默认 Join 条件。

---

### 8.2 模块入口 & 权限前置规则

#### 8.2.1 入口路径

* 前端路由示例：`/app/:tenantId/modeling`
* 进入建模模块时，需要：

  * 用户已登录；
  * 当前租户为 ACTIVE；
  * 当前用户在本租户下存在 TenantUser 记录。

#### 8.2.2 模块访问权限前置

* 若用户在本租户内：

  * 对**所有表**的 `TABLE_SCHEMA` 和 `TABLE_DATA` 权限均为 `NONE`：

    * 则进入建模模块时：

      * 可以显示“无权限访问任何表”的提示页；
      * 不显示资源树和列表。
* 若用户对至少一张表有 `TABLE_SCHEMA` 或 `TABLE_DATA` ≥ VIEW：

  * 允许进入建模模块；
  * 资源树和列表仅显示其有权限的表。

#### 8.2.3 异常情况处理

* 租户被 SUSPENDED：

  * 访问建模模块接口返回 403；
  * 按第 6 章约定展示“租户已停用”页。
* 用户被 DISABLED（TenantUser.status）：

  * 后端统一拦截，返回 403；
  * 前端不特意在模块内处理。

---

### 8.3 表资源树（Table ResourceTree）

#### 8.3.1 资源树结构

* 左侧区域展示 scope=TABLE 的资源树：

  * 节点类型：

    * **Folder**：逻辑目录，仅用于组织表；
    * **Table**：具体业务表。
* 根节点可以为“全部表”，下有多层 Folder / Table。

#### 8.3.2 资源树权限可见性

* 对于某张表 T：

  * 若用户对 T 的：

    * `TABLE_SCHEMA` = NONE **且** `TABLE_DATA` = NONE：

      * 该表**不在资源树中展示**；
  * 否则（任一 ≥ VIEW）：

    * 在资源树展示该表。
* 对于 Folder：

  * 若该 Folder 下递归无任何用户有权限的表：

    * 可以选择隐藏该 Folder，避免空目录；
  * 若 Folder 下存在用户有权限的表：

    * 展示该 Folder 即便用户不能编辑它（仅作为容器）。

#### 8.3.3 节点展示信息

* Folder 节点：

  * 图标 + 名称；
* 表节点：

  * 图标（区分维度表/事实表/配置表）；
  * 表显示名称 `display_name`；
  * 可选：小标签展示“维度/事实/配置”。

### 8.3.4 资源树操作与权限

对用户可见的节点，根据 **资源级权限 `TABLE_SCHEMA` / `TABLE_DATA`** 决定操作是否展示与可用。

#### 1）Folder 操作

**统一前置：**
用户在该 Folder 上必须拥有：
`resource_type = TABLE_SCHEMA` 且 `permission = MANAGE`。

在满足上述前提时，允许以下操作：

* **新建子文件夹**

  * 仅在当前 Folder 上 `TABLE_SCHEMA = MANAGE` 时显示入口；
  * 新建的子 Folder 继承父 Folder 的默认权限（后续可以在权限模块单独调整）；
  * 名称校验：

    * 非空；
    * 同一父目录下不允许重名。

* **重命名 Folder**

  * 仅在当前 Folder 上 `TABLE_SCHEMA = MANAGE` 时显示入口；
  * 修改 `display_name`，不影响其下子节点和权限配置。

* **删除 Folder**

  * 仅在当前 Folder 上 `TABLE_SCHEMA = MANAGE` 时显示入口；
  * 删除前校验：

    * 若该 Folder 下存在任意子 Folder 或表 → 禁止删除；
    * 提示：“请先移动或删除该目录下所有子目录和表后，再删除该目录。”
  * 确认删除后，删除该 Folder 节点本身。

* **拖拽移动 Folder**

  * 仅当**被拖拽的 Folder**上 `TABLE_SCHEMA = MANAGE`，且**目标父 Folder**上也 `TABLE_SCHEMA = MANAGE` 时允许：

    * 拖拽时后端校验两个条件都满足；
    * 禁止将 Folder 拖入自身或子孙节点（防止形成环形结构）。

#### 2）Table 节点操作

* **打开结构（Schema）**

  * 前提：在该表上 `TABLE_SCHEMA ≥ VIEW`；
  * 行为：进入表详情页的“结构”Tab。

* **打开数据**

  * 前提：在该表上 `TABLE_DATA ≥ VIEW`；
  * 行为：进入表详情页的“数据”Tab。

* **打开数据权限配置**

  * 前提：在该表上 `TABLE_DATA = MANAGE`；
  * 行为：进入表详情页“数据权限”Tab（行/列权限配置）。

* **拖拽移动表到其它 Folder**

  * 必须同时满足：

    1. 在该表上 `TABLE_SCHEMA = MANAGE`；
    2. 在目标 Folder 上 `TABLE_SCHEMA = MANAGE`；
  * 拖拽操作只改变表所属 Folder（资源树位置），不影响表数据与结构本身。

* **删除表**

  * 前提：在该表上 `TABLE_SCHEMA = MANAGE`；
  * 删除逻辑与 8.5.3 中“删除表”完全一致（包含依赖检查、失败提示）。

#### 8.3.5 懒加载与性能要求

* 对于表较多的租户：

  * 资源树建议支持懒加载或折叠加载；
  * 展开 Folder 时再加载其子节点；
  * 确保不会一次性加载所有表造成卡顿。

---

### 8.4 表列表 & 基本信息

#### 8.4.1 列表区域

* 位于右侧，跟随资源树的选中节点而变化：

  * 若选中根或某 Folder → 展示该目录下所有可见表（包含子文件夹中的表，可配置为仅当前层级或递归）。
* 粒度：一行一张表。

#### 8.4.2 默认列字段

| 列名   | 说明                                    |
| ---- | ------------------------------------- |
| 表名   | Table.display_name                    |
| 表编码  | Table.code（只读展示）                      |
| 表类型  | 维度 / 事实 / 配置 / 其他                     |
| 创建人  | created_by 对应 TenantUser.display_name |
| 创建时间 | created_at                            |
| 更新时间 | updated_at                            |
| 操作   | 结构 / 数据 / 数据权限 / 删除 （根据权限显示）          |

#### 8.4.3 筛选与搜索

* 搜索输入框：

  * 支持按表名 / 表编码模糊搜索；
* 筛选条件：

  * 表类型（维度/事实/配置/其他）；
  * 创建时间范围（可选）。

搜索结果仅限于用户有权限（任一 TABLE_SCHEMA / TABLE_DATA ≥ VIEW）的表。

#### 8.4.4 排序

* 默认按创建时间倒序；
* 用户可按：

  * 表名；
  * 更新时间；
  * 表类型；
    等字段排序。

排序操作行为应可逆，支持升/降序切换。

#### 8.4.5 空状态 & 异常

* 若当前目录无任何可见表：

  * 显示空状态引导（见 6.3.1）。
* 若筛选条件结果为空：

  * 显示“未找到符合条件的表”，并提供“清除筛选”按钮。

---

### 8.5 表生命周期（创建 / 编辑 / 删除）

#### 8.5.1 新建表

**入口：**

* 资源树根或 Folder 上的“新建表”按钮；
* 表列表区域的“新建表”主按钮（视情况显示）。

**权限前置：**

* 用户在目标 Folder 上需具备“创建表”的权限；

  * 产品可以采用：对该 Folder 默认 `TABLE_SCHEMA ≥ EDIT` 或独立配置。

**新建表表单字段：**

| 字段    | 必填 | 说明                               |
| ----- | -- | -------------------------------- |
| 表名    | 是  | 1–50 字符，业务可读名称，如“订单表”            |
| 表编码   | 否  | 只读字段，由系统自动生成；英文小写蛇形（snake_case），在同一租户内必须唯一，详见下文生成规则           |
| 表类型   | 是  | 维度 / 事实 / 配置 / 其他                |
| 描述    | 否  | 0–200 字符                         |
| 所属文件夹 | 否  | 选择资源树中某 Folder，默认当前选中的 Folder 或根 |

**表编码生成规则（固定约定）**
1. **只读，不允许用户编辑**

   * 在新建/编辑表表单中，“表编码”始终为只读展示；
   * 用户只能通过修改“表名”间接影响生成结果，**不能手工改 code**。

2. **字符组成与格式（静态约束）**

   * 只允许：`a–z`、`0–9`、下划线 `_`；
   * 全部小写；
   * 采用蛇形命名（snake_case），例如：`order`, `user_profile`, `order_item_detail`；
   * 首字符必须是字母：如果首字符不是字母，则自动加前缀 `t_`；
   * 最大长度：**50 个字符**，超出部分直接截断。

3. **唯一性范围**

   * 在**同一租户内**，`code` 必须唯一；
   * 唯一性判断针对“业务表元数据”，而不是物理库名（物理表名可采用包含 tenant_id 的前缀）。

4. **生成流程（产品视角）**

   * 当用户输入/修改“表名”并离开输入框（blur）时：

     1. 前端调用后端“生成表编码”接口，传入：

        * `display_name`（表名）
        * `tenant_id`
     2. 后端内部逻辑（对前端透明）：

        * 使用本地 LLM **生成一个候选英文标识**（如 `order`, `user_profile`）；
        * 对候选值进行规范化处理：

          * 转小写；
          * 非 `[a-z0-9_]` 统一替换为 `_`；
          * 若首字符不是字母，前加 `t_`；
          * 截断至 50 字符；
        * 若规范化后为空或只有 `_`：

          * 基于拼音重新生成一个候选，再走同样清洗流程；
        * 在当前租户范围内检测唯一性：

          * 若已存在同名 `code`，则在尾部依次尝试追加 `_1`、`_2`、`_3`……直到找到一个未被占用的编码；
     3. 后端返回最终 `code`，前端直接显示在“表编码”只读字段中。

5. **失败与降级行为**

   * 若 LLM 服务异常或生成流程中出现错误，但本地规则仍能生成合法编码：

     * 前端照常展示由本地规则生成的编码；
     * 用户无感知（可在后台记录日志）。
   * 若 LLM 和本地规则都失败（极端情况）：

     * 接口返回失败；
     * 前端提示：“表编码生成失败，请稍后重试”，并**禁止提交**该表单；
     * 用户需稍后重试或联系管理员。

6. **后续不可变更**

   * 一旦表创建成功：

     * `code` 在整个生命周期内禁止修改（包括通过任何 UI 或 API）；
     * 即使用户修改“表名”，`code` 也保持不变；
   * 该约定是为了保证任务流、数据集、看板等下游配置的稳定性。


**创建时自动系统字段：**

新建表时，系统默认自动添加以下内部字段（实际字段集合可在技术方案中最终确定，本 PRD描述期望）：

* `id`（主键，int/bigint 自增或 UUID）；
* `created_at`（datetime）；
* `updated_at`（datetime）；
* `created_by`（创建人 TenantUser id）；
* `updated_by`（最后修改人 TenantUser id）。

这些字段：

* `is_internal = true`；
* 不允许在前端删除或修改编码 / 类型。

**事务性要求：**

创建表需要同时：

1. 写入元数据表（Table 元信息）；
2. 在物理数据库中创建真实表结构（至少包含系统字段）。

任一步骤失败，需整体回滚，保证：

* 不出现“有元数据但无物理表”或“有物理表但无元数据”的情况；
* 前端提示失败原因（例如数据库错误）。

#### 8.5.2 编辑表信息

**入口：**

* 表列表中“结构”按钮 → 表详情 → 基本信息区；
* 资源树中右键菜单“编辑表信息”（可选）。

**可编辑字段：**

| 字段    | 说明          | 修改后影响               |
| ----- | ----------- | ------------------- |
| 表名    | 仅修改展示名称     | 不影响表编码、不影响下游引用      |
| 表类型   | 维度/事实/配置/其他 | 仅用于分类展示，不影响数据       |
| 描述    | 业务描述        | 仅元数据                |
| 所属文件夹 | 可修改         | 修改 ResourceTree 父节点 |

**不可编辑字段：**

* 表编码（code）；
* 创建人；
* 创建时间。

**并发编辑：**

* 若多用户同时编辑同一表的基本信息：

  * 采用“后保存覆盖前保存”的简单策略；
  * 可在前端提示“表信息已被他人更新，请刷新后再编辑”（可选，通过 updated_at 比对实现）。

#### 8.5.3 删除表

**入口：**

* 表列表中“删除”按钮；
* 资源树中对表节点的“删除表”。

**前置条件：**

* 用户对该表具备 `TABLE_SCHEMA = MANAGE` 权限；
* 租户状态为 ACTIVE。

**删除流程：**

点击“删除”后，弹窗展示：

* 表名、表编码；
* 删除影响说明：

  * “若该表被任务流、数据集、看板等使用，将无法删除”；（V1 不支持强制级联删除）

**后端依赖检查：**

在真正删除前，后端必须检查该表是否被引用：

1. 是否被任何 Flow 节点引用为数据源或写入目标；
2. 是否被任何 Dataset 绑定；
3. 是否被任何 Widget / Board 使用；
4. 是否在 Relation 中作为 left_table / right_table；
5. 是否存在行/列权限配置对该表记录（RowPermission/ColumnPermission）。

有任一引用存在：

* 删除失败；
* 返回结构化错误信息：

  * 包含至少引用类型（Flow/Dataset/Board/Relation/Permission）及数量；
* 前端在弹窗中展示简化的引用提示，例如：

  > “该表正被 2 个任务流、1 个数据集引用，请先在对应模块中删除相关引用后再删除本表。”

若无引用：

* 删除元数据记录；
* 删除物理表；
* 删除相关行/列权限配置等元数据（如有）。

**并发删除：**

* 若表已在其他会话中被删除：

  * 本次请求返回“资源不存在”错误；
  * 前端提示“该表已被删除，请刷新页面”。

---

### 8.6 字段管理（Schema 管理）

字段管理是表详情中的“结构”页，负责定义列结构。

#### 8.6.1 字段列表 UI

* Tab 名称：**结构**
* 粒度：每行一个字段。

显示列：

| 列名     | 说明                       |
| ------ | ------------------------ |
| 字段名称   | Field.display_name       |
| 字段编码   | Field.code（只读）           |
| 类型     | Field.type               |
| 主键标记   | is_primary_key（用图标或标签展示） |
| 必填     | is_required（NOT NULL）    |
| 默认值    | default_value            |
| 是否系统字段 | is_internal（用图标区分系统字段）   |
| 描述     | description              |
| 操作     | 编辑 / 删除（系统字段不显示删除按钮）     |

排序：

* 默认按 `created_at` 升序；
* 可支持拖拽调整展示顺序（逻辑顺序，不影响物理表字段顺序）。

权限：

* `TABLE_SCHEMA < VIEW`：禁止访问结构页（后端 403）；
* `TABLE_SCHEMA = VIEW`：只读，不展示“新增/编辑/删除”操作；
* `TABLE_SCHEMA ≥ EDIT`：允许字段增删改。

#### 8.6.2 新增字段

**入口：**

* 字段列表顶部“新增字段”按钮；
* 可能支持“批量新增”模式（可选，V1 可只做单条新增）。

**新增字段表单：**

| 字段   | 必填 | 说明                                             |
| ---- | -- | ---------------------------------------------- |
| 字段名称 | 是  | 1–50，字段展示名，如“订单金额”                             |
| 字段编码 | 否  | 只读，由系统生成（LLM + 本地规则），不可手动修改                    |
| 类型   | 是  | string/int/float/decimal/bool/date/datetime…子集 |
| 是否主键 | 否  | 默认 false，V1 仅支持单主键                             |
| 是否必填 | 否  | 映射 NOT NULL，默认 false                           |
| 默认值  | 否  | 根据类型输入，如数字/字符串/日期                              |
| 描述   | 否  | 0–200，用于说明字段含义                                 |

**字段编码生成逻辑：**

* 和表编码类似，填写“字段名称”后自动调用“生成字段编码”接口（参考第 11 章）；
* 编码需在同一表内唯一；
* 字段编码生成失败时，阻止提交并提示错误。

**校验规则：**

* 已有主键字段时：

  * 新增字段不能再次勾选“主键”，V1 固定只允许一个主键；
* 默认值校验：

  * 前端按类型做初步校验；
  * 后端做严格校验（如 int 字段的默认值必须为整数）。
* 字段个数限制（可选）：

  * 若需要，可以设定某个上限（如 200 列），达到上限后禁止新增。

**物理变更：**

* 新增字段提交后：

  * 更新元数据（Field 记录）；
  * 物理表执行 `ALTER TABLE ADD COLUMN`；
* 任何步失败需整体回滚。

#### 8.6.3 编辑字段

**可编辑项（普通字段，非系统字段）：**

* 字段名称（display_name）；
* 是否必填（is_required）；
* 默认值（default_value）；
* 描述（description）。

**不可编辑项：**

* 字段编码（code）；
* 字段类型（type）；
* 是否主键；
* 是否系统字段（is_internal）。

> V1 为简化实现，不支持字段类型变更及修改主键结构，若未来支持需专门设计迁移策略。

**校验说明：**

* 若将字段从“可空”改为“必填”：

  * 后端需要验证现有数据是否满足该约束：

    * 若存在 NULL 数据，可有两种策略（二选一写进 PRD）：

      1. 直接禁止修改并提示“存在 N 条记录该字段为空，不允许改为必填”；
      2. 自动为 NULL 记录填充默认值（需要提示该行为）。
  * 为避免隐藏数据变更，本期建议采用策略 1（禁止修改）。

**并发编辑：**

* 字段级别使用类似“最后保存覆盖”的策略；
* 可选增强：前端在打开字段编辑时读取 `updated_at`，保存前若后端发现不一致，返回冲突提示。

#### 8.6.4 删除字段

**入口：**

* 字段列表中每行的“删除”按钮（系统字段不展示）。

**前置条件：**

* `TABLE_SCHEMA ≥ EDIT`；
* 字段不是主键字段；
* 字段不是系统字段（is_internal=false）。

**依赖检查：**

后端在删除字段前必须检查：

1. 是否被任何 Relation 引用为 left_field / right_field；
2. 是否被任何 Flow 节点使用；
3. 是否被任何 Dataset 或 Widget（作为列或聚合字段）使用；
4. 是否出现在 RowPermission / ColumnPermission 规则中；
5. 是否被 FilterDSL（如 Dataset base_filter）引用。

若存在引用：

* 删除失败；
* 返回详细错误列表，例如：

  * 被 1 个 Relation 引用；
  * 被 2 个 Dataset 和 3 个 Widget 引用等；
* 前端弹窗展示简化提示，指导用户先去对应模块处理。

若无引用：

* 从元数据删除字段记录；
* 执行物理表 `ALTER TABLE DROP COLUMN`；
* 删除相关的 ColumnPermission 记录（如有）。

#### 8.6.5 系统字段规则

系统默认字段（如 `id / created_at / updated_at / created_by / updated_by`）：

* is_internal = true；
* 前端行为：

  * 在字段列表用专门图标标记；
  * 不允许删除；
  * 不允许修改类型、编码；
  * 是否允许修改显示名称 / 描述可以放宽，本期建议：

    * 允许修改显示名称/描述，以便本地化说明；
* 行为约定：

  * 新增/更新记录时自动填充；
  * 不提供用户自定义默认值配置。

---

### 8.7 表数据页（数据浏览 & CRUD）

“数据”页用于查看和编辑表中的记录，是业务用户日常接触最多的界面之一。

#### 8.7.1 入口与权限检查

入口：

* 表列表中点击“数据”按钮；
* 表详情内切换到“数据”Tab。

权限：

* `TABLE_DATA < VIEW`：

  * 后端返回 403；
  * 前端显示“无权限查看该表数据”提示页。
* `TABLE_DATA ≥ VIEW`：

  * 可以查看数据；
* `TABLE_DATA ≥ EDIT`：

  * 才能进行新增/编辑/删除操作。

行/列权限：

* 在任何数据操作前，必须先计算 ColumnPermission / RowPermission：
  → `final_columns`, `final_row_filter`（详见第 4 章）。

#### 8.7.2 列展示与列权限应用

* 表格列由“用户可见字段 + 系统字段（可选）”组成：

  * 可见字段 = 所有字段中 ColumnPermission ≠ HIDDEN 的字段；
  * 对于 READONLY / READWRITE 字段，在列表展示上表现一致，差异出现在编辑行为上。
* 可以允许用户临时隐藏部分列（对当前用户前端状态，不影响权限层面）。

系统字段的展示策略（建议）：

* 默认展示 `id / created_at / updated_at`；
* `created_by / updated_by` 可根据实际需要展示或通过 hover 查看。

#### 8.7.3 数据查询（列表、排序、分页）

**基本行为：**

* 默认展示当前表的若干记录：

  * 默认排序可按 `id` 或 `created_at` 倒序；
  * 默认 pageSize 例如 20/50。

**筛选方式：**

1. **简单筛选（Quick Filter）**：

   * UI 上提供常用字段的快速筛选：

     * 文本字段：输入关键词（contains）；
     * 数值字段：>= / <=；
     * 日期字段：起止日期区间；
   * 前端将这些条件转换为 FilterDSL，传给后端。

2. **高级筛选（Advanced Filter）**：

   * 打开条件构建器（与 RowPermission 配置类似）；
   * 允许组合 AND/OR、多字段条件；
   * 生成完整 FilterDSL。

**过滤逻辑：**

* 最终 WHERE 条件：

  * `RowPermission_filter AND 用户自定义过滤条件`；
* 用户无法绕过 RowPermission（后端确保）。

**分页：**

* 使用标准分页参数（page / pageSize）；
* 最大 pageSize 限制（例如 200），超过限制返回错误或自动限制；
* 提示“数据量较大时建议缩小筛选范围”。

**排序：**

* 用户可按可见字段排序；
* 不允许按 HIDDEN 字段排序；
* 若排序字段在 RowPermission 下仍存在 → 正常；
  否则报错（较少发生，通常无此场景）。

#### 8.7.4 新增记录（Create）

**入口：**

* 数据列表上方“新增记录”按钮；
* 仅当 `TABLE_DATA ≥ EDIT` 时显示。

**新增表单字段：**

* 显示对当前用户可见且可写（READWRITE）的字段；
* READONLY 字段只读展示（如自动计算字段、系统字段）；
* HIDDEN 字段不在表单中出现。

**校验逻辑：**

* 前端初步校验：

  * 必填字段（is_required）不可为空；
  * 类型格式校验（数字、日期、布尔等）。
* 后端严格校验：

  * 类型 / 长度 / 约束等；
  * 若失败返回具体错误说明（“字段 XXX 需要整数”“字段 YYY 格式错误”）。

**系统字段填充：**

* 新增时自动填充：

  * `id`（数据库生成）；
  * `created_at` / `updated_at`（当前时间）；
  * `created_by` / `updated_by`（当前 TenantUser.id）。

**成功后行为：**

* 提示“保存成功”；
* 关闭新增弹窗（若为弹窗形式）；
* 刷新数据列表，显示新记录（可滚动到新记录所在页）。

#### 8.7.5 编辑记录（Update）

**入口：**

* 每行“编辑”按钮；
* 对于 READONLY 字段，编辑表单中显示为只读；
* 对于 HIDDEN 字段，完全不展示。

权限前置：

* `TABLE_DATA ≥ EDIT` ；
* 若某字段最终列权限为 READONLY：

  * 前端禁止修改；
  * 若前端绕过，后端忽略该字段或报错（需统一策略，建议忽略并记录日志）。

**并发修改策略：**

* V1 简化为“后写覆盖”：

  * 不做乐观锁版本号检查；
  * 若某行在用户编辑期间被他人修改，后保存的版本会覆盖之前修改；
* 可选增强（后续版本）：

  * 利用 `updated_at` 做乐观锁，若时间戳不一致则提示冲突。

**删除后编辑：**

* 若在用户打开编辑表单后，该记录被他人删除：

  * 保存时后端返回“记录不存在”错误；
  * 前端提示“该记录已被删除，请刷新列表”。

#### 8.7.6 删除记录（Delete）

**入口：**

* 每行“删除”按钮；
* 可选支持“多选删除”，V1 可只做单行删除。

权限：

* `TABLE_DATA ≥ EDIT`。

行为：

* 点击“删除”后弹窗确认：

  * “确认删除这条记录？删除后不可恢复。”
* 后端删除逻辑：

  * V1 可采用物理删除；
  * 若采用软删除，需要在表结构中增加 `is_deleted` 等字段并调整所有查询逻辑（需在架构层统一设计，本 PRD不强行要求软删除）。

Relation 层面：

* Relation 仅用于描述表间关系，不负责强制外键约束：

  * 删除主表记录时，系统不会自动删除从表记录；
  * 可能产生“孤儿数据”（需要业务层/任务流进行清理）。
* 如需提醒：

  * 可在删除时检测本记录是否被其它表引用过（可能成本高），V1 可不做实时检查，仅在文档中说明该行为由业务自控。

#### 8.7.7 导入 / 导出（本期建议）

* **导出**：

  * V1 可不做专门导出功能（标记为后续）；
  * 若要做，需遵守行/列权限限制（导出的字段和行不得超越用户权限）。
* **导入**：

  * V1 可不支持数据导入；
  * 若未来支持，将类似于“文件 Source 节点” + “写入表”节点的组合，需要单独设计。

#### 8.7.8 错误反馈与用户体验

* FilterDSL 非法：

  * 后端返回 4xx 错误和具体信息；
  * 前端提示“筛选条件不合法，请检查后重试”，并可提供“重置筛选”选项。
* 权限不足：

  * 返回 403；
  * 前端统一提示“您没有权限执行该操作”。
* 数据校验失败：

  * 显示具体字段错误文本（尽可能针对字段逐一展示）。

---

### 8.8 关系管理（Relation）

Relation 用于在建模层显式描述两张表之间的关联关系，主要目的：

* 给数据集 / 看板 / 任务流的 Join 配置提供“默认 Join 条件”建议；
* 帮助分析师理解数据模型结构。

Relation **不强制实现数据库级外键约束**，也不自动清理引用数据。

#### 8.8.1 入口与列表

* 入口：表详情页中的“关系”Tab；
* 列表粒度：每行一个 Relation。

**展示列：**

| 列名   | 说明                               |
| ---- | -------------------------------- |
| 关系名称 | Relation.name（可为“订单-用户”）         |
| 本表角色 | 当前表在该关系中是“主表”还是“从表”              |
| 另一张表 | 另一张表的 display_name               |
| 本表字段 | 当前表参与关系的字段（display_name）         |
| 对应字段 | 另一张表参与关系的字段（display_name）        |
| 关系类型 | ONE_TO_MANY / MANY_TO_ONE（从本表视角） |
| 描述   | description                      |
| 操作   | 编辑（仅名称/描述） / 删除                  |

> 为降低认知负担，可以在 UI 上不直接显示 ONE_TO_MANY 等术语，而采用更自然表达：
>
> * “一个订单对应多个明细”
> * “多个订单指向同一个用户”
>   但在元数据中仍以 type 字段存储类型。

#### 8.8.2 新建关系

**入口：**

* 在当前表的“关系”Tab 中点击“新建关系”。

**表单字段：**

1. 关系名称（可选，默认为“表A.字段A → 表B.字段B”）
2. 当前表的角色：

   * “本表是左表”or“本表是右表”（内部可以不暴露这一概念，只需让用户选择“本表字段”和“另一张表字段”）。
3. 另一张表：

   * 从本租户所有可见表列表中选择。
4. 本表字段：

   * 从当前表字段列表中选择；
5. 对应字段：

   * 从另一张表字段列表中选择；
6. 关系类型：

   * 从下拉中选择：

     * “一条本表记录对应多条对方表记录”（ONE_TO_MANY）；
     * “多条本表记录对应一条对方表记录”（MANY_TO_ONE）；
   * 默认可根据字段语义自动推荐（可选）。
7. 描述（可选）。

**校验逻辑：**

* 表字段和对应字段的类型必须兼容（如 int 对 int，string 对 string）；
* 不允许本表与自身建立关系（自关联 V1 不支持）；
* 对于同一对表 + 字段组合，只允许存在一条相同方向的 Relation（防止重复）；
* 必须确保用户对两张表均有 `TABLE_SCHEMA ≥ VIEW` 权限。

#### 8.8.3 编辑关系

为简化：

* 允许编辑：

  * 关系名称；
  * 描述；
* 不允许修改：

  * 所关联的表；
  * 字段；
  * 关系类型。

如需要调整字段或关系类型，应删除后重新创建。

#### 8.8.4 删除关系

* 前提：用户在当前表上 `TABLE_SCHEMA ≥ EDIT`；
* 删除仅影响元数据，不删除任何实际数据；
* 删除后：

  * 下游数据集 / 任务流配置时，无法再获得该关系的默认 Join 提示；
  * 若已有 Dataset/Flow 手动配置了 Join 条件，不受影响（因为其保存的是字段对，而非 Relation id）。

#### 8.8.5 被引用表/字段删除的影响

* 删除表：

  * 删除前依赖检查会阻止删除任何被 Relation 引用的表；
* 删除字段：

  * 删除前依赖检查会阻止删除相关字段；
* 因此，在 V1 中不会出现“Relation 引用已不存在字段”的情况。
  （除非通过运维脚本绕过正常流程，此类情况视为异常，由运维负责修复）

#### 8.8.6 Relation 在下游的使用（产品视角约定）

* 数据集 / 任务流在配置 Join 时：

  * 系统可以根据当前选择的两张表，自动匹配已配置的 Relation，并提供“推荐 Join 条件”；
  * 用户可直接采用推荐条件或在此基础上做调整；
* Relation 信息本身可视为建模可视化（例如未来在“数据血缘”或“ER 图”中使用）。

---

### 8.9 建模操作审计

建模操作是系统中最关键的配置之一，需要具备一定审计能力。

#### 8.9.1 审计范围

需要记录的建模相关操作包括：

1. 表级操作：

   * 新建表；
   * 编辑表基本信息（表名/类型/描述/所属文件夹）；
   * 删除表（含删除失败的尝试）。
2. 字段级操作：

   * 新增字段；
   * 编辑字段（必填/默认值/描述等）；
   * 删除字段（含删除失败的尝试）。
3. 关系级操作：

   * 新建 Relation；
   * 编辑 Relation（名称/描述）；
   * 删除 Relation。
4. 数据级结构操作：

   * 若未来支持索引/约束配置，也应纳入审计。
5. 与权限交集：

   * 访问表结构失败（因权限不足）可选记为安全日志。

#### 8.9.2 审计记录内容

每条建模操作记录至少包括：

* 操作人（TenantUser + GlobalUser 显示名）；
* 操作时间；
* 操作类型（枚举，例如：CREATE_TABLE / UPDATE_FIELD / DELETE_RELATION）；
* 操作对象标识：

  * 表 ID / 表编码；
  * 字段 ID / 字段编码（若有）；
  * 关系 ID / 名称（若有）；
* 操作前后差异（对于编辑类操作）：

  * 建议记录变更字段及新旧值；
* 操作结果：

  * 成功 / 失败；
  * 失败时记录简要原因（如“被 Dataset 引用，无法删除字段 xxx”）。

#### 8.9.3 审计查询（与第 12 章联动）

* 本章仅规定审计**必须存在**；
* 审计日志的查询展示（前端页面）统一由第 12 章“日志、审计与可观测性”定义：

  * 如在租户 Settings 下提供“建模操作日志”列表；
  * 或在平台后台聚合查看。